<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resume Builder Pro</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --primary-color: #6366f1;
      --primary-hover: #4f46e5;
      --secondary-color: #10b981;
      --secondary-hover: #059669;
      --background: #0f172a;
      --surface: #1e293b;
      --surface-light: #334155;
      --text-primary: #f8fafc;
      --text-secondary: #cbd5e1;
      --text-muted: #64748b;
      --border: #334155;
      --border-light: #475569;
      --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      --radius: 12px;
      --radius-lg: 16px;
      --bg-primary: #0f172a;   /* or var(--background) */
      --bg-secondary: #1e293b; /* or var(--surface)    */
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--background);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      text-align: center;
      margin-bottom: 3rem;
      animation: fadeInDown 0.8s ease-out;
    }

    .header h1 {
      font-size: 3rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
    }

    .header p {
      color: var(--text-secondary);
      font-size: 1.1rem;
      font-weight: 400;
    }

    /* Main Content */
    .main-content {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 2rem;
      flex: 1;
    }

    /* Controls Panel */
    .controls-panel {
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 2rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      height: fit-content;
      animation: fadeInLeft 0.8s ease-out 0.2s both;
    }

    .controls-panel h2 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      color: var(--text-primary);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: var(--radius);
      font-family: inherit;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      width: 100%;
      justify-content: center;
      margin-bottom: 1rem;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .btn-secondary {
      background: var(--secondary-color);
      color: white;
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--secondary-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    /* Settings Section */
    .settings-section {
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border);
    }

    .settings-section h3 {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--text-primary);
    }

    .setting-group {
      margin-bottom: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .setting-group label {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 0.25rem;
    }

    .setting-slider {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: var(--surface-light);
      outline: none;
      -webkit-appearance: none;
      appearance: none;
      cursor: pointer;
    }

    .setting-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--primary-color);
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      transition: all 0.2s ease;
    }

    .setting-slider::-webkit-slider-thumb:hover {
      background: var(--primary-hover);
      transform: scale(1.1);
    }

    .setting-slider::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--primary-color);
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .setting-value {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--primary-color);
      text-align: center;
      background: rgba(99, 102, 241, 0.1);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      min-width: 50px;
      display: inline-block;
    }

    /* OCR Progress Styles */
    .progress-container {
      margin-top: 1rem;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--surface-light);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 0.5rem;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      width: 0%;
      transition: width 0.3s ease;
    }

    .progress-text {
      font-size: 0.85rem;
      color: var(--text-secondary);
      text-align: center;
    }

    /* JSON Input Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease-out;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 2rem;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border);
      animation: slideInUp 0.3s ease-out;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .modal-header h3 {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .close-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.5rem;
      border-radius: var(--radius);
      transition: all 0.2s ease;
    }

    .close-btn:hover {
      background: var(--surface-light);
      color: var(--text-primary);
    }

    .json-input {
      width: 100%;
      min-height: 300px;
      background: var(--background);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem;
      color: var(--text-primary);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
      line-height: 1.5;
      resize: vertical;
      transition: border-color 0.2s ease;
    }

    .json-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .modal-actions {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .modal-actions .btn {
      margin-bottom: 0;
      flex: 1;
    }

    /* Authentication Modal Styles */
    .auth-modal {
      max-width: 600px;
      width: 90%;
    }

    .auth-content {
      position: relative;
    }

    .auth-form {
      animation: fadeIn 0.3s ease-out;
    }

    .auth-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .auth-header h2 {
      font-size: 1.75rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }

    .auth-header p {
      color: var(--text-secondary);
      font-size: 0.95rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }

    .form-group input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--background);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.95rem;
      transition: all 0.2s ease;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .form-group input::placeholder {
      color: var(--text-muted);
    }

    /* Personal Info Form Styles */
    .settings-section .form-group {
      margin-bottom: 1rem;
    }

    .settings-section .form-group label {
      display: block;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }

    .settings-section .form-group input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--background);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.95rem;
      transition: all 0.2s ease;
    }

    .settings-section .form-group input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .settings-section .form-group input::placeholder {
      color: var(--text-muted);
    }

    /* Current Resume Upload Styles */
    .resume-upload-container {
      margin-top: 1rem;
    }

    .file-upload-area {
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      background: var(--background);
    }

    .file-upload-area:hover {
      border-color: var(--primary-color);
      background: rgba(99, 102, 241, 0.05);
    }

    .file-upload-area.dragover {
      border-color: var(--primary-color);
      background: rgba(99, 102, 241, 0.1);
    }

    .upload-content i {
      font-size: 2rem;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }

    .upload-content p {
      color: var(--text-secondary);
      font-weight: 500;
      margin: 0.5rem 0;
    }

    .upload-content small {
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .resume-preview-container {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem;
      background: var(--background);
    }

    .resume-preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .resume-filename {
      color: var(--text-primary);
      font-weight: 500;
      font-size: 0.9rem;
    }

    .resume-actions {
      display: flex;
      gap: 0.5rem;
    }

    .btn-small {
      padding: 0.25rem 0.5rem;
      font-size: 0.8rem;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-small:hover {
      background: var(--surface-light);
      color: var(--text-primary);
    }

    .btn-small.btn-danger {
      color: #ef4444;
      border-color: rgba(239, 68, 68, 0.3);
    }

    .btn-small.btn-danger:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: #ef4444;
    }

    .resume-preview-thumbnail {
      text-align: center;
      padding: 1rem;
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    .resume-preview-thumbnail i {
      font-size: 3rem;
      color: #ef4444;
    }

    .resume-preview-thumbnail img {
      max-width: 100%;
      max-height: 200px;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* Job Titles Section Styles */
    .section-description {
      color: var(--text-muted);
      font-size: 0.85rem;
      margin-bottom: 1rem;
      font-style: italic;
    }

    .job-titles-container {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .job-title-item {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem;
      transition: all 0.2s ease;
    }

    .job-title-item:hover {
      border-color: var(--primary-color);
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.1);
    }

    .job-title-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.5rem;
    }

    .job-title-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 1rem;
      margin: 0;
    }

    .job-company {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin: 0.25rem 0;
    }

    .job-dates {
      color: var(--text-muted);
      font-size: 0.85rem;
      font-style: italic;
    }

    .job-titles-loading {
      text-align: center;
      padding: 2rem;
    }

    .job-titles-loading p {
      color: var(--text-secondary);
      margin-top: 1rem;
    }

    .job-titles-empty {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
    }

      .job-titles-empty i {
        font-size: 2rem;
        margin-bottom: 1rem;
        opacity: 0.5;
      }
      
      .job-titles-empty p {
        margin: 0;
      }

      /* Education/Certificates Styles */
      .education-container {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 15px;
        background: var(--bg-secondary);
      }
      
      .education-item {
        background: var(--bg-primary);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .education-item:last-child {
        margin-bottom: 0;
      }
      
      .education-title {
        font-weight: 500;
        color: var(--text-primary);
        margin: 0;
        font-size: 0.9rem;
      }
      
      .education-loading {
        text-align: center;
        padding: 2rem;
      }
      
      .education-loading p {
        color: var(--text-secondary);
        margin-top: 1rem;
      }
      
      .education-empty {
        text-align: center;
        padding: 2rem;
        color: var(--text-muted);
      }
      
      .education-empty i {
        font-size: 2rem;
        margin-bottom: 1rem;
        opacity: 0.5;
      }
      
      .education-empty p {
        margin: 0;
      }

      /* Loading Bar Styles */
      .loading-bar {
        width: 100%;
        height: 20px;
        background-color: var(--bg-secondary);
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
        position: relative;
      }

      .loading-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #007bff, #0056b3);
        border-radius: 10px;
        width: 0%;
        transition: width 0.3s ease;
      }

      .loading-bar-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: var(--text-primary);
        font-size: 0.8rem;
        font-weight: 500;
      }

      /* Checkbox Styles */
      .checkbox-label {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-size: 0.9rem;
        color: var(--text-primary);
        margin-bottom: 0;
      }

      .checkbox-label input[type="checkbox"] {
        display: none;
      }

      .checkmark {
        width: 20px;
        height: 20px;
        background-color: var(--bg-primary);
        border: 2px solid var(--border);
        border-radius: 4px;
        margin-right: 10px;
        position: relative;
        transition: all 0.3s ease;
      }

      .checkbox-label input[type="checkbox"]:checked + .checkmark {
        background-color: #007bff;
        border-color: #007bff;
      }

      .checkbox-label input[type="checkbox"]:checked + .checkmark::after {
        content: '';
        position: absolute;
        left: 6px;
        top: 2px;
        width: 6px;
        height: 10px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
      }

    .auth-switch {
      text-align: center;
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border);
    }

    .auth-switch p {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .auth-switch a {
      color: var(--primary-color);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s ease;
    }

    .auth-switch a:hover {
      color: var(--primary-hover);
      text-decoration: underline;
    }

    .auth-loading {
      text-align: center;
      padding: 2rem;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--surface-light);
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .auth-loading p {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .auth-error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: var(--radius);
      padding: 1rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      animation: slideInDown 0.3s ease-out;
    }

    .auth-error i {
      color: #ef4444;
      font-size: 1.1rem;
    }

    .auth-error p {
      color: #ef4444;
      font-size: 0.9rem;
      margin: 0;
    }

    /* User Info in Header */
    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-left: auto;
    }

    .user-email {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .logout-btn {
      background: var(--surface-light);
      color: var(--text-secondary);
      border: 1px solid var(--border);
      padding: 0.5rem 1rem;
      border-radius: var(--radius);
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .logout-btn:hover {
      background: var(--surface);
      color: var(--text-primary);
      border-color: var(--border-light);
    }

    /* Hide main content when not authenticated */
    .main-content.hidden {
      display: none;
    }

    .header.hidden {
      display: none;
    }

    /* Resume Preview */
    .preview-container {
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 2rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      animation: fadeInRight 0.8s ease-out 0.4s both;
    }

    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .preview-header h2 {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .preview-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: var(--radius);
      font-size: 0.9rem;
      font-weight: 500;
    }

    .status-empty {
      background: rgba(100, 116, 139, 0.2);
      color: var(--text-muted);
    }

    .status-loaded {
      background: rgba(16, 185, 129, 0.2);
      color: var(--secondary-color);
    }

    .status-error {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .resume-preview {
      background: white;
      color: #1f2937;
      padding: var(--name-top-padding, 1rem) 3rem 3rem 3rem;
      border-radius: var(--radius);
      min-height: 800px;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
      font-size: 14px;
      line-height: 1.6;
      position: relative;
      overflow: hidden;
    }

    .resume-preview::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
    }
    
    /* Clean export: remove visual chrome during PDF render */
    .resume-preview.export-clean {
      box-shadow: none !important;
      border-radius: 0 !important;
    }
    .resume-preview.export-clean::before {
      display: none !important;
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 400px;
      color: var(--text-muted);
      text-align: center;
    }

    .empty-state i {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-secondary);
    }

    .empty-state p {
      font-size: 0.95rem;
      max-width: 300px;
    }

    /* Resume Styling */
    .resume-header {
      text-align: center;
      font-size: var(--name-size, 24px);
      font-weight: 700;
      margin-bottom: 4px;
      letter-spacing: 0.5px;
      color: #1f2937;
    }

    .resume-contact {
      text-align: center;
      font-size: var(--contact-size, 14px);
      font-weight: 500;
      margin-bottom: 12px;
      color: #4b5563;
    }

    .resume-divider {
      border: none;
      border-top: 2px solid #1f2937;
      margin: 8px 0 12px 0;
      width: 100%;
    }

    .section-title {
      font-size: 18px;
      font-weight: 700;
      text-align: center;
      text-decoration: underline;
      margin: 0 0 20px 0;
      letter-spacing: 0.2px;
      color: #1f2937;
    }
    
    .resume-preview .resume-divider + .section-title {
      margin-top: 0;
    }
    
    .resume-preview .section-title:first-of-type {
      margin-top: 0;
    }

    .job-title {
      font-weight: 700;
      font-size: var(--job-title-size, 16px);
      margin-top: 12px;
      margin-bottom: 4px;
      color: #1f2937;
    }

    .section {
      margin-bottom: 20px;
      padding-top: var(--job-padding-top, 10px);
    }
    
    .first-job-section {
      padding-top: 3px !important;
    }
    
    .last-job-section {
      padding-bottom: var(--job-padding-bottom, 10px);
    }
    


    .company-row {
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 4px;
    }

    .company {
      font-weight: 600;
      font-size: var(--company-size, 14px);
      color: #374151;
    }

    .company-details {
      font-size: var(--company-details-size, 12px);
      color: #6b7280;
    }

    .job-list {
      margin: 0 0 0 24px;
    }

    .job-list li {
      font-size: var(--bullet-size, 12px);
      margin-bottom: 8px;
      line-height: 1.6;
      color: #374151;
    }

    .cert-list {
      margin: 0 0 0 24px;
    }

    .cert-list li {
      font-size: 13px;
      margin-bottom: 6px;
      font-weight: 600;
      color: #374151;
    }

    /* Skills Section Styles */
    .skills-section {
      margin-bottom: 20px;
    }

    .skill-category {
      margin-bottom: 12px;
      display: flex;
      align-items: baseline;
      gap: 10px;
    }

    .skill-category-title {
      font-weight: 600;
      font-size: var(--bullet-size, 12px);
      color: #374151;
      flex-shrink: 0;
    }

    .skill-list {
      flex: 1;
      font-size: var(--bullet-size, 12px);
      color: #374151;
      line-height: 1.4;
    }

    .skill-item {
      display: inline;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .skill-item:hover {
      background-color: rgba(99, 102, 241, 0.1);
      border-radius: 4px;
      padding: 2px 4px;
      margin: 0 -4px;
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInLeft {
      from {
        opacity: 0;
        transform: translateX(-30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes fadeInRight {
      from {
        opacity: 0;
        transform: translateX(30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
      .main-content {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }
      
      .controls-panel {
        order: 2;
      }
      
      .preview-container {
        order: 1;
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .modal {
        padding: 1.5rem;
        width: 95%;
      }
      
      .resume-preview {
        padding: 2rem;
      }
    }

    @media print {
      body, .container, .resume-preview {
        box-shadow: none !important;
        background: white !important;
        color: black !important;
      }
      .controls-panel, .modal-overlay {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header" id="mainHeader">
      <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
        <div>
      <h1>Resume Builder Pro</h1>
      <p>Create professional resumes with ease</p>
        </div>
        <div class="user-info" id="userInfo" style="display: none;">
          <span class="user-email" id="userEmail"></span>
          <button class="logout-btn" id="logoutBtn">
            <i class="fas fa-sign-out-alt"></i>
            Logout
          </button>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Controls Panel -->
      <div class="controls-panel">
        <h2>Controls</h2>
        <button class="btn btn-primary" id="generateResumeBtn">
          <i class="fas fa-magic"></i>
          Enter Job Description
        </button>
        <button class="btn btn-primary" id="importJsonBtn">
          <i class="fas fa-upload"></i>
          Import JSON Data
        </button>
        <button class="btn btn-secondary" id="downloadPdfBtn" disabled>
          <i class="fas fa-file-pdf"></i>
          Download PDF
        </button>
        <button class="btn btn-secondary" id="downloadOcrPdfBtn" disabled>
          <i class="fas fa-search"></i>
          Download OCR PDF
        </button>
        <div class="loading-bar" id="ocrLoadingBar" style="display: none;">
          <div class="loading-bar-fill"></div>
          <span class="loading-bar-text">Processing OCR...</span>
        </div>
        <button class="btn btn-secondary" id="downloadJsonBtn" disabled>
          <i class="fas fa-download"></i>
          Download JSON
        </button>
        
        <!-- Settings Section -->
        <div class="settings-section">
          <h3>Display Options</h3>
          
          <div class="setting-group">
            <label class="checkbox-label">
              <input type="checkbox" id="showSkillsCheckbox" checked>
              <span class="checkmark"></span>
              Show Skills in Resume
            </label>
          </div>
        </div>
        
        <div class="settings-section">
          <h3>Font Sizes</h3>
          
          <div class="setting-group">
            <label for="nameSize">Name Font Size (px)</label>
            <input type="range" id="nameSize" min="18" max="36" value="24" class="setting-slider">
            <span class="setting-value" id="nameSizeValue">24px</span>
          </div>
          
          <div class="setting-group">
            <label for="contactSize">Contact Info Font Size (px)</label>
            <input type="range" id="contactSize" min="10" max="20" value="14" class="setting-slider">
            <span class="setting-value" id="contactSizeValue">14px</span>
          </div>
          
          <div class="setting-group">
            <label for="jobTitleSize">Job Title Font Size (px)</label>
            <input type="range" id="jobTitleSize" min="12" max="24" value="16" class="setting-slider">
            <span class="setting-value" id="jobTitleSizeValue">16px</span>
          </div>
          
          <div class="setting-group">
            <label for="companySize">Company Name Font Size (px)</label>
            <input type="range" id="companySize" min="10" max="20" value="14" class="setting-slider">
            <span class="setting-value" id="companySizeValue">14px</span>
          </div>
          
          <div class="setting-group">
            <label for="companyDetailsSize">Company Details Font Size (px)</label>
            <input type="range" id="companyDetailsSize" min="8" max="16" value="12" class="setting-slider">
            <span class="setting-value" id="companyDetailsSizeValue">12px</span>
          </div>
          
          <div class="setting-group">
            <label for="bulletSize">Bullet Points Font Size (px)</label>
            <input type="range" id="bulletSize" min="8" max="16" value="12" class="setting-slider">
            <span class="setting-value" id="bulletSizeValue">12px</span>
          </div>
        </div>
        
        <div class="settings-section">
          <h3>Spacing & Padding</h3>
          
          <div class="setting-group">
            <label for="nameTopPadding">Name Top Padding (px)</label>
            <input type="range" id="nameTopPadding" min="0" max="50" value="16" class="setting-slider">
            <span class="setting-value" id="nameTopPaddingValue">16px</span>
          </div>
          
          <div class="setting-group">
            <label for="jobPaddingTop">Job Entry Top Padding (px)</label>
            <input type="range" id="jobPaddingTop" min="0" max="30" value="10" class="setting-slider">
            <span class="setting-value" id="jobPaddingTopValue">10px</span>
          </div>
          
          <div class="setting-group">
            <label for="jobPaddingBottom">Last Job Bottom Padding (px)</label>
            <input type="range" id="jobPaddingBottom" min="0" max="30" value="10" class="setting-slider">
            <span class="setting-value" id="jobPaddingBottomValue">10px</span>
          </div>
        </div>
        
        <!-- OCR Progress Section -->
        <div class="settings-section" id="ocrProgressSection" style="display: none;">
          <h3>OCR Processing</h3>
          <div class="progress-container">
            <div class="progress-bar">
              <div class="progress-fill" id="ocrProgressFill"></div>
            </div>
            <div class="progress-text" id="ocrProgressText">Processing...</div>
          </div>
        </div>
        
        <!-- Personal Info Section -->
        <div class="settings-section">
          <h3>Personal Information</h3>
          
          <div class="form-group">
            <label for="personalName">Full Name</label>
            <input type="text" id="personalName" placeholder="Enter your full name">
          </div>
          
          <div class="form-group">
            <label for="personalAddress">Address</label>
            <input type="text" id="personalAddress" placeholder="Enter your address">
          </div>
          
          <div class="form-group">
            <label for="personalEmail">Email</label>
            <input type="email" id="personalEmail" placeholder="Enter your email">
          </div>
          
          <div class="form-group">
            <label for="personalPhone">Phone Number</label>
            <input type="tel" id="personalPhone" placeholder="Enter your phone number">
          </div>
          
          <div class="form-group">
            <button type="button" class="btn btn-primary" id="savePersonalInfoBtn">
              <i class="fas fa-save"></i>
              Save Personal Info
            </button>
          </div>
        </div>
        
        <!-- Current Resume Section -->
        <div class="settings-section">
          <h3>Current Resume</h3>
          
          <div class="resume-upload-container">
            <div class="file-upload-area" id="fileUploadArea">
              <input type="file" id="resumeFileInput" accept=".pdf,.doc,.docx" style="display: none;">
              <div class="upload-content" id="uploadContent">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>Click to upload your current resume</p>
                <small>Supports PDF, DOC, DOCX files</small>
              </div>
            </div>
            
            <div class="resume-preview-container" id="resumePreviewContainer" style="display: none;">
              <div class="resume-preview-header">
                <span class="resume-filename" id="resumeFilename"></span>
                <div class="resume-actions">
                  <button class="btn-small btn-secondary" id="viewResumeBtn">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button class="btn-small btn-danger" id="removeResumeBtn">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
              <div class="resume-preview-thumbnail" id="resumePreviewThumbnail">
                <i class="fas fa-file-pdf"></i>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Job Titles Section -->
        <div class="settings-section" id="jobTitlesSection" style="display: none;">
          <h3>Job Titles</h3>
          <p class="section-description">Extracted from your uploaded resume</p>
          
          <div class="job-titles-container" id="jobTitlesContainer">
            <!-- Job titles will be dynamically added here -->
          </div>
          
          <div class="job-titles-loading" id="jobTitlesLoading" style="display: none;">
            <div class="loading-spinner"></div>
            <p>Extracting job information from resume...</p>
          </div>
          
          <div class="job-titles-empty" id="jobTitlesEmpty" style="display: none;">
            <i class="fas fa-briefcase"></i>
            <p>No job information found in resume</p>
          </div>
        </div>
        
        <!-- Education/Certificates Section -->
        <div class="settings-section" id="educationSection" style="display: none;">
          <h3>Education/Certificates</h3>
          <p class="section-description">Extracted from your uploaded resume</p>
          
          <div class="education-container" id="educationContainer">
            <!-- Education and certificates will be dynamically added here -->
          </div>
          
          <div class="education-loading" id="educationLoading" style="display: none;">
            <div class="loading-spinner"></div>
            <p>Extracting education and certificates from resume...</p>
          </div>
          
          <div class="education-empty" id="educationEmpty" style="display: none;">
            <i class="fas fa-graduation-cap"></i>
            <p>No education or certificates found in resume</p>
          </div>
        </div>
      </div>

      <!-- Preview Container -->
      <div class="preview-container">
        <div class="preview-header">
          <h2>Resume Preview</h2>
          <div class="preview-status status-empty" id="previewStatus">
            <i class="fas fa-info-circle"></i>
            No data loaded
          </div>
        </div>
        
    <div id="resumePreview" class="resume-preview">
          <div class="empty-state">
            <i class="fas fa-file-alt"></i>
            <h3>Ready to build your resume?</h3>
            <p>Click "Import JSON Data" to get started with your resume information.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JSON Input Modal -->
  <div class="modal-overlay" id="jsonModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Import Resume Data</h3>
        <button class="close-btn" id="closeModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div>
        <label for="jsonInput" style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-weight: 500;">
          Paste your JSON data below:
        </label>
        <textarea 
          id="jsonInput" 
          class="json-input" 
          placeholder='{
  "contact": {
    "name": "Your Name",
    "email": "your.email@example.com",
    "phone": "(555) 123-4567",
    "address": "City, State"
  },
  "jobs": [
    {
      "title": "Job Title",
      "company": "Company Name",
      "location": "Location",
      "startDate": "Jan 2023",
      "endDate": "Present",
      "duties": ["Responsibility 1", "Responsibility 2"]
    }
  ],
  "skills": {
    "Languages & Frameworks": ["JavaScript", "Python", "React"],
    "Databases": ["MySQL", "PostgreSQL"],
    "Tools": ["Git", "Docker", "AWS"]
  },
  "certificates": [
    {"name": "Certificate Name"}
  ]
}'
        ></textarea>
      </div>
      
      <div class="modal-actions">
        <button class="btn btn-secondary" id="cancelImport">Cancel</button>
        <button class="btn btn-primary" id="confirmImport">Import Data</button>
      </div>
    </div>
  </div>

  <!-- Authentication Modal -->
  <div class="modal-overlay" id="authModal">
    <div class="modal auth-modal">
      <div class="modal-header">
        <h3 id="authModalTitle">Welcome to Resume Builder Pro</h3>
        <button class="close-btn" id="closeAuthModal" style="display: none;">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="auth-content">
        <!-- Sign Up Form -->
        <div class="auth-form" id="signUpForm">
          <div class="auth-header">
            <h2>Create Account</h2>
            <p>Sign up to start building your professional resume</p>
          </div>
          
          <form id="signUpFormElement">
            <div class="form-group">
              <label for="signUpEmail">Email Address</label>
              <input type="email" id="signUpEmail" required placeholder="Enter your email">
            </div>
            
            <div class="form-group">
              <label for="signUpPassword">Password</label>
              <input type="password" id="signUpPassword" required placeholder="Create a password" minlength="6">
            </div>
            
            <div class="form-group">
              <label for="signUpConfirmPassword">Confirm Password</label>
              <input type="password" id="signUpConfirmPassword" required placeholder="Confirm your password" minlength="6">
            </div>
            
            <button type="submit" class="btn btn-primary" id="signUpBtn">
              <i class="fas fa-user-plus"></i>
              Create Account
            </button>
          </form>
          
          <div class="auth-switch">
            <p>Already have an account? <a href="#" id="switchToLogin">Sign in here</a></p>
          </div>
        </div>
        
        <!-- Sign In Form -->
        <div class="auth-form" id="signInForm" style="display: none;">
          <div class="auth-header">
            <h2>Welcome Back</h2>
            <p>Sign in to continue building your resume</p>
          </div>
          
          <form id="signInFormElement">
            <div class="form-group">
              <label for="signInEmail">Email Address</label>
              <input type="email" id="signInEmail" required placeholder="Enter your email">
            </div>
            
            <div class="form-group">
              <label for="signInPassword">Password</label>
              <input type="password" id="signInPassword" required placeholder="Enter your password">
            </div>
            
            <button type="submit" class="btn btn-primary" id="signInBtn">
              <i class="fas fa-sign-in-alt"></i>
              Sign In
            </button>
          </form>
          
          <div class="auth-switch">
            <p>Don't have an account? <a href="#" id="switchToSignUp">Create one here</a></p>
          </div>
        </div>
        
        <!-- Loading State -->
        <div class="auth-loading" id="authLoading" style="display: none;">
          <div class="loading-spinner"></div>
          <p id="loadingText">Processing...</p>
        </div>
        
        <!-- Error Message -->
        <div class="auth-error" id="authError" style="display: none;">
          <i class="fas fa-exclamation-triangle"></i>
          <p id="errorMessage"></p>
        </div>
      </div>
    </div>
        </div>

        <!-- Job Description Modal -->
  <div class="modal-overlay" id="jobDescriptionModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Generate Resume from Job Description</h3>
        <button class="close-btn" id="closeJobDescriptionModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div>
        <label for="jobDescriptionInput" style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-weight: 500;">
          Paste the job description below and we'll generate a tailored resume:
        </label>
        <textarea 
          id="jobDescriptionInput" 
          class="json-input" 
          placeholder="Paste the complete job description here including:
- Job title and company
- Required skills and qualifications
- Job responsibilities
- Experience requirements
- Any specific technologies or tools mentioned

Example:
Senior Software Engineer at TechCorp
We are looking for a Senior Software Engineer with 5+ years of experience in full-stack development. The ideal candidate will have expertise in React, Node.js, Python, and cloud technologies. Responsibilities include leading development teams, architecting scalable solutions, and mentoring junior developers..."
          style="min-height: 200px;"
        ></textarea>
      </div>
      
      <div class="modal-actions">
        <button class="btn btn-secondary" id="cancelJobDescription">Cancel</button>
        <button class="btn btn-primary" id="generateResumeFromJob">
          <i class="fas fa-magic"></i>
          Generate Resume
        </button>
      </div>
      
      <!-- AI Generation Progress -->
      <div class="ai-progress" id="aiProgress" style="display: none;">
        <div class="progress-container">
          <div class="progress-bar">
            <div class="progress-fill" id="aiProgressFill"></div>
          </div>
          <div class="progress-text" id="aiProgressText">Generating your resume...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- OCR Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <!-- AI Configuration will be loaded dynamically from server -->
  
  
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
    
    import { getFirestore, doc, setDoc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCZJEsfHFPLVqKOyM9fhw7iEE-bxInzmTI",
      authDomain: "resumebuilder-7b339.firebaseapp.com",
      projectId: "resumebuilder-7b339",
      storageBucket: "resumebuilder-7b339.firebasestorage.app",
      messagingSenderId: "1007178809400",
      appId: "1:1007178809400:web:fd13f4bbb78b1a08dae6cd",
      measurementId: "G-4TBP7LZGHF"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const storage = getStorage(app);
    const db = getFirestore(app);
    
    // Make Firebase services available globally
    window.auth = auth;
    window.storage = storage;
    window.db = db;
    window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
    window.signInWithEmailAndPassword = signInWithEmailAndPassword;
    window.signOut = signOut;
    window.onAuthStateChanged = onAuthStateChanged;
    window.ref = ref;
    window.uploadBytes = uploadBytes;
    window.getDownloadURL = getDownloadURL;
    window.deleteObject = deleteObject;
    window.setDoc = setDoc;
    window.getDoc = getDoc;
    window.updateDoc = updateDoc;
    window.doc = doc;
  </script>

  <!-- Load AI Configuration from Server -->
  <script>
    // Global AI_CONFIG variable
    let AI_CONFIG = null;
    
    // Load AI configuration from server
    async function loadAIConfig() {
      try {
        const response = await fetch('/api/ai-config');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        AI_CONFIG = await response.json();
        console.log('AI Configuration loaded from server:', AI_CONFIG);
      } catch (error) {
        console.error('Failed to load AI configuration:', error);
        // Fallback configuration
        AI_CONFIG = {
          apiKey: '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',
          model: 'gpt-4',
          maxTokens: 2000,
          temperature: 0.7
        };
        console.log('Using fallback AI configuration');
      }
    }
    
    // Load AI config when page loads
    loadAIConfig();
  </script>

  <script>
    let resumeData = null;
    let pdfBlobUrl = null;
    let currentUser = null;

    // Authentication state
    let isAuthenticated = false;

    // Elements
    const importJsonBtn = document.getElementById('importJsonBtn');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');
    const downloadOcrPdfBtn = document.getElementById('downloadOcrPdfBtn');
    const downloadJsonBtn = document.getElementById('downloadJsonBtn');
    const ocrLoadingBar = document.getElementById('ocrLoadingBar');
    const showSkillsCheckbox = document.getElementById('showSkillsCheckbox');
    const preview = document.getElementById('resumePreview');
    const previewStatus = document.getElementById('previewStatus');
    const jsonModal = document.getElementById('jsonModal');
    const jsonInput = document.getElementById('jsonInput');
    const closeModal = document.getElementById('closeModal');
    const ocrProgressSection = document.getElementById('ocrProgressSection');
    const ocrProgressFill = document.getElementById('ocrProgressFill');
    const ocrProgressText = document.getElementById('ocrProgressText');
    const cancelImport = document.getElementById('cancelImport');
    const confirmImport = document.getElementById('confirmImport');

    // Authentication Elements
    const authModal = document.getElementById('authModal');
    const signUpForm = document.getElementById('signUpForm');
    const signInForm = document.getElementById('signInForm');
    const signUpFormElement = document.getElementById('signUpFormElement');
    const signInFormElement = document.getElementById('signInFormElement');
    const switchToLogin = document.getElementById('switchToLogin');
    const switchToSignUp = document.getElementById('switchToSignUp');
    const authLoading = document.getElementById('authLoading');
    const authError = document.getElementById('authError');
    const errorMessage = document.getElementById('errorMessage');
    const loadingText = document.getElementById('loadingText');
    const userInfo = document.getElementById('userInfo');
    const userEmail = document.getElementById('userEmail');
    const logoutBtn = document.getElementById('logoutBtn');
    const mainHeader = document.getElementById('mainHeader');
    const mainContent = document.querySelector('.main-content');

    // Personal Info Elements
    const personalName = document.getElementById('personalName');
    const personalAddress = document.getElementById('personalAddress');
    const personalEmail = document.getElementById('personalEmail');
    const personalPhone = document.getElementById('personalPhone');
    const savePersonalInfoBtn = document.getElementById('savePersonalInfoBtn');

    // Job Description Elements
    const generateResumeBtn = document.getElementById('generateResumeBtn');
    const jobDescriptionModal = document.getElementById('jobDescriptionModal');
    const jobDescriptionInput = document.getElementById('jobDescriptionInput');
    const closeJobDescriptionModal = document.getElementById('closeJobDescriptionModal');
    const cancelJobDescription = document.getElementById('cancelJobDescription');
    const generateResumeFromJob = document.getElementById('generateResumeFromJob');
    const aiProgress = document.getElementById('aiProgress');
    const aiProgressFill = document.getElementById('aiProgressFill');
    const aiProgressText = document.getElementById('aiProgressText');

    // Current Resume Elements
    const fileUploadArea = document.getElementById('fileUploadArea');
    const resumeFileInput = document.getElementById('resumeFileInput');
    const uploadContent = document.getElementById('uploadContent');
    const resumePreviewContainer = document.getElementById('resumePreviewContainer');
    const resumeFilename = document.getElementById('resumeFilename');
    const viewResumeBtn = document.getElementById('viewResumeBtn');
    const removeResumeBtn = document.getElementById('removeResumeBtn');
    const resumePreviewThumbnail = document.getElementById('resumePreviewThumbnail');

    // Job Titles Elements
    const jobTitlesSection = document.getElementById('jobTitlesSection');
    const jobTitlesContainer = document.getElementById('jobTitlesContainer');
    const jobTitlesLoading = document.getElementById('jobTitlesLoading');
    const jobTitlesEmpty = document.getElementById('jobTitlesEmpty');

    // Education Elements
    const educationSection = document.getElementById('educationSection');
    const educationContainer = document.getElementById('educationContainer');
    const educationLoading = document.getElementById('educationLoading');
    const educationEmpty = document.getElementById('educationEmpty');

    // Modal Controls
    importJsonBtn.addEventListener('click', () => {
      jsonModal.classList.add('active');
      jsonInput.focus();
    });

    closeModal.addEventListener('click', closeJsonModal);
    cancelImport.addEventListener('click', closeJsonModal);

    jsonModal.addEventListener('click', (e) => {
      if (e.target === jsonModal) {
        closeJsonModal();
      }
    });

    function closeJsonModal() {
      jsonModal.classList.remove('active');
      jsonInput.value = '';
    }

    // Skills checkbox listener
    showSkillsCheckbox.addEventListener('change', () => {
      renderResume();
    });

    // Import JSON Data
    confirmImport.addEventListener('click', () => {
      const jsonText = jsonInput.value.trim();
      if (!jsonText) {
        showPreviewError('Please enter JSON data');
        return;
      }

      try {
        resumeData = JSON.parse(jsonText);
        console.log('JSON imported successfully:', resumeData);
        console.log('Imported name:', resumeData?.contact?.name);
        
        // Update form fields with imported data
        if (resumeData.contact) {
          if (personalName) personalName.value = resumeData.contact.name || '';
          if (personalAddress) personalAddress.value = resumeData.contact.address || '';
          if (personalEmail) personalEmail.value = resumeData.contact.email || '';
          if (personalPhone) personalPhone.value = resumeData.contact.phone || '';
        }
        
          renderResume(resumeData);
        updatePreviewStatus('loaded', 'Data loaded successfully');
        downloadJsonBtn.disabled = false;
        generatePDFandStore();
        closeJsonModal();
      } catch (err) {
        showPreviewError('Invalid JSON format. Please check your data.');
        console.error('JSON Parse Error:', err);
      }
    });

    function showPreviewError(message) {
      updatePreviewStatus('error', message);
      preview.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-exclamation-triangle"></i>
          <h3>Error</h3>
          <p>${message}</p>
        </div>
      `;
      downloadJsonBtn.disabled = true;
      downloadPdfBtn.disabled = true;
      downloadOcrPdfBtn.disabled = true;
    }

    function updatePreviewStatus(type, message) {
      previewStatus.className = `preview-status status-${type}`;
      previewStatus.innerHTML = `
        <i class="fas fa-${type === 'loaded' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
        ${message}
      `;
    }

    // JSON Download
    downloadJsonBtn.addEventListener('click', () => {
      if (!resumeData) return;
      const blob = new Blob([JSON.stringify(resumeData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'resume-data.json';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 0);
    });

    // PDF Download
    downloadPdfBtn.addEventListener('click', () => {
      if (!pdfBlobUrl) return;
      const a = document.createElement('a');
      a.href = pdfBlobUrl;
      const personName = resumeData?.contact?.name || 'resume';
      const cleanName = personName.replace(/[^a-zA-Z0-9\s-]/g, '').replace(/\s+/g, '-');
      a.download = `${cleanName}-Resume.pdf`;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(pdfBlobUrl); // optional cleanup
        pdfBlobUrl = null;
      }, 0);
    });

    // OCR PDF Download
    downloadOcrPdfBtn.addEventListener('click', async () => {
      if (!pdfBlobUrl) return;
      
      try {
        downloadOcrPdfBtn.disabled = true;
        ocrProgressSection.style.display = 'block';
        ocrLoadingBar.style.display = 'block';
        
        // Reset loading bar
        const loadingBarFill = document.querySelector('.loading-bar-fill');
        const loadingBarText = document.querySelector('.loading-bar-text');
        if (loadingBarFill) {
          loadingBarFill.style.width = '0%';
          loadingBarFill.style.animation = 'none';
        }
        if (loadingBarText) {
          loadingBarText.textContent = 'Starting...';
        }
        
        // Fetch the PDF blob
        const response = await fetch(pdfBlobUrl);
        const pdfBlob = await response.blob();
        
        // Convert blob to array buffer
        const arrayBuffer = await pdfBlob.arrayBuffer();
        
        // Process with OCR
        const ocrPdfBlob = await processPdfWithOCR(arrayBuffer);
        
        // Download the OCR PDF with person's name
        const url = URL.createObjectURL(ocrPdfBlob);
        const a = document.createElement('a');
        a.href = url;
        const personName = resumeData?.contact?.name || 'resume';
        const cleanName = personName.replace(/[^a-zA-Z0-9\s-]/g, '').replace(/\s+/g, '-');
        a.download = `${cleanName}-Resume.pdf`;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 0);
        
      } catch (error) {
        console.error('OCR processing failed:', error);
        alert('OCR processing failed. Please try again.');
      } finally {
        downloadOcrPdfBtn.disabled = false;
        ocrProgressSection.style.display = 'none';
        ocrProgressFill.style.width = '0%';
        ocrLoadingBar.style.display = 'none';
      }
    });

    // Date parsing helper function
    function parseDate(dateString) {
      if (!dateString) return new Date(0);
      
      // Handle "Present" or current job
      if (dateString.toLowerCase() === 'present') {
        return new Date();
      }
      
      // Handle various date formats
      const months = {
        'jan': 0, 'january': 0, 'feb': 1, 'february': 1, 'mar': 2, 'march': 2,
        'apr': 3, 'april': 3, 'may': 4, 'jun': 5, 'june': 5, 'jul': 6, 'july': 6,
        'aug': 7, 'august': 7, 'sep': 8, 'september': 8, 'oct': 9, 'october': 9,
        'nov': 10, 'november': 10, 'dec': 11, 'december': 11
      };
      
      // Try to parse common formats
      const parts = dateString.toLowerCase().trim().split(/\s+/);
      
      if (parts.length >= 2) {
        const month = months[parts[0]];
        const year = parseInt(parts[1]);
        
        if (month !== undefined && !isNaN(year)) {
          return new Date(year, month, 1);
        }
      }
      
      // Try direct date parsing
      const parsed = new Date(dateString);
      if (!isNaN(parsed.getTime())) {
        return parsed;
      }
      
      // Fallback to current date if parsing fails
      console.warn(`Could not parse date: ${dateString}, using current date`);
      return new Date();
    }

    // Resume Renderer
    function renderResume(data) {
      // Sort jobs by start date (newest first)
      const sortedJobs = [...data.jobs].sort((a, b) => {
        const dateA = parseDate(a.startDate);
        const dateB = parseDate(b.startDate);
        return dateB - dateA; // Descending order (newest first)
      });

  // Get personal info values (use form values if they have content, otherwise use data)
  const name = (personalName && personalName.value.trim()) ? personalName.value : data.contact.name;
  const address = (personalAddress && personalAddress.value.trim()) ? personalAddress.value : data.contact.address;
  const email = (personalEmail && personalEmail.value.trim()) ? personalEmail.value : data.contact.email;
  const phone = (personalPhone && personalPhone.value.trim()) ? personalPhone.value : data.contact.phone;

  preview.innerHTML = `
        <div class="resume-header" data-editable="contact.name">${escapeHtml(name)}</div>
    <div class="resume-contact">
          <span data-editable="contact.address">${escapeHtml(address)}</span>
          - <a href="mailto:${escapeHtml(email)}" style="color:#4b5563;text-decoration:underline;" data-editable="contact.email">
          ${escapeHtml(email)}
        </a>
          - <span data-editable="contact.phone">${escapeHtml(phone)}</span>
    </div>
    <hr class="resume-divider">

        <div class="section-title">Work Experience</div>
        ${sortedJobs.map((job, jobIndex) => `
          <div class="section ${jobIndex === 0 ? 'first-job-section' : ''} ${jobIndex === sortedJobs.length - 1 ? 'last-job-section' : ''}">
            <div class="job-title" data-editable="jobs.${jobIndex}.title">${escapeHtml(job.title)}</div>
        <div class="company-row">
              <span class="company" data-editable="jobs.${jobIndex}.company">${escapeHtml(job.company)}</span>
          <span class="company-details">
                - <span data-editable="jobs.${jobIndex}.location">${escapeHtml(job.location)}</span> 
                (<span data-editable="jobs.${jobIndex}.startDate">${escapeHtml(job.startDate)}</span>${job.endDate ? ' - <span data-editable="jobs.' + jobIndex + '.endDate">' + escapeHtml(job.endDate) + '</span>' : ''})
          </span>
        </div>
        <ul class="job-list">
              ${job.duties.map((duty, dutyIndex) => `
                <li data-editable="jobs.${jobIndex}.duties.${dutyIndex}" class="editable-bullet">
                  ${escapeHtml(duty)}
                </li>
              `).join('')}
        </ul>
      </div>
    `).join('')}

    <hr class="resume-divider">

        ${data.skills && Object.keys(data.skills).length > 0 && showSkillsCheckbox.checked ? `
        <div class="section-title">Technical Skills</div>
        <div class="skills-section">
          ${Object.entries(data.skills).map(([category, skills]) => `
            <div class="skill-category">
              <div class="skill-category-title">${escapeHtml(category)}:</div>
              <div class="skill-list">
                ${skills.map((skill, skillIndex) => `
                  <span class="skill-item" data-editable="skills.${category}.${skillIndex}">${escapeHtml(skill)}</span>
                `).join(', ')}
              </div>
            </div>
          `).join('')}
        </div>
        <hr class="resume-divider">
        ` : ''}

        <div class="section-title">Education/Certificates</div>
    <ul class="cert-list">
          ${data.certificates.map((cert, certIndex) => `
            <li data-editable="certificates.${certIndex}.name" class="editable-bullet">
              ${escapeHtml(typeof cert === 'string' ? cert : cert.name || '')}
            </li>
          `).join('')}
    </ul>
  `;

      // Add click event listeners for editable elements
      addEditListeners();
    }

    // Add event listeners for editable elements
    function addEditListeners() {
      const editableElements = preview.querySelectorAll('[data-editable]');
      
      editableElements.forEach(element => {
        element.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          const fieldPath = this.getAttribute('data-editable');
          const currentValue = this.textContent.trim();
          
          // Create input field
          const input = document.createElement('input');
          input.type = 'text';
          input.value = currentValue;
          input.className = 'inline-edit-input';
          input.style.cssText = `
            width: 100%;
            padding: 4px 8px;
            border: 2px solid var(--primary-color);
            border-radius: 4px;
            font-family: inherit;
            font-size: inherit;
            background: white;
            color: #1f2937;
            outline: none;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.2);
          `;
          
          // Replace element content with input
          const originalContent = this.innerHTML;
          this.innerHTML = '';
          this.appendChild(input);
          input.focus();
          input.select();
          
          // Handle save on Enter or blur
          const saveEdit = () => {
            const newValue = input.value.trim();
            if (newValue !== currentValue) {
              updateResumeData(fieldPath, newValue);
              renderResume(resumeData);
            } else {
              this.innerHTML = originalContent;
            }
          };
          
          const cancelEdit = () => {
            this.innerHTML = originalContent;
          };
          
          input.addEventListener('blur', saveEdit);
          input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
              e.preventDefault();
              saveEdit();
            } else if (e.key === 'Escape') {
              e.preventDefault();
              cancelEdit();
            }
          });
        });
        
        // Add hover effect
        element.style.cursor = 'pointer';
        element.addEventListener('mouseenter', function() {
          this.style.backgroundColor = 'rgba(99, 102, 241, 0.1)';
          this.style.borderRadius = '4px';
          this.style.padding = '2px 4px';
          this.style.margin = '0 -4px';
        });
        
        element.addEventListener('mouseleave', function() {
          this.style.backgroundColor = '';
          this.style.borderRadius = '';
          this.style.padding = '';
          this.style.margin = '';
        });
      });
    }

    // Update resume data at specific path
    function updateResumeData(path, value) {
      const pathParts = path.split('.');
      let current = resumeData;
      
      // Navigate to the parent object
      for (let i = 0; i < pathParts.length - 1; i++) {
        current = current[pathParts[i]];
      }
      
      // Update the value
      current[pathParts[pathParts.length - 1]] = value;
      
      // Update Personal Info form fields if it's a contact field
      if (pathParts[0] === 'contact') {
        const field = pathParts[1];
        if (field === 'name' && personalName) personalName.value = value;
        else if (field === 'address' && personalAddress) personalAddress.value = value;
        else if (field === 'email' && personalEmail) personalEmail.value = value;
        else if (field === 'phone' && personalPhone) personalPhone.value = value;
      }
      
      // Re-generate PDF after update
      generatePDFandStore();
    }

    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      return String(text)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // Generate LaTeX-based PDF
    async function generatePDFandStore() {
      downloadPdfBtn.disabled = true;
      downloadOcrPdfBtn.disabled = true;

      if (pdfBlobUrl) {
        URL.revokeObjectURL(pdfBlobUrl);
        pdfBlobUrl = null;
      }
      if (!resumeData) {
        updatePreviewStatus('error', 'No resume data available');
        return;
      }

      try {
        const latexContent = generateLatexResume(resumeData);
        const blob = await compileLatexToPDF(latexContent);

        pdfBlobUrl = URL.createObjectURL(blob);
        updatePreviewStatus('loaded', 'PDF ready (LaTeX/Server)');
        downloadPdfBtn.disabled = false;
        downloadOcrPdfBtn.disabled = false;
      } catch (err) {
        console.error('Server compile failed:', err);
        updatePreviewStatus('error', 'Server failed to build PDF');
        alert('PDF build failed via server. Check console for details.');
      }
    }

    // Download LaTeX source as text file
    function downloadLatexSource(latexContent) {
      try {
        const blob = new Blob([latexContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'resume.tex';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        console.log('LaTeX source downloaded as resume.tex');
      } catch (error) {
        console.error('Error downloading LaTeX source:', error);
      }
    }


    // Generate LaTeX resume content
    function generateLatexResume(data) {
      const escapeLatex = (text) => {
        if (!text) return '';
        return String(text)
          .replace(/\\/g, '\\textbackslash{}')
          .replace(/\{/g, '\\{')
          .replace(/\}/g, '\\}')
          .replace(/\$/g, '\\$')
          .replace(/&/g, '\\&')
          .replace(/%/g, '\\%')
          .replace(/#/g, '\\#')
          .replace(/\^/g, '\\textasciicircum{}')
          .replace(/_/g, '\\_')
          .replace(/~/g, '\\textasciitilde{}');
      };

      const formatDate = (dateStr) => {
        if (!dateStr) return '';
        return dateStr;
      };

      const formatJobDuties = (duties) => {
        if (!duties || !Array.isArray(duties)) return '';
        return duties.map(duty => {
          // Add period at the end if not already present
          const cleanDuty = duty.trim();
          const hasPeriod = cleanDuty.endsWith('.');
          return `  \\item ${escapeLatex(cleanDuty)}${hasPeriod ? '' : '.'}`;
        }).join('\n');
      };

      const formatSkills = (skills) => {
        if (!skills) return '';
        const skillCategories = Object.keys(skills);
        return skillCategories.map(category => {
          const skillList = Array.isArray(skills[category]) ? skills[category].join(', ') : '';
          return `\\textbf{${escapeLatex(category)}:} ${escapeLatex(skillList)}`;
        }).join(' \\\\\n');
      };

      const formatEducation = (education) => {
        if (!education || !Array.isArray(education)) return '';
        return education.map(edu => {
          // Replace "from" with em dash for better formatting
          const formattedEdu = edu.replace(/\s+from\s+/g, '  ');
          return `  \\item ${escapeLatex(formattedEdu)}`;
        }).join('\n');
      };

      const formatCertificates = (certificates) => {
        if (!certificates || !Array.isArray(certificates)) return '';
        return certificates.map(cert => {
          const certName = typeof cert === 'string' ? cert : cert.name || '';
          return `  \\item ${escapeLatex(certName)}`;
        }).join('\n');
      };

      // Generate LaTeX document
      let latex = `\\documentclass[10.5pt,a4paper]{article}

% --- Basics ---
\\usepackage[utf8]{inputenc}
\\usepackage[T1]{fontenc}
\\usepackage[margin=1in,top=0.33in,bottom=0.33in]{geometry}
\\usepackage{helvet}
\\renewcommand{\\familydefault}{\\sfdefault}
\\usepackage{microtype}
\\usepackage{enumitem}
\\usepackage{xcolor}
\\usepackage[hidelinks]{hyperref}
\\usepackage{tabularx}
\\usepackage{array}

% --- Colors ---
\\definecolor{accent}{HTML}{0A66C2}
\\definecolor{lightgray}{gray}{0.6}
\\hypersetup{colorlinks=true, urlcolor=accent}

% --- Spacing / lists ---
\\setlength{\\parindent}{0pt}
\\linespread{1.08}
\\setlist[itemize]{leftmargin=1.5em,label=\\textbullet,itemsep=3pt,topsep=2pt}

% --- Unified section heading (used for ALL sections) ---
\\newcommand{\\sectiontitle}[1]{%
  \\vspace{10pt}% top breathing room
  {\\large\\bfseries\\textcolor{accent}{#1}}\\par
  \\vspace{2pt}\\textcolor{accent}{\\rule{\\textwidth}{0.6pt}}\\vspace{4pt}%
}

% --- Role block ---
\\newcommand{\\roleblock}[4]{% title, company, location, dates
  {\\textbf{#1}}\\par
  {\\itshape #2 -- #3\\ (#4)}\\par\\vspace{4pt}
}

% --- Header ---
\\pagenumbering{gobble}
\\begin{document}
\\begin{center}
{\\Huge \\bfseries ${escapeLatex(data.contact?.name || 'Your Name')}}\\par
\\vspace{4pt}
\\href{mailto:${escapeLatex(data.contact?.email || 'email@example.com')}}{${escapeLatex(data.contact?.email || 'email@example.com')}} \\,\\,|\\,\\, ${escapeLatex(data.contact?.phone || 'Phone')} \\,\\,|\\,\\, ${escapeLatex(data.contact?.address || 'Location')}
\\end{center}
\\vspace{4pt}`;

      // Professional Summary
      if (data.summary) {
        latex += `\n\n% =========================\n% PROFESSIONAL SUMMARY\n% =========================\n\\sectiontitle{Professional Summary}\n\\vspace{4pt}\n${escapeLatex(data.summary)}\n`;
      }

      // Work Experience
      if (data.jobs && data.jobs.length > 0) {
        latex += `\n\n\\vspace{10pt} % <-- add space here\n% =========================\n% WORK EXPERIENCE\n% =========================\n\\sectiontitle{Work Experience}\n`;
        
        data.jobs.forEach(job => {
          const location = job.location || 'Location';
          const dates = `${formatDate(job.startDate)} -- ${formatDate(job.endDate)}`;
          
          latex += `\n\\roleblock{${escapeLatex(job.title)}}\n          {${escapeLatex(job.company)}}{${escapeLatex(location)}}{${escapeLatex(dates)}}\n`;
          
          if (job.duties && job.duties.length > 0) {
            latex += `\\begin{itemize}\n${formatJobDuties(job.duties)}\n\\end{itemize}\n`;
          }
          
          latex += `\n\\vspace{8pt}\n`;
        });
      }

      // Skills
      if (data.skills && showSkillsCheckbox.checked) {
        latex += `\n\n\\vspace{10pt} % <-- add space here\n% =========================\n% SKILLS\n% =========================\n\\sectiontitle{Skills}\n`;
        
        const skillCategories = Object.keys(data.skills);
        if (skillCategories.length > 0) {
          latex += `\\begin{tabularx}{\\textwidth}{@{} >{\\raggedright\\arraybackslash}X >{\\raggedright\\arraybackslash}X @{}}\n`;
          
          // Process skills in pairs
          for (let i = 0; i < skillCategories.length; i += 2) {
            const leftCategory = skillCategories[i];
            const rightCategory = skillCategories[i + 1];
            
            const leftSkills = Array.isArray(data.skills[leftCategory]) ? data.skills[leftCategory].join(', ') : '';
            const rightSkills = rightCategory && Array.isArray(data.skills[rightCategory]) ? data.skills[rightCategory].join(', ') : '';
            
            latex += `\\textbf{${escapeLatex(leftCategory)}:} ${escapeLatex(leftSkills)}`;
            latex += `\n&\n`;
            latex += `\\textbf{${escapeLatex(rightCategory || '')}:} ${escapeLatex(rightSkills || '')}`;
            latex += ` \\\\[4pt]\n\n`;
            
            if (i === 0) {
              latex += `\\vspace{5pt}\n`;
            }
          }
          
          latex += `\\end{tabularx}\n`;
        }
      }

      // Education & Certificates (combined section)
      if ((data.education && data.education.length > 0) || (data.certificates && data.certificates.length > 0)) {
        latex += `\n\n\\vspace{10pt} % <-- add space here\n% =========================\n% EDUCATION & CERTIFICATIONS\n% =========================\n\\sectiontitle{Education \\& Certifications}\n\\begin{itemize}\n`;
        
        // Add education items
        if (data.education && data.education.length > 0) {
          latex += formatEducation(data.education);
        }
        
        // Add certificate items
        if (data.certificates && data.certificates.length > 0) {
          latex += formatCertificates(data.certificates);
        }
        
        latex += `\\end{itemize}\n`;
      }

      latex += `\n\\end{document}`;
      
      return latex;
    }

    async function compileLatexToPDF(latexContent) {
      try {
        const res = await fetch('/compile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tex: latexContent })
        });

        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          const error = (data && (data.log || data.error)) ? (data.log || data.error) : `HTTP ${res.status}`;
          throw new Error(error);
        }

        return await res.blob();
      } catch (e) {
        console.error('Server compile failed:', e);
        throw e;
      }
    }

    // Enhanced jsPDF fallback that closely mimics LaTeX output
    async function generateEnhancedPDFFallback(resumeData) {
      try {
        console.log('=== ENHANCED JSPDF FALLBACK DEBUG ===');
        console.log('Generating enhanced PDF with LaTeX-like styling...');
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
          orientation: 'portrait',
          unit: 'in',
          format: 'a4'
        });
        
        // Set up fonts and colors to match LaTeX exactly
        const accentColor = '#0A66C2';
        const textColor = '#000000';
        const lightGray = '#666666';
        
        // Page dimensions (A4: 8.27" x 11.69")
        const pageWidth = 8.27;
        const pageHeight = 11.69;
        const margin = 1.0;
        const contentWidth = pageWidth - (2 * margin);
        
        let currentY = 0.4; // Start position (matching LaTeX top margin)
        
        // Helper function to add text with proper wrapping
        const addText = (text, x, y, options = {}) => {
          const {
            fontSize = 10,
            fontStyle = 'normal',
            color = textColor,
            align = 'left',
            maxWidth = contentWidth
          } = options;
          
          doc.setFontSize(fontSize);
          doc.setFont('helvetica', fontStyle);
          doc.setTextColor(color);
          
          const lines = doc.splitTextToSize(text, maxWidth);
          doc.text(lines, x, y, { align });
          return y + (lines.length * fontSize * 0.04);
        };
        
        // Helper function to add section header (matching LaTeX \sectiontitle)
        const addSectionHeader = (title, y) => {
          // Add space before section (matching \vspace{10pt})
          const newY = addText(title, margin, y + 0.15, {
            fontSize: 12,
            fontStyle: 'bold',
            color: accentColor
          });
          
          // Add underline (matching LaTeX \rule{\textwidth}{0.6pt})
          doc.setDrawColor(accentColor);
          doc.setLineWidth(0.6);
          doc.line(margin, newY + 0.05, margin + contentWidth, newY + 0.05);
          
          return newY + 0.1; // Space after header (matching \vspace{4pt})
        };
        
        // Header (matching LaTeX \begin{center}...\end{center})
        const name = resumeData.contact?.name || 'Your Name';
        const email = resumeData.contact?.email || 'email@example.com';
        const phone = resumeData.contact?.phone || 'Phone';
        const address = resumeData.contact?.address || 'Location';
        
        currentY = addText(name, margin, currentY, {
          fontSize: 18,
          fontStyle: 'bold',
          align: 'center',
          maxWidth: contentWidth
        });
        
        currentY = addText(`${email} | ${phone} | ${address}`, margin, currentY + 0.1, {
          fontSize: 10,
          align: 'center',
          color: textColor,
          maxWidth: contentWidth
        });
        
        currentY += 0.2;
        
        // Professional Summary
        if (resumeData.summary) {
          currentY = addSectionHeader('PROFESSIONAL SUMMARY', currentY);
          currentY = addText(resumeData.summary, margin, currentY, {
            fontSize: 10,
            maxWidth: contentWidth
          });
          currentY += 0.2; // Extra space after summary
        }
        
        // Work Experience (matching LaTeX \roleblock)
        if (resumeData.jobs && resumeData.jobs.length > 0) {
          currentY = addSectionHeader('WORK EXPERIENCE', currentY);
          
          resumeData.jobs.forEach((job, index) => {
            // Job title (bold) - matching \textbf{#1}
            const jobTitle = job.title || '';
            currentY = addText(jobTitle, margin, currentY, {
              fontSize: 10,
              fontStyle: 'bold'
            });
            
            // Company -- Location (dates) (italic) - matching \itshape #2 -- #3\ (#4)
            const company = job.company || '';
            const location = job.location || '';
            const dates = `${job.startDate || ''} -- ${job.endDate || ''}`;
            currentY = addText(`${company} -- ${location} (${dates})`, margin, currentY, {
              fontSize: 10,
              fontStyle: 'italic',
              color: lightGray
            });
            
            currentY += 0.05; // Small space before duties (matching \par\vspace{4pt})
            
            // Job duties with proper bullet formatting (matching \begin{itemize})
            if (job.duties && Array.isArray(job.duties)) {
              job.duties.forEach(duty => {
                currentY = addText(` ${duty}`, margin, currentY + 0.05, {
                  fontSize: 9,
                  maxWidth: contentWidth
                });
              });
            }
            
            currentY += 0.1; // Space between jobs (matching \vspace{8pt})
          });
        }
        
        // Skills (matching LaTeX tabularx)
        if (resumeData.skills && showSkillsCheckbox.checked) {
          currentY = addSectionHeader('SKILLS', currentY);
          
          const skillCategories = Object.keys(resumeData.skills);
          if (skillCategories.length > 0) {
            // Create two-column layout for skills (matching tabularx)
            const leftColumn = [];
            const rightColumn = [];
            
            skillCategories.forEach((category, index) => {
              const skills = Array.isArray(resumeData.skills[category]) 
                ? resumeData.skills[category].join(', ') 
                : '';
              const skillText = `${category}: ${skills}`;
              
              if (index % 2 === 0) {
                leftColumn.push(skillText);
              } else {
                rightColumn.push(skillText);
              }
            });
            
            // Add skills in two columns (matching tabularx layout)
            const maxRows = Math.max(leftColumn.length, rightColumn.length);
            for (let i = 0; i < maxRows; i++) {
              const leftText = leftColumn[i] || '';
              const rightText = rightColumn[i] || '';
              
              // Left column
              if (leftText) {
                currentY = addText(leftText, margin, currentY, {
                  fontSize: 9,
                  maxWidth: contentWidth / 2 - 0.1
                });
              }
              
              // Right column
              if (rightText) {
                currentY = addText(rightText, margin + contentWidth / 2 + 0.1, currentY - (leftText ? 0.15 : 0), {
                  fontSize: 9,
                  maxWidth: contentWidth / 2 - 0.1
                });
              } else if (leftText) {
                currentY += 0.15; // Add space if only left column has content
              }
            }
          }
          currentY += 0.1;
        }
        
        // Education & Certifications (matching LaTeX itemize)
        const education = resumeData.education || [];
        const certificates = resumeData.certificates || [];
        
        if (education.length > 0 || certificates.length > 0) {
          currentY = addSectionHeader('EDUCATION & CERTIFICATIONS', currentY);
          
          // Education
          education.forEach(edu => {
            const formattedEdu = edu.replace(/\s+from\s+/g, '  ');
            currentY = addText(` ${formattedEdu}`, margin, currentY + 0.05, {
              fontSize: 9,
              maxWidth: contentWidth
            });
          });
          
          // Certificates
          certificates.forEach(cert => {
            const certName = typeof cert === 'string' ? cert : cert.name || '';
            currentY = addText(` ${certName}`, margin, currentY + 0.05, {
              fontSize: 9,
              maxWidth: contentWidth
            });
          });
        }
        
        // Generate PDF blob
        const pdfBlob = doc.output('blob');
        const url = URL.createObjectURL(pdfBlob);
        
        console.log('Enhanced PDF fallback generation successful');
        return pdfBlob;
        
      } catch (error) {
        console.error('Enhanced PDF fallback error:', error);
        throw error;
      }
    }


    // Fallback PDF generation using jsPDF with LaTeX styling
    async function generatePDFWithJsPDF(data) {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
      
      // PDF styling constants (matching LaTeX template)
      const pageWidth = 612; // Letter width
      const pageHeight = 792; // Letter height
      const margin = 72; // 1 inch margins
      const contentWidth = pageWidth - (margin * 2);
      let currentY = margin + 20; // Start a bit below top margin

      // Helper function to add text with word wrapping
      function addText(text, fontSize = 12, isBold = false, color = '#000000', maxWidth = contentWidth, alignment = 'left') {
        if (!text) return;
        
        pdf.setFontSize(fontSize);
        pdf.setFont('helvetica', isBold ? 'bold' : 'normal');
        pdf.setTextColor(color);
        
        const lines = pdf.splitTextToSize(String(text), maxWidth);
        for (let i = 0; i < lines.length; i++) {
          if (currentY > pageHeight - margin - 20) {
            pdf.addPage();
            currentY = margin + 20;
          }
          
          let xPos = margin;
          if (alignment === 'center') {
            xPos = pageWidth / 2;
            pdf.text(lines[i], xPos, currentY, { align: 'center' });
          } else {
            pdf.text(lines[i], xPos, currentY);
          }
          currentY += fontSize * 1.2; // Better line spacing
        }
      }

      // Helper function to add a section header (matching LaTeX \sectiontitle)
      function addSectionHeader(text) {
        currentY += 10; // Space before section
        addText(text, 14, true, '#0A66C2'); // Blue color like LaTeX
        currentY += 4; // Space after text, before line
        
        // Add blue underline (matching LaTeX rule)
        pdf.setDrawColor(10, 102, 194);
        pdf.setLineWidth(0.6);
        pdf.line(margin, currentY, pageWidth - margin, currentY);
        currentY += 6; // Space after rule
      }

      // Helper function for role blocks (matching LaTeX \roleblock)
      function addRoleBlock(title, company, location, dates) {
        addText(title, 12, true); // Bold title
        currentY += 2;
        
        const companyLocation = company + (location ? ` -- ${location}` : '');
        const dateStr = dates ? ` (${dates})` : '';
        addText(`${companyLocation}${dateStr}`, 11, false, '#666666'); // Italic style
        currentY += 6; // More space before duties
      }

      // Contact Information (centered like LaTeX)
      if (data.contact) {
        addText(data.contact.name, 20, true, '#000000', contentWidth, 'center');
        currentY += 4;
        
        const contactInfo = [];
        if (data.contact.email) contactInfo.push(data.contact.email);
        if (data.contact.phone) contactInfo.push(data.contact.phone);
        if (data.contact.address) contactInfo.push(data.contact.address);
        
        addText(contactInfo.join(' | '), 11, false, '#000000', contentWidth, 'center');
        currentY += 20;
      }

      // Professional Summary
      if (data.summary) {
        addSectionHeader('PROFESSIONAL SUMMARY');
        addText(data.summary, 11);
        currentY += 10;
      }

      // Work Experience
      if (data.jobs && data.jobs.length > 0) {
        addSectionHeader('WORK EXPERIENCE');
        
        data.jobs.forEach(job => {
          const location = job.location || '';
          const dates = `${job.startDate || ''} -- ${job.endDate || ''}`;
          
          addRoleBlock(job.title, job.company, location, dates);
          
          if (job.duties && job.duties.length > 0) {
            job.duties.forEach(duty => {
              addText(' ' + duty, 10, false, '#000000', contentWidth - 30);
              currentY += 2; // Small space between duties
            });
          }
          currentY += 12; // More space between jobs
        });
      }

      // Skills (simplified single-column format for better layout)
      if (data.skills && showSkillsCheckbox.checked) {
        addSectionHeader('SKILLS');
        
        Object.keys(data.skills).forEach(category => {
          const skills = data.skills[category];
          if (Array.isArray(skills) && skills.length > 0) {
            addText(`${category}: ${skills.join(', ')}`, 11, false, '#000000');
            currentY += 3; // Small space between skill categories
          }
        });
        currentY += 10;
      }

      // Education & Certificates (combined section)
      if ((data.education && data.education.length > 0) || (data.certificates && data.certificates.length > 0)) {
        addSectionHeader('EDUCATION & CERTIFICATIONS');
        
        // Add education items
        if (data.education && data.education.length > 0) {
          data.education.forEach(edu => {
            addText(' ' + edu, 11);
          });
        }
        
        // Add certificate items
        if (data.certificates && data.certificates.length > 0) {
          data.certificates.forEach(cert => {
            const certName = typeof cert === 'string' ? cert : cert.name || '';
            addText(' ' + certName, 11);
          });
        }
        
        currentY += 10;
      }

      return pdf.output('blob');
}

// OCR Processing Functions
async function processPdfWithOCR(pdfArrayBuffer) {
  const scale = 2.0; // Using your preferred scale
  const lang = 'eng';
  
  try {
    // Load PDF with pdf-lib
    const srcDoc = await PDFLib.PDFDocument.load(pdfArrayBuffer);
    const pageCount = srcDoc.getPageCount();
    
    // Create output document
    const outDoc = await PDFLib.PDFDocument.create();
    const helv = await outDoc.embedFont(PDFLib.StandardFonts.Helvetica);
    
    // Copy all pages as vector backgrounds
    const copied = await outDoc.copyPages(srcDoc, Array.from({length: pageCount}, (_,i)=>i));
    
    // Load PDF.js for rendering
    await ensurePdfJs();
    const readerPdf = await window.pdfjsLib.getDocument({ data: pdfArrayBuffer }).promise;
    
    for (let i = 1; i <= pageCount; i++) {
      // Update progress - show progress at the START of each page
      const progress = ((i - 1) / pageCount) * 100;
      const loadingBarFill = document.querySelector('.loading-bar-fill');
      const loadingBarText = document.querySelector('.loading-bar-text');
      
      if (loadingBarFill) {
        loadingBarFill.style.width = `${progress}%`;
        loadingBarFill.style.animation = 'none'; // Stop the CSS animation
      }
      if (loadingBarText) {
        loadingBarText.textContent = `Loading page ${i}`;
      }
      
      // Render page to canvas for OCR
      const { canvas, pageWidthPts, pageHeightPts } = await renderPdfPageToCanvas(readerPdf, i, scale);
      const pageOut = outDoc.addPage(copied[i-1]);
      
      // Run OCR on the canvas
      const result = await Tesseract.recognize(canvas, lang, { logger: m => {} });
      const words = wordsFromTesseract(result);
      
      // Add hidden text layer
      drawHiddenTextLayer(pageOut, words, canvas.width, canvas.height, pageWidthPts, pageHeightPts, helv);
      
      // Clean up canvas
      canvas.width = 0;
      canvas.height = 0;
      
      // Update progress to show completion of this page
      const completionProgress = (i / pageCount) * 100;
      if (loadingBarFill) {
        loadingBarFill.style.width = `${completionProgress}%`;
      }
    }
    
    if (document.querySelector('.loading-bar-text')) {
      document.querySelector('.loading-bar-text').textContent = 'Packaging...';
    }
    const outBytes = await outDoc.save();
    
    if (document.querySelector('.loading-bar-fill')) {
      document.querySelector('.loading-bar-fill').style.width = '100%';
    }
    if (document.querySelector('.loading-bar-text')) {
      document.querySelector('.loading-bar-text').textContent = 'Complete!';
    }
    
    return new Blob([outBytes], { type: 'application/pdf' });
    
  } catch (error) {
    console.error('OCR processing error:', error);
    throw error;
  }
}

async function ensurePdfJs() {
  if (window.pdfjsLib) {
    try { 
      window.pdfjsLib.GlobalWorkerOptions.workerSrc ||= 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js'; 
    } catch(e) {}
    return window.pdfjsLib;
  }
  
  // Load pdf.js dynamically
  const script = document.createElement('script');
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
  document.head.appendChild(script);
  
  return new Promise((resolve, reject) => {
    script.onload = () => {
      window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      resolve(window.pdfjsLib);
    };
    script.onerror = reject;
  });
}

async function renderPdfPageToCanvas(pdf, pageNum, ocrScale) {
  const page = await pdf.getPage(pageNum);
  const viewportPts = page.getViewport({ scale: 1 });
  const viewport = page.getViewport({ scale: ocrScale });
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = Math.floor(viewport.width);
  canvas.height = Math.floor(viewport.height);
  await page.render({ canvasContext: ctx, viewport }).promise;
  return { canvas, pageWidthPts: viewportPts.width, pageHeightPts: viewportPts.height };
}

function wordsFromTesseract(result) {
  return (result && result.data && Array.isArray(result.data.words)) ? result.data.words : [];
}

function drawHiddenTextLayer(pageOut, words, canvasWpx, canvasHpx, pageWpts, pageHpts, font) {
  const scaleX = pageWpts / canvasWpx;
  const scaleY = pageHpts / canvasHpx;
  for (const w of words) {
    if (!w || !w.text) continue;
    const b = w.bbox || w.bbox0 || w.boundingBox || {};
    const x0px = (b.x0 ?? b.left ?? 0);
    const y1px = (b.y1 ?? b.bottom ?? ((b.y0 ?? b.top ?? 0) + 10));
    const heightPx = Math.max(1, (b.y1 ?? b.bottom ?? 0) - (b.y0 ?? b.top ?? 0));
    const fontSizePts = Math.max(6, Math.min(48, heightPx * scaleY));
    const xPts = x0px * scaleX;
    const yPts = pageHpts - y1px * scaleY; // convert to PDF coords
    pageOut.drawText(w.text, { x: xPts, y: yPts, size: fontSizePts, font, color: PDFLib.rgb(0,0,0), opacity: 0.01 });
  }
}

    // Authentication Functions
    function showAuthModal() {
      authModal.classList.add('active');
      showSignUpForm();
    }

    function hideAuthModal() {
      authModal.classList.remove('active');
      hideError();
      hideLoading();
    }

    function showSignUpForm() {
      signUpForm.style.display = 'block';
      signInForm.style.display = 'none';
      hideError();
    }

    function showSignInForm() {
      signInForm.style.display = 'block';
      signUpForm.style.display = 'none';
      hideError();
    }

    function showLoading(text = 'Processing...') {
      authLoading.style.display = 'block';
      signUpForm.style.display = 'none';
      signInForm.style.display = 'none';
      loadingText.textContent = text;
    }

    function hideLoading() {
      authLoading.style.display = 'none';
    }

    function showAuthError(message) {
      authError.style.display = 'flex';
      errorMessage.textContent = message;
    }

    function hideError() {
      authError.style.display = 'none';
    }

    function updateUIForUser(user) {
      currentUser = user;
      isAuthenticated = true;
      
      // Show main content
      mainHeader.classList.remove('hidden');
      mainContent.classList.remove('hidden');
      
      // Show user info
      userInfo.style.display = 'flex';
      userEmail.textContent = user.email;
      
      // Load user's resume, job titles, and personal info
      loadUserResume();
      loadJobTitlesFromFirebase();
      loadPersonalInfoFromFirebase();
      
      // Hide auth modal
      hideAuthModal();
    }

    function updateUIForGuest() {
      currentUser = null;
      isAuthenticated = false;
      
      // Hide main content
      mainHeader.classList.add('hidden');
      mainContent.classList.add('hidden');
      
      // Hide user info
      userInfo.style.display = 'none';
      
      // Hide job titles section
      if (jobTitlesSection) {
        jobTitlesSection.style.display = 'none';
      }
      
      // Hide education section
      if (educationSection) {
        educationSection.style.display = 'none';
      }
      
      // Show auth modal
      showAuthModal();
    }

    // Authentication Event Listeners
    switchToLogin.addEventListener('click', (e) => {
      e.preventDefault();
      showSignInForm();
    });

    switchToSignUp.addEventListener('click', (e) => {
      e.preventDefault();
      showSignUpForm();
    });

    signUpFormElement.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('signUpEmail').value;
      const password = document.getElementById('signUpPassword').value;
      const confirmPassword = document.getElementById('signUpConfirmPassword').value;
      
      if (password !== confirmPassword) {
        showAuthError('Passwords do not match');
        return;
      }
      
      if (password.length < 6) {
        showAuthError('Password must be at least 6 characters');
        return;
      }
      
      try {
        showLoading('Creating your account...');
        const userCredential = await window.createUserWithEmailAndPassword(window.auth, email, password);
        console.log('User created:', userCredential.user);
        // updateUIForUser will be called by onAuthStateChanged
      } catch (error) {
        console.error('Sign up error:', error);
        hideLoading();
        showSignUpForm();
        
        let errorMsg = 'Failed to create account. Please try again.';
        if (error.code === 'auth/email-already-in-use') {
          errorMsg = 'This email is already registered. Please sign in instead.';
        } else if (error.code === 'auth/invalid-email') {
          errorMsg = 'Please enter a valid email address.';
        } else if (error.code === 'auth/weak-password') {
          errorMsg = 'Password is too weak. Please choose a stronger password.';
        }
        showAuthError(errorMsg);
      }
    });

    signInFormElement.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('signInEmail').value;
      const password = document.getElementById('signInPassword').value;
      
      try {
        showLoading('Signing you in...');
        const userCredential = await window.signInWithEmailAndPassword(window.auth, email, password);
        console.log('User signed in:', userCredential.user);
        // updateUIForUser will be called by onAuthStateChanged
      } catch (error) {
        console.error('Sign in error:', error);
        hideLoading();
        showSignInForm();
        
        let errorMsg = 'Failed to sign in. Please try again.';
        if (error.code === 'auth/user-not-found') {
          errorMsg = 'No account found with this email. Please sign up first.';
        } else if (error.code === 'auth/wrong-password') {
          errorMsg = 'Incorrect password. Please try again.';
        } else if (error.code === 'auth/invalid-email') {
          errorMsg = 'Please enter a valid email address.';
        } else if (error.code === 'auth/too-many-requests') {
          errorMsg = 'Too many failed attempts. Please try again later.';
        }
        showAuthError(errorMsg);
      }
    });

    logoutBtn.addEventListener('click', async () => {
      try {
        await window.signOut(window.auth);
        console.log('User signed out');
        // updateUIForGuest will be called by onAuthStateChanged
      } catch (error) {
        console.error('Sign out error:', error);
        showAuthError('Failed to sign out. Please try again.');
      }
    });

    // Initialize authentication state listener
    function initializeAuth() {
      window.onAuthStateChanged(window.auth, (user) => {
        if (user) {
          updateUIForUser(user);
        } else {
          updateUIForGuest();
        }
      });
    }

    // Personal Info Event Listeners
    function addPersonalInfoListeners() {
      [personalName, personalAddress, personalEmail, personalPhone].forEach(input => {
        if (input) {
          input.addEventListener('input', updatePersonalInfo);
        }
      });
      
      // Add explicit save button listener
      if (savePersonalInfoBtn) {
        savePersonalInfoBtn.addEventListener('click', async () => {
          console.log('Save Personal Info button clicked');
          await savePersonalInfoToFirebase();
        });
      }
    }

    function updatePersonalInfo() {
      if (resumeData) {
        // Update resume data with personal info
        resumeData.contact.name = personalName.value;
        resumeData.contact.address = personalAddress.value;
        resumeData.contact.email = personalEmail.value;
        resumeData.contact.phone = personalPhone.value;
        
        // Save to Firebase immediately
        savePersonalInfoToFirebase();
        
        // Re-render resume
        renderResume(resumeData);
        generatePDFandStore();
      }
    }

    // Save personal info to Firebase in real-time
    async function savePersonalInfoToFirebase() {
      console.log('=== SAVING PERSONAL INFO TO FIREBASE ===');
      console.log('Current user:', currentUser ? currentUser.uid : 'No user');
      console.log('Resume data exists:', !!resumeData);
      
      if (!currentUser) {
        console.error('No authenticated user - cannot save to Firebase');
        alert('Please sign in to save personal information');
        return;
      }
      
      try {
        const personalInfo = {
          name: personalName ? personalName.value : '',
          address: personalAddress ? personalAddress.value : '',
          email: personalEmail ? personalEmail.value : '',
          phone: personalPhone ? personalPhone.value : '',
          lastUpdated: new Date().toISOString()
        };
        
        console.log('Personal info to save:', personalInfo);
        
        // Save to Firestore instead of Storage to avoid CORS issues
        const personalInfoRef = doc(db, 'users', currentUser.uid, 'personalInfo', 'data');
        console.log('Firestore path: users/', currentUser.uid, '/personalInfo/data');
        
        await setDoc(personalInfoRef, personalInfo);
        console.log(' Personal info saved to Firestore successfully!');
        
        // Show success message
        if (savePersonalInfoBtn) {
          const originalText = savePersonalInfoBtn.innerHTML;
          savePersonalInfoBtn.innerHTML = '<i class="fas fa-check"></i> Saved!';
          savePersonalInfoBtn.style.backgroundColor = '#22c55e';
          setTimeout(() => {
            savePersonalInfoBtn.innerHTML = originalText;
            savePersonalInfoBtn.style.backgroundColor = '';
          }, 2000);
        }
        
      } catch (error) {
        console.error(' Error saving personal info to Firebase:', error);
        alert('Failed to save personal information: ' + error.message);
      }
    }

    // Load personal info from Firebase
    async function loadPersonalInfoFromFirebase() {
      if (!currentUser) {
        console.log('No authenticated user - cannot load personal info');
        return;
      }
      
      console.log('=== LOADING PERSONAL INFO FROM FIREBASE ===');
      console.log('User ID:', currentUser.uid);
      
      try {
        // Load from Firestore instead of Storage to avoid CORS issues
        const personalInfoRef = doc(db, 'users', currentUser.uid, 'personalInfo', 'data');
        console.log('Firestore path: users/', currentUser.uid, '/personalInfo/data');
        
        const personalInfoDoc = await getDoc(personalInfoRef);
        
        if (!personalInfoDoc.exists()) {
          console.log('No personal info document found in Firestore');
          return;
        }
        
        const personalInfo = personalInfoDoc.data();
        console.log('Personal info loaded from Firestore:', personalInfo);
        
        // Update form fields with loaded data
        if (personalName) {
          personalName.value = personalInfo.name || '';
          console.log('Updated personalName field:', personalName.value);
        }
        if (personalAddress) {
          personalAddress.value = personalInfo.address || '';
          console.log('Updated personalAddress field:', personalAddress.value);
        }
        if (personalEmail) {
          personalEmail.value = personalInfo.email || '';
          console.log('Updated personalEmail field:', personalEmail.value);
        }
        if (personalPhone) {
          personalPhone.value = personalInfo.phone || '';
          console.log('Updated personalPhone field:', personalPhone.value);
        }
        
        // Update resume data if it exists
        if (resumeData) {
          resumeData.contact.name = personalInfo.name || '';
          resumeData.contact.address = personalInfo.address || '';
          resumeData.contact.email = personalInfo.email || '';
          resumeData.contact.phone = personalInfo.phone || '';
          
          // Re-render resume with updated personal info
          renderResume(resumeData);
        }
        
        console.log(' Personal info loaded from Firestore successfully!');
        
        // Show success message on save button if it exists
        if (savePersonalInfoBtn) {
          const originalText = savePersonalInfoBtn.innerHTML;
          savePersonalInfoBtn.innerHTML = '<i class="fas fa-check"></i> Loaded!';
          savePersonalInfoBtn.style.backgroundColor = '#22c55e';
          setTimeout(() => {
            savePersonalInfoBtn.innerHTML = originalText;
            savePersonalInfoBtn.style.backgroundColor = '';
          }, 2000);
        }
        
      } catch (error) {
        console.log('No personal info found in Firestore (this is normal for new users):', error.message);
      }
    }

    // Current Resume Functions
    let currentResumeUrl = null;
    let currentResumeRef = null;

    async function uploadResumeToFirebase(file) {
      if (!currentUser) {
        throw new Error('User must be authenticated to upload resume');
      }

      try {
        // Delete existing resume if any
        if (currentResumeRef) {
          try {
            await window.deleteObject(currentResumeRef);
          } catch (error) {
            console.log('No existing resume to delete');
          }
        }

        // Create new file reference
        const fileName = `resume_${currentUser.uid}_${Date.now()}.${file.name.split('.').pop()}`;
        const resumeRef = window.ref(window.storage, `resumes/${fileName}`);
        
        // Upload file
        const snapshot = await window.uploadBytes(resumeRef, file);
        const downloadURL = await window.getDownloadURL(snapshot.ref);
        
        // Save resume info to Firestore
        await window.setDoc(window.doc(window.db, 'users', currentUser.uid), {
          resumeUrl: downloadURL,
          resumeFileName: file.name,
          resumeRef: fileName,
          lastUpdated: new Date()
        }, { merge: true });

        currentResumeUrl = downloadURL;
        currentResumeRef = resumeRef;
        
        return { downloadURL, fileName: file.name };
      } catch (error) {
        console.error('Error uploading resume:', error);
        throw error;
      }
    }

    async function loadUserResume() {
      if (!currentUser) return;

      try {
        const userDoc = await window.getDoc(window.doc(window.db, 'users', currentUser.uid));
        if (userDoc.exists()) {
          const userData = userDoc.data();
          if (userData.resumeUrl) {
            currentResumeUrl = userData.resumeUrl;
            currentResumeRef = window.ref(window.storage, `resumes/${userData.resumeRef}`);
            showResumePreview(userData.resumeFileName, userData.resumeUrl);
          }
        }
      } catch (error) {
        console.error('Error loading user resume:', error);
      }
    }

    function showResumePreview(fileName, url) {
      fileUploadArea.style.display = 'none';
      resumePreviewContainer.style.display = 'block';
      resumeFilename.textContent = fileName;
      
      // Set up thumbnail based on file type
      const fileExtension = fileName.split('.').pop().toLowerCase();
      const thumbnail = resumePreviewThumbnail;
      
      if (fileExtension === 'pdf') {
        thumbnail.innerHTML = '<i class="fas fa-file-pdf" style="color: #ef4444;"></i>';
      } else if (['doc', 'docx'].includes(fileExtension)) {
        thumbnail.innerHTML = '<i class="fas fa-file-word" style="color: #2563eb;"></i>';
      } else {
        thumbnail.innerHTML = '<i class="fas fa-file" style="color: var(--text-muted);"></i>';
      }
    }

    function hideResumePreview() {
      fileUploadArea.style.display = 'block';
      resumePreviewContainer.style.display = 'none';
      currentResumeUrl = null;
      currentResumeRef = null;
      
      // Clear and hide job titles when resume is removed
      clearJobTitles();
    }

    async function removeResume() {
      if (!currentUser || !currentResumeRef) return;

      try {
        // Delete from Storage
        await window.deleteObject(currentResumeRef);
        
        // Remove from Firestore
        await window.updateDoc(window.doc(window.db, 'users', currentUser.uid), {
          resumeUrl: null,
          resumeFileName: null,
          resumeRef: null,
          jobTitles: null
        });

        hideResumePreview();
      } catch (error) {
        console.error('Error removing resume:', error);
        showPreviewError('Failed to remove resume. Please try again.');
      }
    }

    function viewResume() {
      if (currentResumeUrl) {
        window.open(currentResumeUrl, '_blank');
      }
    }

    // File upload event listeners
    fileUploadArea.addEventListener('click', () => {
      resumeFileInput.click();
    });

    resumeFileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      // Validate file type
      const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
      if (!allowedTypes.includes(file.type)) {
        showPreviewError('Please upload a PDF, DOC, or DOCX file');
        return;
      }

      // Validate file size (max 10MB)
      if (file.size > 10 * 1024 * 1024) {
        showPreviewError('File size must be less than 10MB');
        return;
      }

      try {
        showLoading('Uploading resume...');
        const result = await uploadResumeToFirebase(file);
        showResumePreview(result.fileName, result.downloadURL);
        hideLoading();
        
        // Extract job titles from the uploaded resume
        await extractJobTitlesFromResume(file);
      } catch (error) {
        hideLoading();
        showPreviewError(`Failed to upload resume: ${error.message}`);
      }
    });

    // Drag and drop functionality
    fileUploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      fileUploadArea.classList.add('dragover');
    });

    fileUploadArea.addEventListener('dragleave', () => {
      fileUploadArea.classList.remove('dragover');
    });

    fileUploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      fileUploadArea.classList.remove('dragover');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        resumeFileInput.files = files;
        resumeFileInput.dispatchEvent(new Event('change'));
      }
    });

    // Action buttons
    viewResumeBtn.addEventListener('click', viewResume);
    removeResumeBtn.addEventListener('click', removeResume);

    // Job Titles Extraction Functions
    let extractedJobData = [];
    let extractedEducationData = [];

    async function extractJobTitlesFromResume(file) {
      try {
        // Show loading state
        jobTitlesSection.style.display = 'block';
        jobTitlesLoading.style.display = 'block';
        jobTitlesEmpty.style.display = 'none';
        jobTitlesContainer.innerHTML = '';

        // Convert file to image for OCR
        const imageUrl = await convertFileToImage(file);
        
        // Process each page separately and combine results
        let jobData = [];
        let educationData = [];
        try {
          const result = await extractJobsFromAllPages(file);
          jobData = result.jobs;
          educationData = result.education;
        } catch (error) {
          console.error('Multi-page extraction failed:', error);
          // Fallback to single image processing
          try {
            const result = await extractJobsAndEducationWithChatGPTVision(imageUrl);
            jobData = result.jobs;
            educationData = result.education;
          } catch (visionError) {
            console.error('ChatGPT Vision failed:', visionError);
            // Final fallback to OCR
            const result = await Tesseract.recognize(imageUrl, 'eng', {
              logger: m => {
                if (m.status === 'recognizing text') {
                  // Update progress if needed
                }
              }
            });
            jobData = await extractJobsWithChatGPT(result.data.text);
            educationData = []; // OCR doesn't extract education yet
          }
        }
        
        if (jobData.length > 0 || educationData.length > 0) {
          extractedJobData = jobData;
          extractedEducationData = educationData;
          displayJobTitles(jobData);
          displayEducation(educationData);
          await saveJobTitlesToFirebase(jobData);
          await saveEducationToFirebase(educationData);
        } else {
          showJobTitlesEmpty();
          showEducationEmpty();
        }

        // Clean up
        URL.revokeObjectURL(imageUrl);
        jobTitlesLoading.style.display = 'none';

      } catch (error) {
        console.error('Error extracting job titles:', error);
        jobTitlesLoading.style.display = 'none';
        showJobTitlesEmpty();
        showPreviewError('Failed to extract job information from resume');
      }
    }

    async function convertFileToImage(file) {
      return new Promise(async (resolve, reject) => {
        if (file.type === 'application/pdf') {
          try {
            // Load PDF.js if not already loaded
            await ensurePdfJs();
            
            // Convert PDF to image using PDF.js
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            
            // Process all pages and combine them
            const pageCount = pdf.numPages;
            const allPagesCanvas = document.createElement('canvas');
            const allPagesContext = allPagesCanvas.getContext('2d');
            
            let totalHeight = 0;
            let maxWidth = 0;
            
            // First pass: calculate total dimensions
            for (let pageNum = 1; pageNum <= pageCount; pageNum++) {
              const page = await pdf.getPage(pageNum);
              const viewport = page.getViewport({ scale: 2.0 });
              totalHeight += viewport.height;
              maxWidth = Math.max(maxWidth, viewport.width);
            }
            
            // Set canvas dimensions
            allPagesCanvas.width = maxWidth;
            allPagesCanvas.height = totalHeight;
            
            // Second pass: render all pages
            let currentY = 0;
            for (let pageNum = 1; pageNum <= pageCount; pageNum++) {
              const page = await pdf.getPage(pageNum);
              const viewport = page.getViewport({ scale: 2.0 });
              
              const renderContext = {
                canvasContext: allPagesContext,
                viewport: viewport,
                transform: [1, 0, 0, 1, 0, currentY]
              };
              
              await page.render(renderContext).promise;
              currentY += viewport.height;
            }
            
            resolve(allPagesCanvas.toDataURL('image/png'));
          } catch (error) {
            console.error('Error converting PDF to image:', error);
            // Fallback to a simple canvas
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 1000;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'black';
            ctx.font = '16px Arial';
            ctx.fillText('PDF Resume - Processing...', 50, 50);
            resolve(canvas.toDataURL());
          }
        } else {
          // For image files, convert to data URL
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        }
      });
    }

    function parseJobTitlesFromText(text) {
      const jobs = [];
      const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
      
      console.log('OCR Text extracted:', text); // Debug log
      
      // Look for work experience section
      let workExperienceStart = -1;
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].toLowerCase();
        if (line.includes('work experience') || line.includes('employment') || 
            line.includes('professional experience') || line.includes('career') ||
            line.includes('experience') || line.includes('employment history')) {
          workExperienceStart = i;
          break;
        }
      }
      
      // If no work experience section found, start from beginning
      const startIndex = workExperienceStart >= 0 ? workExperienceStart : 0;
      
      // Look for job entries
      for (let i = startIndex; i < lines.length; i++) {
        const line = lines[i];
        
        // Skip section headers
        if (isSectionHeader(line)) continue;
        
        // Check if line contains job title indicators
        if (isJobTitleLine(line)) {
          const job = extractJobFromLine(line, lines, i);
          if (job.title && job.company) {
            jobs.push(job);
            console.log('Extracted job:', job); // Debug log
          }
        }
      }

      return jobs;
    }

    function isSectionHeader(line) {
      const sectionHeaders = [
        'work experience', 'employment', 'professional experience', 'career',
        'education', 'skills', 'certifications', 'projects', 'achievements',
        'summary', 'objective', 'contact', 'personal information'
      ];
      
      const lowerLine = line.toLowerCase();
      return sectionHeaders.some(header => lowerLine.includes(header));
    }

    function isJobTitleLine(line) {
      const jobKeywords = [
        'engineer', 'developer', 'manager', 'analyst', 'specialist', 'coordinator',
        'director', 'lead', 'senior', 'junior', 'associate', 'intern', 'consultant',
        'advisor', 'architect', 'designer', 'programmer', 'technician', 'administrator',
        'supervisor', 'executive', 'officer', 'representative', 'assistant', 'clerk',
        'agent', 'operator', 'technologist', 'scientist', 'researcher', 'strategist',
        'planner', 'facilitator', 'liaison', 'advocate', 'expert', 'professional',
        'practitioner'
      ];

      const lowerLine = line.toLowerCase();
      return jobKeywords.some(keyword => lowerLine.includes(keyword)) ||
             line.includes(' at ') || line.includes(' @ ') || line.includes(', ');
    }

    function extractJobFromLine(line, allLines, currentIndex) {
      const job = { title: '', company: '', dates: '' };

      // Extract title and company
      const atMatch = line.match(/(.+?)\s+(?:at|@|,)\s+(.+)/i);
      if (atMatch) {
        job.title = atMatch[1].trim();
        job.company = atMatch[2].trim();
      } else {
        job.title = line;
        // Look for company in next few lines
        for (let i = currentIndex + 1; i < Math.min(currentIndex + 5, allLines.length); i++) {
          const nextLine = allLines[i];
          if (nextLine && !isJobTitleLine(nextLine) && !containsDates(nextLine) && 
              !isSectionHeader(nextLine) && nextLine.length > 2) {
            job.company = nextLine;
            break;
          }
        }
      }

      // Extract dates from current line or nearby lines
      job.dates = extractDatesFromLine(line) || 
                  extractDatesFromContext(allLines, currentIndex);

      return job;
    }

    function containsDates(line) {
      return /\d{4}|\d{1,2}\/\d{4}|\w+\s+\d{4}/.test(line);
    }

    function extractDatesFromLine(line) {
      const datePatterns = [
        /(\d{4})\s*[-]\s*(\d{4}|\w+)/g,
        /(\w+\s+\d{4})\s*[-]\s*(\w+\s+\d{4}|\w+)/g,
        /(\d{1,2}\/\d{4})\s*[-]\s*(\d{1,2}\/\d{4}|\w+)/g
      ];

      for (const pattern of datePatterns) {
        const match = line.match(pattern);
        if (match) {
          return match[0];
        }
      }
      return null;
    }

    function extractDatesFromContext(allLines, currentIndex) {
      // Look in current line and next 2 lines for dates
      for (let i = currentIndex; i < Math.min(currentIndex + 3, allLines.length); i++) {
        const dates = extractDatesFromLine(allLines[i]);
        if (dates) return dates;
      }
      return '';
    }

    function displayJobTitles(jobs) {
      jobTitlesContainer.innerHTML = '';
      
      jobs.forEach((job, index) => {
        const jobElement = document.createElement('div');
        jobElement.className = 'job-title-item';
        jobElement.innerHTML = `
          <div class="job-title-header">
            <h4 class="job-title-name" data-field="title" data-index="${index}">${escapeHtml(job.title)}</h4>
          </div>
          <p class="job-company" data-field="company" data-index="${index}">${escapeHtml(job.company)}</p>
          ${job.dates ? `<p class="job-dates" data-field="dates" data-index="${index}">${escapeHtml(job.dates)}</p>` : ''}
        `;
        
        // Add click listeners for editing
        const editableFields = jobElement.querySelectorAll('[data-field]');
        editableFields.forEach(field => {
          field.style.cursor = 'pointer';
          field.addEventListener('click', () => editJobField(field, index));
        });
        
        jobTitlesContainer.appendChild(jobElement);
      });

      jobTitlesEmpty.style.display = 'none';
    }

    function showJobTitlesEmpty() {
      jobTitlesContainer.innerHTML = '';
      jobTitlesEmpty.style.display = 'block';
    }

    function clearJobTitles() {
      // Clear the job titles data
      extractedJobData = [];
      
      // Hide the job titles section
      jobTitlesSection.style.display = 'none';
      
      // Clear the container
      jobTitlesContainer.innerHTML = '';
      
      // Hide loading and empty states
      jobTitlesLoading.style.display = 'none';
      jobTitlesEmpty.style.display = 'none';
      
      // Also clear education when resume is removed
      clearEducation();
    }

    async function saveJobTitlesToFirebase(jobData) {
      if (!currentUser) return;

      try {
        await window.setDoc(window.doc(window.db, 'users', currentUser.uid), {
          jobTitles: jobData,
          lastUpdated: new Date()
        }, { merge: true });
      } catch (error) {
        console.error('Error saving job titles to Firebase:', error);
      }
    }

    async function loadJobTitlesFromFirebase() {
      if (!currentUser) return;

      try {
        const userDoc = await window.getDoc(window.doc(window.db, 'users', currentUser.uid));
        if (userDoc.exists()) {
          const userData = userDoc.data();
          if (userData.jobTitles && userData.jobTitles.length > 0) {
            extractedJobData = userData.jobTitles;
            displayJobTitles(userData.jobTitles);
            jobTitlesSection.style.display = 'block';
          }
          if (userData.education && userData.education.length > 0) {
            extractedEducationData = userData.education;
            displayEducation(userData.education);
            educationSection.style.display = 'block';
          }
        }
      } catch (error) {
        console.error('Error loading job titles from Firebase:', error);
      }
    }

    function displayEducation(education) {
      educationContainer.innerHTML = '';
      
      if (education.length === 0) {
        showEducationEmpty();
        return;
      }
      
      education.forEach((item, index) => {
        const educationElement = document.createElement('div');
        educationElement.className = 'education-item';
        
        // Handle both string and object formats
        let displayText = '';
        if (typeof item === 'string') {
          displayText = item;
        } else if (typeof item === 'object' && item !== null) {
          // Handle old object format for backward compatibility
          if (item.title && item.institution) {
            displayText = `${item.title} from ${item.institution}`;
          } else if (item.title) {
            displayText = item.title;
          } else {
            displayText = JSON.stringify(item);
          }
        } else {
          displayText = String(item);
        }
        
        educationElement.innerHTML = `
          <div class="education-title" data-index="${index}" style="cursor: pointer;">${escapeHtml(displayText)}</div>
        `;
        
        // Add click listener for editing
        const titleElement = educationElement.querySelector('.education-title');
        titleElement.addEventListener('click', () => editEducationField(titleElement, index));
        
        educationContainer.appendChild(educationElement);
      });

      educationEmpty.style.display = 'none';
      educationSection.style.display = 'block';
    }

    function showEducationEmpty() {
      educationContainer.innerHTML = '';
      educationEmpty.style.display = 'block';
      educationSection.style.display = 'block';
    }

    function clearEducation() {
      // Clear the education data
      extractedEducationData = [];
      
      // Hide the education section
      educationSection.style.display = 'none';
      
      // Clear the container
      educationContainer.innerHTML = '';
      
      // Hide loading and empty states
      educationLoading.style.display = 'none';
      educationEmpty.style.display = 'none';
    }

    async function saveEducationToFirebase(educationData) {
      if (!currentUser) return;

      try {
        await window.setDoc(window.doc(window.db, 'users', currentUser.uid), {
          education: educationData,
          lastUpdated: new Date()
        }, { merge: true });
        console.log('Education data saved to Firebase');
      } catch (error) {
        console.error('Error saving education to Firebase:', error);
      }
    }

    function editJobField(element, index) {
      const field = element.dataset.field;
      const currentValue = element.textContent;
      
      // Create input element
      const input = document.createElement('input');
      input.type = 'text';
      input.value = currentValue;
      input.className = 'edit-input';
      input.style.cssText = `
        width: 100%;
        padding: 4px 8px;
        border: 2px solid #007bff;
        border-radius: 4px;
        background: white;
        color: #333;
        font-size: inherit;
        font-family: inherit;
      `;
      
      // Replace element content with input
      element.innerHTML = '';
      element.appendChild(input);
      input.focus();
      input.select();
      
      // Handle save on Enter or blur
      const saveEdit = () => {
        const newValue = input.value.trim();
        if (newValue !== currentValue) {
          // Update the data
          extractedJobData[index][field] = newValue;
          
          // Update the display
          element.innerHTML = escapeHtml(newValue);
          element.style.cursor = 'pointer';
          
          // Save to Firebase
          saveJobTitlesToFirebase(extractedJobData);
        } else {
          // Restore original display
          element.innerHTML = escapeHtml(currentValue);
          element.style.cursor = 'pointer';
        }
      };
      
      // Handle cancel on Escape
      const cancelEdit = () => {
        element.innerHTML = escapeHtml(currentValue);
        element.style.cursor = 'pointer';
      };
      
      input.addEventListener('blur', saveEdit);
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          saveEdit();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          cancelEdit();
        }
      });
    }

    function editEducationField(element, index) {
      const currentValue = element.textContent;
      
      // Create input element
      const input = document.createElement('input');
      input.type = 'text';
      input.value = currentValue;
      input.className = 'edit-input';
      input.style.cssText = `
        width: 100%;
        padding: 4px 8px;
        border: 2px solid #007bff;
        border-radius: 4px;
        background: white;
        color: #333;
        font-size: inherit;
        font-family: inherit;
      `;
      
      // Replace element content with input
      element.innerHTML = '';
      element.appendChild(input);
      input.focus();
      input.select();
      
      // Handle save on Enter or blur
      const saveEdit = () => {
        const newValue = input.value.trim();
        if (newValue !== currentValue) {
          // Update the data
          extractedEducationData[index] = newValue;
          
          // Update the display
          element.innerHTML = escapeHtml(newValue);
          element.style.cursor = 'pointer';
          
          // Save to Firebase
          saveEducationToFirebase(extractedEducationData);
        } else {
          // Restore original display
          element.innerHTML = escapeHtml(currentValue);
          element.style.cursor = 'pointer';
        }
      };
      
      // Handle cancel on Escape
      const cancelEdit = () => {
        element.innerHTML = escapeHtml(currentValue);
        element.style.cursor = 'pointer';
      };
      
      input.addEventListener('blur', saveEdit);
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          saveEdit();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          cancelEdit();
        }
      });
    }

    async function extractJobsFromAllPages(file) {
      if (file.type !== 'application/pdf') {
        // For non-PDF files, use single image processing
        const imageUrl = await convertFileToImage(file);
        return await extractJobsWithChatGPTVision(imageUrl);
      }

      try {
        // Load PDF.js if not already loaded
        await ensurePdfJs();
        
        // Convert PDF to array buffer
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        const pageCount = pdf.numPages;
        
        console.log(`Processing ${pageCount} pages into single image...`);
        
        // Create a single combined image from all pages
        const combinedImageUrl = await createCombinedImageFromPDF(pdf);
        
        // Debug: Uncomment to download combined image
        // downloadCombinedImage(combinedImageUrl);
        
        // Send the combined image to ChatGPT Vision (single API call for both jobs and education)
        const result = await extractJobsAndEducationWithChatGPTVision(combinedImageUrl);
        
        console.log(`Total jobs found: ${result.jobs.length}`);
        console.log(`Total education/certs found: ${result.education.length}`);
        
        // Clean up the combined image
        URL.revokeObjectURL(combinedImageUrl);
        
        return result;
      } catch (error) {
        console.error('Error processing PDF pages:', error);
        throw error;
      }
    }

    async function createCombinedImageFromPDF(pdf) {
      const pageCount = pdf.numPages;
      console.log(`Creating combined image from ${pageCount} pages`);
      
      const allPagesCanvas = document.createElement('canvas');
      const allPagesContext = allPagesCanvas.getContext('2d');
      
      let totalHeight = 0;
      let maxWidth = 0;
      const pageHeights = [];
      
      // First pass: calculate total dimensions and store page heights
      for (let pageNum = 1; pageNum <= pageCount; pageNum++) {
        const page = await pdf.getPage(pageNum);
        const viewport = page.getViewport({ scale: 2.0 });
        pageHeights[pageNum - 1] = viewport.height;
        totalHeight += viewport.height;
        maxWidth = Math.max(maxWidth, viewport.width);
        console.log(`Page ${pageNum}: ${viewport.width}x${viewport.height}`);
      }
      
      // Add gaps between pages
      totalHeight += (pageCount - 1) * 20;
      
      // Set canvas dimensions
      allPagesCanvas.width = maxWidth;
      allPagesCanvas.height = totalHeight;
      console.log(`Combined canvas: ${maxWidth}x${totalHeight}`);
      
      // Fill background with white
      allPagesContext.fillStyle = 'white';
      allPagesContext.fillRect(0, 0, allPagesCanvas.width, allPagesCanvas.height);
      
      // Second pass: render all pages with proper positioning
      let currentY = 0;
      for (let pageNum = 1; pageNum <= pageCount; pageNum++) {
        console.log(`Rendering page ${pageNum} at Y position: ${currentY}`);
        
        const page = await pdf.getPage(pageNum);
        const viewport = page.getViewport({ scale: 2.0 });
        
        // Save the current context state
        allPagesContext.save();
        
        // Translate to the correct position
        allPagesContext.translate(0, currentY);
        
        const renderContext = {
          canvasContext: allPagesContext,
          viewport: viewport
        };
        
        await page.render(renderContext).promise;
        
        // Restore the context state
        allPagesContext.restore();
        
        // Move to next page position
        currentY += viewport.height + 20; // Add 20px gap between pages
      }
      
      return allPagesCanvas.toDataURL('image/png');
    }

    function downloadCombinedImage(imageUrl) {
      // Create a download link for the combined image
      const link = document.createElement('a');
      link.href = imageUrl;
      link.download = 'combined-resume-pages.png';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      console.log('Combined image downloaded for debugging');
    }


    async function extractJobsWithChatGPTVision(imageUrl) {
      try {
        // Convert data URL to base64
        const base64Image = imageUrl.split(',')[1];
        
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${AI_CONFIG.apiKey}`
          },
          body: JSON.stringify({
            model: 'gpt-4o',
            messages: [
              {
                role: 'user',
                content: [
                  {
                    type: 'text',
                    text: `Analyze this resume image and extract all job titles, companies, and employment dates. Return ONLY a JSON array in this exact format:
[
  {
    "title": "Job Title",
    "company": "Company Name", 
    "dates": "Start Date - End Date"
  }
]

Look for the Work Experience or Employment section and extract each job entry. If no job information is found, return an empty array [].`
                  },
                  {
                    type: 'image_url',
                    image_url: {
                      url: `data:image/png;base64,${base64Image}`
                    }
                  }
                ]
              }
            ],
            max_tokens: 1000,
            temperature: 0.1
          })
        });

        if (!response.ok) {
          throw new Error(`OpenAI API error: ${response.status}`);
        }

        const data = await response.json();
        const content = data.choices[0].message.content.trim();
        
        console.log('ChatGPT Vision response:', content);
        
        // Extract JSON from response
        const jsonMatch = content.match(/\[[\s\S]*\]/);
        if (jsonMatch) {
          return JSON.parse(jsonMatch[0]);
        }
        
        return [];
      } catch (error) {
        console.error('ChatGPT Vision extraction error:', error);
        return [];
      }
    }

    async function extractJobsAndEducationWithChatGPTVision(imageUrl) {
      try {
        // Convert data URL to base64
        const base64Image = imageUrl.split(',')[1];
        
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${AI_CONFIG.apiKey}`
          },
          body: JSON.stringify({
            model: 'gpt-4o',
            messages: [
              {
                role: 'user',
                content: [
                  {
                    type: 'text',
                    text: `Analyze this resume image and extract both job information and education/certifications. Return ONLY a JSON object in this exact format:

{
  "jobs": [
    {
      "title": "Job Title",
      "company": "Company Name", 
      "dates": "Start Date - End Date"
    }
  ],
  "education": [
    "Bachelor of Science in Computer Science from University of California",
    "AWS Certified Solutions Architect",
    "Google Analytics Certification"
  ]
}

For jobs: Look for Work Experience or Employment section and extract each job entry.
For education: Extract degrees, certifications, and training as simple one-liners. For degrees, use format "[Degree Name] from [Institution]". For certifications, just list the certification name.

If no information is found in a category, return an empty array for that category.`
                  },
                  {
                    type: 'image_url',
                    image_url: {
                      url: `data:image/png;base64,${base64Image}`
                    }
                  }
                ]
              }
            ],
            max_tokens: 1500,
            temperature: 0.1
          })
        });

        if (!response.ok) {
          throw new Error(`OpenAI API error: ${response.status}`);
        }

        const data = await response.json();
        const content = data.choices[0].message.content.trim();
        
        console.log('ChatGPT Vision combined response:', content);
        
        // Extract JSON from response
        const jsonMatch = content.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
          const result = JSON.parse(jsonMatch[0]);
          return {
            jobs: result.jobs || [],
            education: result.education || []
          };
        }
        
        return { jobs: [], education: [] };
      } catch (error) {
        console.error('ChatGPT Vision combined extraction error:', error);
        return { jobs: [], education: [] };
      }
    }

    async function extractJobsWithChatGPT(text) {
      try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${AI_CONFIG.apiKey}`
          },
          body: JSON.stringify({
            model: AI_CONFIG.model,
            messages: [
              {
                role: 'system',
                content: `You are a resume parser. Extract job titles, companies, and employment dates from the provided resume text. Return ONLY a JSON array in this exact format:
[
  {
    "title": "Job Title",
    "company": "Company Name", 
    "dates": "Start Date - End Date"
  }
]

If no job information is found, return an empty array [].`
              },
              {
                role: 'user',
                content: `Extract job information from this resume text:\n\n${text}`
              }
            ],
            max_tokens: 1000,
            temperature: 0.3
          })
        });

        if (!response.ok) {
          throw new Error(`OpenAI API error: ${response.status}`);
        }

        const data = await response.json();
        const content = data.choices[0].message.content.trim();
        
        // Extract JSON from response
        const jsonMatch = content.match(/\[[\s\S]*\]/);
        if (jsonMatch) {
          return JSON.parse(jsonMatch[0]);
        }
        
        return [];
      } catch (error) {
        console.error('ChatGPT job extraction error:', error);
        return [];
      }
    }

    // ChatGPT Integration Functions
    async function generateResumeWithAI(jobDescription, userJobData = [], userEducationData = []) {
      try {
        // Get user's personal info from the form
        const personalInfo = {
          name: document.getElementById('personalName').value || 'John Doe',
          address: document.getElementById('personalAddress').value || 'City, State',
          email: document.getElementById('personalEmail').value || 'email@example.com',
          phone: document.getElementById('personalPhone').value || '(555) 123-4567'
        };

        // Create enhanced system prompt that uses user's existing job data and education
        const enhancedSystemPrompt = `You are an AI Resume Generator that creates professional, ATS-optimized resumes based on job descriptions. Follow these comprehensive rules:

## CRITICAL PRESERVATION RULES (DO NOT CHANGE):
- Use EXACTLY the job titles, companies, and employment dates from user's history
- Use EXACTLY the contact information provided
- Include ALL education/certificates from user's data (not just relevant ones)
- NEVER fabricate experience, credentials, or dates
- **MANDATORY: Include EVERY SINGLE job from the user's job history - do not skip any jobs**
- **MANDATORY: The jobs array must contain ALL jobs provided in the user data, not just a subset**

## OPTIMIZATION RULES (REWRITE THESE):
- Write a professional summary that is 2-3 sentences long and mentions ALL job titles from the user's work history
- Show career progression by referencing each role in the summary
- Rewrite job duties/responsibilities to highlight relevant technologies and outcomes
- Optimize skills section using keywords from job description
- Use strong action verbs ("Led," "Developed," "Integrated," "Implemented")
- Make each bullet point results-oriented with quantifiable achievements
- Ensure 70-90% alignment with job description terminology
- Integrate keywords naturally, never keyword-stuff

## PROCESS TO FOLLOW:

### Step 1: Analyze Job Description
- Extract required technical skills (languages, frameworks, tools)
- Extract integration areas (system, data, cloud, microservices, ERP, etc.)
- Extract security/compliance needs (GDPR, IAM, CyberArk, etc.)
- Extract behavioral traits (collaboration, testing, debugging, problem-solving)
- Identify ATS keywords from the posting

### Step 2: Map Resume to Job Description
- For each past role, rewrite duties to highlight relevant technologies
- Emphasize integration, automation, and monitoring
- Frame achievements in terms of outcomes (efficiency, compliance, performance)

### Step 3: Rewrite Resume
- Use strong action verbs and results-oriented language
- Ensure maximum alignment with job description terminology
- Keep bullet points concise and ATS-friendly

### Step 4: Skills Section
- Create Technical Skills using job description keywords
- Add Soft Skills (collaboration, problem-solving, communication)
- Ensure skills cover all critical technologies from posting

## USER DATA:

Personal Information:
${JSON.stringify(personalInfo, null, 2)}

Existing Job History:
${userJobData.length > 0 ? JSON.stringify(userJobData, null, 2) : 'No existing job data provided - create a new resume'}

ALL Education/Certificates (include every single one):
${userEducationData.length > 0 ? JSON.stringify(userEducationData, null, 2) : 'No existing education data provided'}

## OUTPUT FORMAT:
Return ONLY a valid JSON object in this exact format:
{
  "contact": {
    "name": "${personalInfo.name}",
    "address": "${personalInfo.address}",
    "email": "${personalInfo.email}",
    "phone": "${personalInfo.phone}"
  },
  "jobs": [
    {
      "title": "EXACT job title from user's history",
      "company": "EXACT company from user's history", 
      "location": "City, State",
      "startDate": "EXACT start date from user's history",
      "endDate": "EXACT end date from user's history",
      "duties": ["Optimized duty 1", "Optimized duty 2", "Optimized duty 3"]
    }
    // IMPORTANT: Include ALL jobs from user's history, not just a subset
  ],
  "skills": {
    "Technical Skills": ["Skill 1", "Skill 2", "Skill 3"],
    "Soft Skills": ["Skill 1", "Skill 2", "Skill 3"]
  },
  "certificates": [
    {"name": "EXACT education/certification 1 from user's data"},
    {"name": "EXACT education/certification 2 from user's data"},
    {"name": "EXACT education/certification 3 from user's data"}
  ]
}

## VALIDATION CHECKLIST:
- All job titles, companies, and dates match the original resume exactly
- ALL education/certificates from user's data are included
- **VERIFIED: ALL jobs from user's history are included in the jobs array**
- No false information was added
- Job duties rewritten to strongly align with target job description
- Skills list covers critical technologies from posting
- Resume is ATS-optimized and professional

**CRITICAL: Generate resume using ALL job experiences from the user's existing job data. Do not skip or omit any jobs. Include ALL education/certificates. Make the resume compelling and perfectly tailored to the job description.

IMPORTANT: Return ONLY valid JSON. Do not include any text, explanations, or formatting outside the JSON object. No emojis, no "System" messages, no additional text. Just the JSON object.`;

        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${AI_CONFIG.apiKey}`
          },
          body: JSON.stringify({
            model: AI_CONFIG.model,
            messages: [
              {
                role: 'system',
                content: enhancedSystemPrompt
              },
              {
                role: 'user',
                content: `Generate a professional resume based on this job description:\n\n${jobDescription}`
              }
            ],
            max_tokens: AI_CONFIG.maxTokens,
            temperature: AI_CONFIG.temperature
          })
        });

        if (!response.ok) {
          throw new Error(`OpenAI API error: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        const generatedContent = data.choices[0].message.content.trim();
        
        // Extract JSON from the response (in case there's extra text)
        const jsonMatch = generatedContent.match(/\{[\s\S]*\}/);
        if (!jsonMatch) {
          console.error('AI Response:', generatedContent);
          throw new Error('No valid JSON found in AI response');
        }
        
        let resumeJson;
        try {
          resumeJson = JSON.parse(jsonMatch[0]);
        } catch (parseError) {
          console.error('JSON Parse Error:', parseError);
          console.error('Raw JSON:', jsonMatch[0]);
          throw new Error('Failed to parse AI response as JSON');
        }
        
        // Ensure required fields exist with defaults
        if (!resumeJson.contact) {
          resumeJson.contact = {
            name: personalInfo.name,
            address: personalInfo.address,
            email: personalInfo.email,
            phone: personalInfo.phone
          };
        }
        
        if (!resumeJson.jobs) resumeJson.jobs = [];
        if (!resumeJson.skills) resumeJson.skills = {};
        if (!resumeJson.education) resumeJson.education = [];
        if (!resumeJson.certificates) resumeJson.certificates = [];
        if (!resumeJson.summary) resumeJson.summary = "Experienced professional with strong technical skills and proven track record of success.";
        
        return resumeJson;
      } catch (error) {
        console.error('AI generation error:', error);
        throw error;
      }
    }

    function showAIProgress() {
      aiProgress.style.display = 'block';
      generateResumeFromJob.disabled = true;
      generateResumeFromJob.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    }

    function hideAIProgress() {
      aiProgress.style.display = 'none';
      generateResumeFromJob.disabled = false;
      generateResumeFromJob.innerHTML = '<i class="fas fa-magic"></i> Generate Resume';
    }

    function updateAIProgress(percentage, text) {
      aiProgressFill.style.width = `${percentage}%`;
      aiProgressText.textContent = text;
    }

    // Job Description Modal Event Listeners
    generateResumeBtn.addEventListener('click', () => {
      jobDescriptionModal.classList.add('active');
      jobDescriptionInput.focus();
    });

    closeJobDescriptionModal.addEventListener('click', closeJobDescriptionModalFunc);
    cancelJobDescription.addEventListener('click', closeJobDescriptionModalFunc);

    jobDescriptionModal.addEventListener('click', (e) => {
      if (e.target === jobDescriptionModal) {
        closeJobDescriptionModalFunc();
      }
    });

    function closeJobDescriptionModalFunc() {
      jobDescriptionModal.classList.remove('active');
      jobDescriptionInput.value = '';
      hideAIProgress();
    }

    generateResumeFromJob.addEventListener('click', async () => {
      const jobDescription = jobDescriptionInput.value.trim();
      if (!jobDescription) {
        showPreviewError('Please enter a job description');
        return;
      }

      try {
        showAIProgress();
        updateAIProgress(20, 'Analyzing job description...');
        
        // Generate resume with AI using user's existing job data
        const generatedResume = await generateResumeWithAI(jobDescription, extractedJobData, extractedEducationData);
        
        updateAIProgress(60, 'Processing generated resume...');
        
        // Update resume data
        resumeData = generatedResume;
        
        // Update personal info form fields
        if (personalName) personalName.value = generatedResume.contact.name;
        if (personalAddress) personalAddress.value = generatedResume.contact.address;
        if (personalEmail) personalEmail.value = generatedResume.contact.email;
        if (personalPhone) personalPhone.value = generatedResume.contact.phone;
        
        updateAIProgress(80, 'Rendering resume preview...');
        
        // Render the resume
        renderResume(resumeData);
        updatePreviewStatus('loaded', 'AI-generated resume loaded successfully');
        downloadJsonBtn.disabled = false;
        
        updateAIProgress(100, 'Generating PDF...');
        generatePDFandStore();
        
        // Close modal after a brief delay
        setTimeout(() => {
          closeJobDescriptionModalFunc();
          updateAIProgress(0, '');
        }, 1000);
        
      } catch (error) {
        console.error('Resume generation failed:', error);
        hideAIProgress();
        showPreviewError(`Failed to generate resume: ${error.message}`);
      }
    });

    // Initialize authentication when page loads
    document.addEventListener('DOMContentLoaded', () => {
      // Wait for Firebase to be available
      const checkFirebase = () => {
        if (window.auth && window.onAuthStateChanged) {
          initializeAuth();
        } else {
          setTimeout(checkFirebase, 100);
        }
      };
      checkFirebase();
      
      // Initialize personal info listeners
      addPersonalInfoListeners();
    });

    // Settings functionality
    function initializeSettings() {
      const settings = [
        { id: 'nameSize', cssVar: '--name-size', suffix: 'px' },
        { id: 'contactSize', cssVar: '--contact-size', suffix: 'px' },
        { id: 'nameTopPadding', cssVar: '--name-top-padding', suffix: 'px' },
        { id: 'jobTitleSize', cssVar: '--job-title-size', suffix: 'px' },
        { id: 'companySize', cssVar: '--company-size', suffix: 'px' },
        { id: 'companyDetailsSize', cssVar: '--company-details-size', suffix: 'px' },
        { id: 'bulletSize', cssVar: '--bullet-size', suffix: 'px' },
        { id: 'jobPaddingTop', cssVar: '--job-padding-top', suffix: 'px' },
        { id: 'jobPaddingBottom', cssVar: '--job-padding-bottom', suffix: 'px' }
      ];

      settings.forEach(setting => {
        const slider = document.getElementById(setting.id);
        const valueDisplay = document.getElementById(setting.id + 'Value');
        
        if (slider && valueDisplay) {
          // Update display value
          valueDisplay.textContent = slider.value + setting.suffix;
          
          // Handle slider change
          slider.addEventListener('input', function() {
            const value = this.value + setting.suffix;
            valueDisplay.textContent = value;
            document.documentElement.style.setProperty(setting.cssVar, value);
            
            // Re-render resume if data is loaded
            if (resumeData) {
              renderResume(resumeData);
              generatePDFandStore();
            }
          });
        }
      });
    }

    // Initialize settings when page loads
    document.addEventListener('DOMContentLoaded', () => {
      initializeSettings();
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && jsonModal.classList.contains('active')) {
        closeJsonModal();
      }
    });
  </script>
</body>
</html>
