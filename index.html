<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resume Builder Pro</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --primary-color: #6366f1;
      --primary-hover: #4f46e5;
      --secondary-color: #10b981;
      --secondary-hover: #059669;
      --background: #0f172a;
      --surface: #1e293b;
      --surface-light: #334155;
      --text-primary: #f8fafc;
      --text-secondary: #cbd5e1;
      --text-muted: #64748b;
      --border: #334155;
      --border-light: #475569;
      --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      --radius: 12px;
      --radius-lg: 16px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--background);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      text-align: center;
      margin-bottom: 3rem;
      animation: fadeInDown 0.8s ease-out;
    }

    .header h1 {
      font-size: 3rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
    }

    .header p {
      color: var(--text-secondary);
      font-size: 1.1rem;
      font-weight: 400;
    }

    /* Main Content */
    .main-content {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 2rem;
      flex: 1;
    }

    /* Controls Panel */
    .controls-panel {
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 2rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      height: fit-content;
      animation: fadeInLeft 0.8s ease-out 0.2s both;
    }

    .controls-panel h2 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      color: var(--text-primary);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: var(--radius);
      font-family: inherit;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      width: 100%;
      justify-content: center;
      margin-bottom: 1rem;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .btn-secondary {
      background: var(--secondary-color);
      color: white;
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--secondary-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    /* Settings Section */
    .settings-section {
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border);
    }

    .settings-section h3 {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--text-primary);
    }

    .setting-group {
      margin-bottom: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .setting-group label {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 0.25rem;
    }

    .setting-slider {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: var(--surface-light);
      outline: none;
      -webkit-appearance: none;
      appearance: none;
      cursor: pointer;
    }

    .setting-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--primary-color);
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      transition: all 0.2s ease;
    }

    .setting-slider::-webkit-slider-thumb:hover {
      background: var(--primary-hover);
      transform: scale(1.1);
    }

    .setting-slider::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--primary-color);
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .setting-value {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--primary-color);
      text-align: center;
      background: rgba(99, 102, 241, 0.1);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      min-width: 50px;
      display: inline-block;
    }

    /* OCR Progress Styles */
    .progress-container {
      margin-top: 1rem;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--surface-light);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 0.5rem;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      width: 0%;
      transition: width 0.3s ease;
    }

    .progress-text {
      font-size: 0.85rem;
      color: var(--text-secondary);
      text-align: center;
    }

    /* JSON Input Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease-out;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 2rem;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border);
      animation: slideInUp 0.3s ease-out;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .modal-header h3 {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .close-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.5rem;
      border-radius: var(--radius);
      transition: all 0.2s ease;
    }

    .close-btn:hover {
      background: var(--surface-light);
      color: var(--text-primary);
    }

    .json-input {
      width: 100%;
      min-height: 300px;
      background: var(--background);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem;
      color: var(--text-primary);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
      line-height: 1.5;
      resize: vertical;
      transition: border-color 0.2s ease;
    }

    .json-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .modal-actions {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .modal-actions .btn {
      margin-bottom: 0;
      flex: 1;
    }

    /* Resume Preview */
    .preview-container {
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 2rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      animation: fadeInRight 0.8s ease-out 0.4s both;
    }

    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .preview-header h2 {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .preview-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: var(--radius);
      font-size: 0.9rem;
      font-weight: 500;
    }

    .status-empty {
      background: rgba(100, 116, 139, 0.2);
      color: var(--text-muted);
    }

    .status-loaded {
      background: rgba(16, 185, 129, 0.2);
      color: var(--secondary-color);
    }

    .status-error {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .resume-preview {
      background: white;
      color: #1f2937;
      padding: var(--name-top-padding, 1rem) 3rem 3rem 3rem;
      border-radius: var(--radius);
      min-height: 800px;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
      font-size: 14px;
      line-height: 1.6;
      position: relative;
      overflow: hidden;
    }

    .resume-preview::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
    }
    
    /* Clean export: remove visual chrome during PDF render */
    .resume-preview.export-clean {
      box-shadow: none !important;
      border-radius: 0 !important;
    }
    .resume-preview.export-clean::before {
      display: none !important;
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 400px;
      color: var(--text-muted);
      text-align: center;
    }

    .empty-state i {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-secondary);
    }

    .empty-state p {
      font-size: 0.95rem;
      max-width: 300px;
    }

    /* Resume Styling */
    .resume-header {
      text-align: center;
      font-size: var(--name-size, 24px);
      font-weight: 700;
      margin-bottom: 4px;
      letter-spacing: 0.5px;
      color: #1f2937;
    }

    .resume-contact {
      text-align: center;
      font-size: var(--contact-size, 14px);
      font-weight: 500;
      margin-bottom: 12px;
      color: #4b5563;
    }

    .resume-divider {
      border: none;
      border-top: 2px solid #1f2937;
      margin: 8px 0 12px 0;
      width: 100%;
    }

    .section-title {
      font-size: 18px;
      font-weight: 700;
      text-align: center;
      text-decoration: underline;
      margin: 0 0 20px 0;
      letter-spacing: 0.2px;
      color: #1f2937;
    }
    
    .resume-preview .resume-divider + .section-title {
      margin-top: 0;
    }
    
    .resume-preview .section-title:first-of-type {
      margin-top: 0;
    }

    .job-title {
      font-weight: 700;
      font-size: var(--job-title-size, 16px);
      margin-top: 12px;
      margin-bottom: 4px;
      color: #1f2937;
    }

    .section {
      margin-bottom: 20px;
      padding-top: var(--job-padding-top, 10px);
    }
    
    .first-job-section {
      padding-top: 3px !important;
    }
    
    .last-job-section {
      padding-bottom: var(--job-padding-bottom, 10px);
    }
    


    .company-row {
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 4px;
    }

    .company {
      font-weight: 600;
      font-size: var(--company-size, 14px);
      color: #374151;
    }

    .company-details {
      font-size: var(--company-details-size, 12px);
      color: #6b7280;
    }

    .job-list {
      margin: 0 0 0 24px;
    }

    .job-list li {
      font-size: var(--bullet-size, 12px);
      margin-bottom: 8px;
      line-height: 1.6;
      color: #374151;
    }

    .cert-list {
      margin: 0 0 0 24px;
    }

    .cert-list li {
      font-size: 13px;
      margin-bottom: 6px;
      font-weight: 600;
      color: #374151;
    }

    /* Skills Section Styles */
    .skills-section {
      margin-bottom: 20px;
    }

    .skill-category {
      margin-bottom: 12px;
      display: flex;
      align-items: baseline;
      gap: 10px;
    }

    .skill-category-title {
      font-weight: 600;
      font-size: var(--bullet-size, 12px);
      color: #374151;
      flex-shrink: 0;
    }

    .skill-list {
      flex: 1;
      font-size: var(--bullet-size, 12px);
      color: #374151;
      line-height: 1.4;
    }

    .skill-item {
      display: inline;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .skill-item:hover {
      background-color: rgba(99, 102, 241, 0.1);
      border-radius: 4px;
      padding: 2px 4px;
      margin: 0 -4px;
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInLeft {
      from {
        opacity: 0;
        transform: translateX(-30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes fadeInRight {
      from {
        opacity: 0;
        transform: translateX(30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
      .main-content {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }
      
      .controls-panel {
        order: 2;
      }
      
      .preview-container {
        order: 1;
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .modal {
        padding: 1.5rem;
        width: 95%;
      }
      
      .resume-preview {
        padding: 2rem;
      }
    }

    @media print {
      body, .container, .resume-preview {
        box-shadow: none !important;
        background: white !important;
        color: black !important;
      }
      .controls-panel, .modal-overlay {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>Resume Builder Pro</h1>
      <p>Create professional resumes with ease</p>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Controls Panel -->
      <div class="controls-panel">
        <h2>Controls</h2>
        <button class="btn btn-primary" id="importJsonBtn">
          <i class="fas fa-upload"></i>
          Import JSON Data
        </button>
        <button class="btn btn-secondary" id="downloadPdfBtn" disabled>
          <i class="fas fa-file-pdf"></i>
          Download PDF
        </button>
        <button class="btn btn-secondary" id="downloadOcrPdfBtn" disabled>
          <i class="fas fa-search"></i>
          Download OCR PDF
        </button>
        <button class="btn btn-secondary" id="downloadJsonBtn" disabled>
          <i class="fas fa-download"></i>
          Download JSON
        </button>
        
        <!-- Settings Section -->
        <div class="settings-section">
          <h3>Font Sizes</h3>
          
          <div class="setting-group">
            <label for="nameSize">Name Font Size (px)</label>
            <input type="range" id="nameSize" min="18" max="36" value="24" class="setting-slider">
            <span class="setting-value" id="nameSizeValue">24px</span>
          </div>
          
          <div class="setting-group">
            <label for="contactSize">Contact Info Font Size (px)</label>
            <input type="range" id="contactSize" min="10" max="20" value="14" class="setting-slider">
            <span class="setting-value" id="contactSizeValue">14px</span>
          </div>
          
          <div class="setting-group">
            <label for="jobTitleSize">Job Title Font Size (px)</label>
            <input type="range" id="jobTitleSize" min="12" max="24" value="16" class="setting-slider">
            <span class="setting-value" id="jobTitleSizeValue">16px</span>
          </div>
          
          <div class="setting-group">
            <label for="companySize">Company Name Font Size (px)</label>
            <input type="range" id="companySize" min="10" max="20" value="14" class="setting-slider">
            <span class="setting-value" id="companySizeValue">14px</span>
          </div>
          
          <div class="setting-group">
            <label for="companyDetailsSize">Company Details Font Size (px)</label>
            <input type="range" id="companyDetailsSize" min="8" max="16" value="12" class="setting-slider">
            <span class="setting-value" id="companyDetailsSizeValue">12px</span>
          </div>
          
          <div class="setting-group">
            <label for="bulletSize">Bullet Points Font Size (px)</label>
            <input type="range" id="bulletSize" min="8" max="16" value="12" class="setting-slider">
            <span class="setting-value" id="bulletSizeValue">12px</span>
          </div>
        </div>
        
        <div class="settings-section">
          <h3>Spacing & Padding</h3>
          
          <div class="setting-group">
            <label for="nameTopPadding">Name Top Padding (px)</label>
            <input type="range" id="nameTopPadding" min="0" max="50" value="16" class="setting-slider">
            <span class="setting-value" id="nameTopPaddingValue">16px</span>
          </div>
          
          <div class="setting-group">
            <label for="jobPaddingTop">Job Entry Top Padding (px)</label>
            <input type="range" id="jobPaddingTop" min="0" max="30" value="10" class="setting-slider">
            <span class="setting-value" id="jobPaddingTopValue">10px</span>
          </div>
          
          <div class="setting-group">
            <label for="jobPaddingBottom">Last Job Bottom Padding (px)</label>
            <input type="range" id="jobPaddingBottom" min="0" max="30" value="10" class="setting-slider">
            <span class="setting-value" id="jobPaddingBottomValue">10px</span>
          </div>
        </div>
        
        <!-- OCR Progress Section -->
        <div class="settings-section" id="ocrProgressSection" style="display: none;">
          <h3>OCR Processing</h3>
          <div class="progress-container">
            <div class="progress-bar">
              <div class="progress-fill" id="ocrProgressFill"></div>
            </div>
            <div class="progress-text" id="ocrProgressText">Processing...</div>
          </div>
        </div>
      </div>

      <!-- Preview Container -->
      <div class="preview-container">
        <div class="preview-header">
          <h2>Resume Preview</h2>
          <div class="preview-status status-empty" id="previewStatus">
            <i class="fas fa-info-circle"></i>
            No data loaded
          </div>
        </div>
        
    <div id="resumePreview" class="resume-preview">
          <div class="empty-state">
            <i class="fas fa-file-alt"></i>
            <h3>Ready to build your resume?</h3>
            <p>Click "Import JSON Data" to get started with your resume information.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JSON Input Modal -->
  <div class="modal-overlay" id="jsonModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Import Resume Data</h3>
        <button class="close-btn" id="closeModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div>
        <label for="jsonInput" style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-weight: 500;">
          Paste your JSON data below:
        </label>
        <textarea 
          id="jsonInput" 
          class="json-input" 
          placeholder='{
  "contact": {
    "name": "Your Name",
    "email": "your.email@example.com",
    "phone": "(555) 123-4567",
    "address": "City, State"
  },
  "jobs": [
    {
      "title": "Job Title",
      "company": "Company Name",
      "location": "Location",
      "startDate": "Jan 2023",
      "endDate": "Present",
      "duties": ["Responsibility 1", "Responsibility 2"]
    }
  ],
  "skills": {
    "Languages & Frameworks": ["JavaScript", "Python", "React"],
    "Databases": ["MySQL", "PostgreSQL"],
    "Tools": ["Git", "Docker", "AWS"]
  },
  "certificates": [
    {"name": "Certificate Name"}
  ]
}'
        ></textarea>
      </div>
      
      <div class="modal-actions">
        <button class="btn btn-secondary" id="cancelImport">Cancel</button>
        <button class="btn btn-primary" id="confirmImport">Import Data</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- OCR Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

  <script>
    let resumeData = null;
    let pdfBlobUrl = null;

    // Elements
    const importJsonBtn = document.getElementById('importJsonBtn');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');
    const downloadOcrPdfBtn = document.getElementById('downloadOcrPdfBtn');
    const downloadJsonBtn = document.getElementById('downloadJsonBtn');
    const preview = document.getElementById('resumePreview');
    const previewStatus = document.getElementById('previewStatus');
    const jsonModal = document.getElementById('jsonModal');
    const jsonInput = document.getElementById('jsonInput');
    const closeModal = document.getElementById('closeModal');
    const ocrProgressSection = document.getElementById('ocrProgressSection');
    const ocrProgressFill = document.getElementById('ocrProgressFill');
    const ocrProgressText = document.getElementById('ocrProgressText');
    const cancelImport = document.getElementById('cancelImport');
    const confirmImport = document.getElementById('confirmImport');

    // Modal Controls
    importJsonBtn.addEventListener('click', () => {
      jsonModal.classList.add('active');
      jsonInput.focus();
    });

    closeModal.addEventListener('click', closeJsonModal);
    cancelImport.addEventListener('click', closeJsonModal);

    jsonModal.addEventListener('click', (e) => {
      if (e.target === jsonModal) {
        closeJsonModal();
      }
    });

    function closeJsonModal() {
      jsonModal.classList.remove('active');
      jsonInput.value = '';
    }

    // Import JSON Data
    confirmImport.addEventListener('click', () => {
      const jsonText = jsonInput.value.trim();
      if (!jsonText) {
        showError('Please enter JSON data');
        return;
      }

      try {
        resumeData = JSON.parse(jsonText);
          renderResume(resumeData);
        updatePreviewStatus('loaded', 'Data loaded successfully');
        downloadJsonBtn.disabled = false;
        generatePDFandStore();
        closeJsonModal();
      } catch (err) {
        showError('Invalid JSON format. Please check your data.');
        console.error('JSON Parse Error:', err);
      }
    });

    function showError(message) {
      updatePreviewStatus('error', message);
      preview.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-exclamation-triangle"></i>
          <h3>Error</h3>
          <p>${message}</p>
        </div>
      `;
      downloadJsonBtn.disabled = true;
      downloadPdfBtn.disabled = true;
      downloadOcrPdfBtn.disabled = true;
    }

    function updatePreviewStatus(type, message) {
      previewStatus.className = `preview-status status-${type}`;
      previewStatus.innerHTML = `
        <i class="fas fa-${type === 'loaded' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
        ${message}
      `;
    }

    // JSON Download
    downloadJsonBtn.addEventListener('click', () => {
      if (!resumeData) return;
      const blob = new Blob([JSON.stringify(resumeData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'resume-data.json';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 0);
    });

    // PDF Download
    downloadPdfBtn.addEventListener('click', () => {
      if (!pdfBlobUrl) return;
      const a = document.createElement('a');
      a.href = pdfBlobUrl;
      const personName = resumeData?.contact?.name || 'resume';
      const cleanName = personName.replace(/[^a-zA-Z0-9\s-]/g, '').replace(/\s+/g, '-');
      a.download = `${cleanName}-Resume.pdf`;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
      }, 0);
    });

    // OCR PDF Download
    downloadOcrPdfBtn.addEventListener('click', async () => {
      if (!pdfBlobUrl) return;
      
      try {
        downloadOcrPdfBtn.disabled = true;
        ocrProgressSection.style.display = 'block';
        
        // Fetch the PDF blob
        const response = await fetch(pdfBlobUrl);
        const pdfBlob = await response.blob();
        
        // Convert blob to array buffer
        const arrayBuffer = await pdfBlob.arrayBuffer();
        
        // Process with OCR
        const ocrPdfBlob = await processPdfWithOCR(arrayBuffer);
        
        // Download the OCR PDF with person's name
        const url = URL.createObjectURL(ocrPdfBlob);
        const a = document.createElement('a');
        a.href = url;
        const personName = resumeData?.contact?.name || 'resume';
        const cleanName = personName.replace(/[^a-zA-Z0-9\s-]/g, '').replace(/\s+/g, '-');
        a.download = `${cleanName}-Resume.pdf`;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 0);
        
      } catch (error) {
        console.error('OCR processing failed:', error);
        alert('OCR processing failed. Please try again.');
      } finally {
        downloadOcrPdfBtn.disabled = false;
        ocrProgressSection.style.display = 'none';
        ocrProgressFill.style.width = '0%';
      }
    });

    // Date parsing helper function
    function parseDate(dateString) {
      if (!dateString) return new Date(0);
      
      // Handle "Present" or current job
      if (dateString.toLowerCase() === 'present') {
        return new Date();
      }
      
      // Handle various date formats
      const months = {
        'jan': 0, 'january': 0, 'feb': 1, 'february': 1, 'mar': 2, 'march': 2,
        'apr': 3, 'april': 3, 'may': 4, 'jun': 5, 'june': 5, 'jul': 6, 'july': 6,
        'aug': 7, 'august': 7, 'sep': 8, 'september': 8, 'oct': 9, 'october': 9,
        'nov': 10, 'november': 10, 'dec': 11, 'december': 11
      };
      
      // Try to parse common formats
      const parts = dateString.toLowerCase().trim().split(/\s+/);
      
      if (parts.length >= 2) {
        const month = months[parts[0]];
        const year = parseInt(parts[1]);
        
        if (month !== undefined && !isNaN(year)) {
          return new Date(year, month, 1);
        }
      }
      
      // Try direct date parsing
      const parsed = new Date(dateString);
      if (!isNaN(parsed.getTime())) {
        return parsed;
      }
      
      // Fallback to current date if parsing fails
      console.warn(`Could not parse date: ${dateString}, using current date`);
      return new Date();
    }

    // Resume Renderer
    function renderResume(data) {
      // Sort jobs by start date (newest first)
      const sortedJobs = [...data.jobs].sort((a, b) => {
        const dateA = parseDate(a.startDate);
        const dateB = parseDate(b.startDate);
        return dateB - dateA; // Descending order (newest first)
      });

  preview.innerHTML = `
        <div class="resume-header" data-editable="contact.name">${escapeHtml(data.contact.name)}</div>
    <div class="resume-contact">
          <span data-editable="contact.address">${escapeHtml(data.contact.address)}</span>
          - <a href="mailto:${escapeHtml(data.contact.email)}" style="color:#4b5563;text-decoration:underline;" data-editable="contact.email">
          ${escapeHtml(data.contact.email)}
        </a>
          - <span data-editable="contact.phone">${escapeHtml(data.contact.phone)}</span>
    </div>
    <hr class="resume-divider">

        <div class="section-title">Work Experience</div>
        ${sortedJobs.map((job, jobIndex) => `
          <div class="section ${jobIndex === 0 ? 'first-job-section' : ''} ${jobIndex === sortedJobs.length - 1 ? 'last-job-section' : ''}">
            <div class="job-title" data-editable="jobs.${jobIndex}.title">${escapeHtml(job.title)}</div>
        <div class="company-row">
              <span class="company" data-editable="jobs.${jobIndex}.company">${escapeHtml(job.company)}</span>
          <span class="company-details">
                - <span data-editable="jobs.${jobIndex}.location">${escapeHtml(job.location)}</span> 
                (<span data-editable="jobs.${jobIndex}.startDate">${escapeHtml(job.startDate)}</span>${job.endDate ? ' - <span data-editable="jobs.' + jobIndex + '.endDate">' + escapeHtml(job.endDate) + '</span>' : ''})
          </span>
        </div>
        <ul class="job-list">
              ${job.duties.map((duty, dutyIndex) => `
                <li data-editable="jobs.${jobIndex}.duties.${dutyIndex}" class="editable-bullet">
                  ${escapeHtml(duty)}
                </li>
              `).join('')}
        </ul>
      </div>
    `).join('')}

    <hr class="resume-divider">

        ${data.skills && Object.keys(data.skills).length > 0 ? `
        <div class="section-title">Technical Skills</div>
        <div class="skills-section">
          ${Object.entries(data.skills).map(([category, skills]) => `
            <div class="skill-category">
              <div class="skill-category-title">${escapeHtml(category)}:</div>
              <div class="skill-list">
                ${skills.map((skill, skillIndex) => `
                  <span class="skill-item" data-editable="skills.${category}.${skillIndex}">${escapeHtml(skill)}</span>
                `).join(', ')}
              </div>
            </div>
          `).join('')}
        </div>
        <hr class="resume-divider">
        ` : ''}

        <div class="section-title">Education/Certificates</div>
    <ul class="cert-list">
          ${data.certificates.map((cert, certIndex) => `
            <li data-editable="certificates.${certIndex}.name" class="editable-bullet">
              ${escapeHtml(cert.name)}
            </li>
          `).join('')}
    </ul>
  `;

      // Add click event listeners for editable elements
      addEditListeners();
    }

    // Add event listeners for editable elements
    function addEditListeners() {
      const editableElements = preview.querySelectorAll('[data-editable]');
      
      editableElements.forEach(element => {
        element.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          const fieldPath = this.getAttribute('data-editable');
          const currentValue = this.textContent.trim();
          
          // Create input field
          const input = document.createElement('input');
          input.type = 'text';
          input.value = currentValue;
          input.className = 'inline-edit-input';
          input.style.cssText = `
            width: 100%;
            padding: 4px 8px;
            border: 2px solid var(--primary-color);
            border-radius: 4px;
            font-family: inherit;
            font-size: inherit;
            background: white;
            color: #1f2937;
            outline: none;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.2);
          `;
          
          // Replace element content with input
          const originalContent = this.innerHTML;
          this.innerHTML = '';
          this.appendChild(input);
          input.focus();
          input.select();
          
          // Handle save on Enter or blur
          const saveEdit = () => {
            const newValue = input.value.trim();
            if (newValue !== currentValue) {
              updateResumeData(fieldPath, newValue);
              renderResume(resumeData);
            } else {
              this.innerHTML = originalContent;
            }
          };
          
          const cancelEdit = () => {
            this.innerHTML = originalContent;
          };
          
          input.addEventListener('blur', saveEdit);
          input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
              e.preventDefault();
              saveEdit();
            } else if (e.key === 'Escape') {
              e.preventDefault();
              cancelEdit();
            }
          });
        });
        
        // Add hover effect
        element.style.cursor = 'pointer';
        element.addEventListener('mouseenter', function() {
          this.style.backgroundColor = 'rgba(99, 102, 241, 0.1)';
          this.style.borderRadius = '4px';
          this.style.padding = '2px 4px';
          this.style.margin = '0 -4px';
        });
        
        element.addEventListener('mouseleave', function() {
          this.style.backgroundColor = '';
          this.style.borderRadius = '';
          this.style.padding = '';
          this.style.margin = '';
        });
      });
    }

    // Update resume data at specific path
    function updateResumeData(path, value) {
      const pathParts = path.split('.');
      let current = resumeData;
      
      // Navigate to the parent object
      for (let i = 0; i < pathParts.length - 1; i++) {
        current = current[pathParts[i]];
      }
      
      // Update the value
      current[pathParts[pathParts.length - 1]] = value;
      
      // Re-generate PDF after update
      generatePDFandStore();
    }

    function escapeHtml(text) {
      return text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // High-DPI, edge-to-edge PDF with no extra chrome
    async function generatePDFandStore() {
      const previewElem = document.getElementById('resumePreview');
      const { jsPDF } = window.jspdf;

      downloadPdfBtn.disabled = true;
      if (pdfBlobUrl) { URL.revokeObjectURL(pdfBlobUrl); pdfBlobUrl = null; }

      // Read computed padding to keep preview and PDF aligned
      const cssPadRaw = getComputedStyle(document.documentElement)
        .getPropertyValue('--name-top-padding').trim();
      const nameTopPadding = parseInt(cssPadRaw || '0', 10) || 0;

      // Enable clean export to drop shadows, radius, top bar if desired
      previewElem.classList.add('export-clean');

      // Target 300 DPI
      const DPI = 300;
      const PX_PER_PT = DPI / 72;

      // Scale so the canvas width is 300-DPI equivalent of current CSS width
      const elemCssWidthPx = previewElem.clientWidth || previewElem.getBoundingClientRect().width;
      const targetPxWidth = Math.max(1, Math.round(elemCssWidthPx * (DPI / 96))); // approximate CSS px to 300-DPI
      const scale = Math.max(1, targetPxWidth / elemCssWidthPx);

      const canvas = await html2canvas(previewElem, {
        scale,
        backgroundColor: '#fff',
        useCORS: true,
        logging: false,
        letterRendering: true
      });

      // Disable clean export after capture
      previewElem.classList.remove('export-clean');

      // Page size exactly matches the rendered canvas, no margins
      const pageWidthPt  = canvas.width  / PX_PER_PT;
      const pageHeightPt = canvas.height / PX_PER_PT;

      const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: [pageWidthPt, pageHeightPt], compress: false });

      // PNG is lossless
      const png = canvas.toDataURL('image/png');
      pdf.addImage(png, 'PNG', 0, 0, pageWidthPt, pageHeightPt, undefined, 'FAST');

  pdfBlobUrl = URL.createObjectURL(pdf.output('blob'));
  downloadPdfBtn.disabled = false;
  downloadOcrPdfBtn.disabled = false;
}

// OCR Processing Functions
async function processPdfWithOCR(pdfArrayBuffer) {
  const scale = 2.0; // Using your preferred scale
  const lang = 'eng';
  
  try {
    // Load PDF with pdf-lib
    const srcDoc = await PDFLib.PDFDocument.load(pdfArrayBuffer);
    const pageCount = srcDoc.getPageCount();
    
    // Create output document
    const outDoc = await PDFLib.PDFDocument.create();
    const helv = await outDoc.embedFont(PDFLib.StandardFonts.Helvetica);
    
    // Copy all pages as vector backgrounds
    const copied = await outDoc.copyPages(srcDoc, Array.from({length: pageCount}, (_,i)=>i));
    
    // Load PDF.js for rendering
    await ensurePdfJs();
    const readerPdf = await window.pdfjsLib.getDocument({ data: pdfArrayBuffer }).promise;
    
    for (let i = 1; i <= pageCount; i++) {
      // Update progress
      const progress = (i / pageCount) * 100;
      ocrProgressFill.style.width = `${progress}%`;
      ocrProgressText.textContent = `Processing page ${i} of ${pageCount}...`;
      
      // Render page to canvas for OCR
      const { canvas, pageWidthPts, pageHeightPts } = await renderPdfPageToCanvas(readerPdf, i, scale);
      const pageOut = outDoc.addPage(copied[i-1]);
      
      // Run OCR on the canvas
      ocrProgressText.textContent = `Running OCR on page ${i}...`;
      const result = await Tesseract.recognize(canvas, lang, { logger: m => {} });
      const words = wordsFromTesseract(result);
      
      // Add hidden text layer
      drawHiddenTextLayer(pageOut, words, canvas.width, canvas.height, pageWidthPts, pageHeightPts, helv);
      
      // Clean up canvas
      canvas.width = 0;
      canvas.height = 0;
    }
    
    ocrProgressText.textContent = 'Packaging OCR PDF...';
    const outBytes = await outDoc.save();
    ocrProgressFill.style.width = '100%';
    ocrProgressText.textContent = 'OCR processing complete!';
    
    return new Blob([outBytes], { type: 'application/pdf' });
    
  } catch (error) {
    console.error('OCR processing error:', error);
    throw error;
  }
}

async function ensurePdfJs() {
  if (window.pdfjsLib) {
    try { 
      window.pdfjsLib.GlobalWorkerOptions.workerSrc ||= 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js'; 
    } catch(e) {}
    return window.pdfjsLib;
  }
  
  // Load pdf.js dynamically
  const script = document.createElement('script');
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
  document.head.appendChild(script);
  
  return new Promise((resolve, reject) => {
    script.onload = () => {
      window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      resolve(window.pdfjsLib);
    };
    script.onerror = reject;
  });
}

async function renderPdfPageToCanvas(pdf, pageNum, ocrScale) {
  const page = await pdf.getPage(pageNum);
  const viewportPts = page.getViewport({ scale: 1 });
  const viewport = page.getViewport({ scale: ocrScale });
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = Math.floor(viewport.width);
  canvas.height = Math.floor(viewport.height);
  await page.render({ canvasContext: ctx, viewport }).promise;
  return { canvas, pageWidthPts: viewportPts.width, pageHeightPts: viewportPts.height };
}

function wordsFromTesseract(result) {
  return (result && result.data && Array.isArray(result.data.words)) ? result.data.words : [];
}

function drawHiddenTextLayer(pageOut, words, canvasWpx, canvasHpx, pageWpts, pageHpts, font) {
  const scaleX = pageWpts / canvasWpx;
  const scaleY = pageHpts / canvasHpx;
  for (const w of words) {
    if (!w || !w.text) continue;
    const b = w.bbox || w.bbox0 || w.boundingBox || {};
    const x0px = (b.x0 ?? b.left ?? 0);
    const y1px = (b.y1 ?? b.bottom ?? ((b.y0 ?? b.top ?? 0) + 10));
    const heightPx = Math.max(1, (b.y1 ?? b.bottom ?? 0) - (b.y0 ?? b.top ?? 0));
    const fontSizePts = Math.max(6, Math.min(48, heightPx * scaleY));
    const xPts = x0px * scaleX;
    const yPts = pageHpts - y1px * scaleY; // convert to PDF coords
    pageOut.drawText(w.text, { x: xPts, y: yPts, size: fontSizePts, font, color: PDFLib.rgb(0,0,0), opacity: 0.01 });
  }
}

    // Settings functionality
    function initializeSettings() {
      const settings = [
        { id: 'nameSize', cssVar: '--name-size', suffix: 'px' },
        { id: 'contactSize', cssVar: '--contact-size', suffix: 'px' },
        { id: 'nameTopPadding', cssVar: '--name-top-padding', suffix: 'px' },
        { id: 'jobTitleSize', cssVar: '--job-title-size', suffix: 'px' },
        { id: 'companySize', cssVar: '--company-size', suffix: 'px' },
        { id: 'companyDetailsSize', cssVar: '--company-details-size', suffix: 'px' },
        { id: 'bulletSize', cssVar: '--bullet-size', suffix: 'px' },
        { id: 'jobPaddingTop', cssVar: '--job-padding-top', suffix: 'px' },
        { id: 'jobPaddingBottom', cssVar: '--job-padding-bottom', suffix: 'px' }
      ];

      settings.forEach(setting => {
        const slider = document.getElementById(setting.id);
        const valueDisplay = document.getElementById(setting.id + 'Value');
        
        if (slider && valueDisplay) {
          // Update display value
          valueDisplay.textContent = slider.value + setting.suffix;
          
          // Handle slider change
          slider.addEventListener('input', function() {
            const value = this.value + setting.suffix;
            valueDisplay.textContent = value;
            document.documentElement.style.setProperty(setting.cssVar, value);
            
            // Re-render resume if data is loaded
            if (resumeData) {
              renderResume(resumeData);
              generatePDFandStore();
            }
          });
        }
      });
    }

    // Initialize settings when page loads
    document.addEventListener('DOMContentLoaded', initializeSettings);

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && jsonModal.classList.contains('active')) {
        closeJsonModal();
      }
    });
  </script>
</body>
</html>
