<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resume Builder Pro</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --primary-color: #6366f1;
      --primary-hover: #4f46e5;
      --secondary-color: #10b981;
      --secondary-hover: #059669;
      --background: #0f172a;
      --surface: #1e293b;
      --surface-light: #334155;
      --text-primary: #f8fafc;
      --text-secondary: #cbd5e1;
      --text-muted: #64748b;
      --border: #334155;
      --border-light: #475569;
      --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      --radius: 12px;
      --radius-lg: 16px;
      --bg-primary: #0f172a;   /* or var(--background) */
      --bg-secondary: #1e293b; /* or var(--surface)    */
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--background);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      text-align: center;
      margin-bottom: 3rem;
      animation: fadeInDown 0.8s ease-out;
    }

    .header h1 {
      font-size: 3rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
    }

    .header p {
      color: var(--text-secondary);
      font-size: 1.1rem;
      font-weight: 400;
    }

    /* Job Portfolio Section */
    .job-portfolio-section {
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 2rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      margin-bottom: 2rem;
      width: 100%;
      animation: fadeInDown 0.8s ease-out 0.1s both;
    }

    .job-portfolio-section h2 {
      font-size: 2rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      color: var(--text-primary);
      text-align: center;
    }

    .job-portfolio-content {
      width: 100%;
    }

    .job-portfolio-entries {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .job-portfolio-entry {
      background: var(--background);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem 1.5rem;
      transition: all 0.2s ease;
      overflow: hidden;
    }

    .job-portfolio-entry.status-accepted {
      border-color: #22c55e;
      border-width: 2px;
    }

    .job-portfolio-entry.status-rejected {
      border-color: #ef4444;
      border-width: 2px;
    }

    .job-portfolio-entry.status-pending {
      border-color: var(--border);
      border-width: 1px;
    }

    .job-portfolio-entry.status-applied {
      border-color: #f97316;
      border-width: 2px;
    }

    .job-portfolio-entry:hover {
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.1);
    }

    .job-portfolio-entry.status-accepted:hover {
      box-shadow: 0 2px 8px rgba(34, 197, 94, 0.2);
    }

    .job-portfolio-entry.status-rejected:hover {
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);
    }

    .job-portfolio-entry.status-applied:hover {
      box-shadow: 0 2px 8px rgba(249, 115, 22, 0.2);
    }

    .job-portfolio-entry.collapsed {
      padding: 1rem 1.5rem;
    }

    .job-portfolio-entry.expanded {
      padding: 1.5rem;
    }

    .job-portfolio-entry-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0;
    }

    .job-portfolio-entry.collapsed .job-portfolio-entry-header {
      margin-bottom: 0;
    }

    .job-portfolio-entry.expanded .job-portfolio-entry-header {
      margin-bottom: 1rem;
    }

    .job-portfolio-entry-preview {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      flex: 1;
    }

    .job-portfolio-entry-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .job-portfolio-entry-due-date {
      font-size: 0.875rem;
      color: var(--text-muted);
      margin: 0;
    }

    .job-portfolio-entry-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .job-portfolio-entry-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }


    .job-portfolio-entry-status select {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0.5rem 0.75rem;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 120px;
    }

    .job-portfolio-entry-status select:hover {
      border-color: var(--primary-color);
    }

    .job-portfolio-entry-status select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .job-portfolio-entry-edit {
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: var(--radius);
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .job-portfolio-entry-edit:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }

    .job-portfolio-entry.expanded .job-portfolio-entry-edit {
      background: var(--surface-light);
      color: var(--text-primary);
    }

    .job-portfolio-entry.expanded .job-portfolio-entry-edit:hover {
      background: var(--surface);
    }

    .job-portfolio-entry-resume {
      background: var(--secondary-color);
      color: white;
      border: none;
      border-radius: var(--radius);
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .job-portfolio-entry-resume:hover {
      background: var(--secondary-hover);
      transform: translateY(-1px);
    }

    .job-portfolio-entry-resume-menu {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, margin-top 0.3s ease, padding 0.3s ease;
      margin-top: 0;
      padding: 0;
    }

    .job-portfolio-entry.resume-open .job-portfolio-entry-resume-menu {
      max-height: 2000px;
      margin-top: 1rem;
      padding: 1.5rem;
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    .questions-empty-state {
      text-align: center;
      padding: 2rem;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .question-entry {
      background: var(--background);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .question-entry-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .question-entry-title-input {
      flex: 1;
      padding: 0.75rem;
      background: var(--background);
      border: 2px solid var(--primary-color);
      border-radius: var(--radius);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 1rem;
      font-weight: 600;
      line-height: 1.4;
      resize: none;
      overflow: hidden;
      box-sizing: border-box;
      height: auto;
      max-height: 300px;
      transition: all 0.2s ease;
    }

    .question-entry-title-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
      background: var(--surface);
    }

    .question-entry-remove-btn {
      background: var(--danger);
      color: white;
      border: none;
      border-radius: var(--radius);
      padding: 0.5rem 0.75rem;
      cursor: pointer;
      font-size: 0.875rem;
      transition: background 0.2s ease;
    }

    .question-entry-remove-btn:hover {
      background: #dc2626;
    }

    .question-entry-answer {
      width: 100%;
      padding: 0.75rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 400;
      resize: none;
      overflow: hidden;
      height: auto;
      max-height: 500px;
      transition: all 0.2s ease;
    }

    .question-entry-answer:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .question-entry-title-input.copied-indicator,
    .question-entry-answer.copied-indicator {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
      transition: all 0.3s ease;
    }

    .add-question-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: var(--radius);
      padding: 0.75rem 1rem;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: background 0.2s ease;
      margin-top: 0.5rem;
    }

    .add-question-btn:hover {
      background: var(--primary-hover);
    }

    .resume-menu-content {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .resume-json-input {
      width: 100%;
      padding: 0.75rem;
      background: var(--background);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text-primary);
      font-family: 'JetBrains Mono', 'Courier New', monospace;
      font-size: 0.875rem;
      resize: vertical;
      transition: all 0.2s ease;
      min-height: 150px;
    }

    .resume-json-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .resume-preview-container {
      margin-top: 1rem;
      display: none;
    }

    .resume-preview-container.active {
      display: block;
    }

    .resume-preview-iframe {
      width: 100%;
      height: 720px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: white;
    }

    /* Resume Loading Screen */
    .resume-loading-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 4rem 2rem;
      min-height: 400px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin: 1rem 0;
    }

    .resume-loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid var(--border);
      border-top-color: var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1.5rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .resume-loading-text {
      color: var(--text-secondary);
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    .resume-loading-subtext {
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    /* AI Building Loading Screen */
    .ai-building-screen {
      background: linear-gradient(135deg, var(--surface) 0%, rgba(99, 102, 241, 0.05) 100%);
      border: 1px solid rgba(99, 102, 241, 0.2);
    }

    .ai-building-animation {
      position: relative;
      width: 100px;
      height: 100px;
      margin-bottom: 1.5rem;
    }

    .ai-building-icon {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: pulse-glow 2s ease-in-out infinite;
      box-shadow: 0 0 30px rgba(99, 102, 241, 0.4);
    }

    .ai-building-icon i {
      font-size: 1.75rem;
      color: white;
      animation: robot-bounce 1s ease-in-out infinite;
    }

    @keyframes pulse-glow {
      0%, 100% {
        box-shadow: 0 0 20px rgba(99, 102, 241, 0.4), 0 0 40px rgba(99, 102, 241, 0.2);
        transform: translate(-50%, -50%) scale(1);
      }
      50% {
        box-shadow: 0 0 30px rgba(99, 102, 241, 0.6), 0 0 60px rgba(99, 102, 241, 0.3);
        transform: translate(-50%, -50%) scale(1.05);
      }
    }

    @keyframes robot-bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-3px); }
    }

    .ai-building-particles {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      height: 100%;
    }

    .ai-building-particles span {
      position: absolute;
      width: 8px;
      height: 8px;
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      border-radius: 50%;
      animation: orbit 3s linear infinite;
    }

    .ai-building-particles span:nth-child(1) { animation-delay: 0s; }
    .ai-building-particles span:nth-child(2) { animation-delay: 0.6s; }
    .ai-building-particles span:nth-child(3) { animation-delay: 1.2s; }
    .ai-building-particles span:nth-child(4) { animation-delay: 1.8s; }
    .ai-building-particles span:nth-child(5) { animation-delay: 2.4s; }

    @keyframes orbit {
      0% {
        top: 50%;
        left: 0%;
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.5);
      }
      25% {
        top: 0%;
        left: 50%;
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
      50% {
        top: 50%;
        left: 100%;
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
      75% {
        top: 100%;
        left: 50%;
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
      100% {
        top: 50%;
        left: 0%;
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.5);
      }
    }

    .ai-building-text {
      color: #6366f1;
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .ai-progress-dots {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .ai-progress-dots .dot {
      width: 10px;
      height: 10px;
      background: #6366f1;
      border-radius: 50%;
      animation: dot-pulse 1.4s ease-in-out infinite;
    }

    .ai-progress-dots .dot:nth-child(1) { animation-delay: 0s; }
    .ai-progress-dots .dot:nth-child(2) { animation-delay: 0.2s; }
    .ai-progress-dots .dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes dot-pulse {
      0%, 80%, 100% {
        transform: scale(0.6);
        opacity: 0.4;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* Create Resume Button */
    .create-resume-btn {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      border: none;
      color: white;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .create-resume-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
    }

    .create-resume-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }

    .job-portfolio-entry-download {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      border-radius: var(--radius);
      padding: 0.5rem 0.75rem;
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 40px;
    }

    .job-portfolio-entry-download:hover {
      background: var(--surface-light);
      color: var(--text-primary);
      border-color: var(--border-light);
    }

    .job-portfolio-entry-remove {
      background: transparent;
      border: 1px solid #ef4444;
      color: #ef4444;
      border-radius: var(--radius);
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s ease;
    }

    .job-portfolio-entry-remove:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: #ef4444;
    }

    .job-portfolio-entry-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, margin-top 0.3s ease;
      margin-top: 0;
    }

    .job-portfolio-entry.expanded .job-portfolio-entry-content {
      max-height: 2000px;
      margin-top: 1rem;
    }

    .job-portfolio-entry-fields {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 0;
    }

    .job-portfolio-entry-field {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .job-portfolio-entry-field.full-width {
      grid-column: 1 / -1;
    }

    .job-portfolio-entry-field label {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .job-portfolio-entry-field input,
    .job-portfolio-entry-field textarea {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0.75rem;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.95rem;
      transition: all 0.2s ease;
    }

    .job-portfolio-entry-field input:focus,
    .job-portfolio-entry-field textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .job-portfolio-entry-field input.copied-indicator,
    .job-portfolio-entry-field textarea.copied-indicator {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
      transition: all 0.3s ease;
    }

    .job-portfolio-entry-field textarea {
      min-height: 120px;
      resize: vertical;
    }

    /* Main Content */
    .main-content {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 2rem;
      flex: 1;
    }

    /* Controls Panel */
    .controls-panel {
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 2rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      height: fit-content;
      animation: fadeInLeft 0.8s ease-out 0.2s both;
    }

    .controls-panel h2 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      color: var(--text-primary);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: var(--radius);
      font-family: inherit;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      width: 100%;
      justify-content: center;
      margin-bottom: 1rem;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .btn-secondary {
      background: var(--secondary-color);
      color: white;
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--secondary-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .btn-accent {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
    }

    .btn-accent:hover:not(:disabled) {
      background: linear-gradient(135deg, #d97706, #b45309);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    /* Settings Section */
    .settings-section {
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border);
    }

    .settings-section h3 {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--text-primary);
    }

    .setting-group {
      margin-bottom: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .setting-group label {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 0.25rem;
    }

    .setting-slider {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: var(--surface-light);
      outline: none;
      -webkit-appearance: none;
      appearance: none;
      cursor: pointer;
    }

    .setting-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--primary-color);
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      transition: all 0.2s ease;
    }

    .setting-slider::-webkit-slider-thumb:hover {
      background: var(--primary-hover);
      transform: scale(1.1);
    }

    .setting-slider::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--primary-color);
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .setting-value {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--primary-color);
      text-align: center;
      background: rgba(99, 102, 241, 0.1);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      min-width: 50px;
      display: inline-block;
    }

    /* OCR Progress Styles */
    .progress-container {
      margin-top: 1rem;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--surface-light);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 0.5rem;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      width: 0%;
      transition: width 0.3s ease;
    }

    .progress-text {
      font-size: 0.85rem;
      color: var(--text-secondary);
      text-align: center;
    }

    /* JSON Input Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease-out;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 2rem;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border);
      animation: slideInUp 0.3s ease-out;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .modal-header h3 {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .close-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.5rem;
      border-radius: var(--radius);
      transition: all 0.2s ease;
    }

    .close-btn:hover {
      background: var(--surface-light);
      color: var(--text-primary);
    }

    .json-input {
      width: 100%;
      min-height: 300px;
      background: var(--background);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem;
      color: var(--text-primary);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
      line-height: 1.5;
      resize: vertical;
      transition: border-color 0.2s ease;
    }

    .json-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    /* Grade Modal Textarea Styling */
    #gradeJobDescription {
      width: 100%;
      min-height: 200px;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 1.25rem;
      color: #1e293b;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 0.95rem;
      line-height: 1.6;
      resize: vertical;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      position: relative;
    }

    #gradeJobDescription::placeholder {
      color: #64748b;
      font-style: italic;
      font-weight: 400;
    }

    #gradeJobDescription:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1), 0 4px 12px rgba(0, 0, 0, 0.1);
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      transform: translateY(-1px);
    }

    #gradeJobDescription:hover {
      border-color: #cbd5e1;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* Grade Modal Body Enhancement */
    .modal-body p {
      color: #64748b;
      font-size: 0.95rem;
      line-height: 1.6;
      margin-bottom: 1.5rem;
      font-weight: 500;
    }

    /* Grade Modal Header Enhancement */
    #gradeModal .modal-header {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      border-radius: 12px 12px 0 0;
      padding: 1.5rem 2rem;
      margin: -1.5rem -2rem 0 -2rem;
      position: relative;
    }

    #gradeModal .modal-header h3 {
      color: #ffffff;
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    #gradeModal .modal-header h3::before {
      content: "‚≠ê";
      font-size: 1.25rem;
    }

    #gradeModal .modal-header .close-btn {
      color: #94a3b8;
      font-size: 1.5rem;
      transition: all 0.2s ease;
    }

    #gradeModal .modal-header .close-btn:hover {
      color: #ffffff;
      transform: scale(1.1);
    }

    /* Grade Modal Container Enhancement */
    #gradeModal .modal {
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
      border: 1px solid #e2e8f0;
    }

    /* Grade Modal Body Spacing */
    #gradeModal .modal-body {
      padding: 2rem;
    }

    /* Grade Modal Button Enhancements */
    #gradeModal .btn-accent {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      border: none;
      color: #ffffff;
      font-weight: 600;
      padding: 0.875rem 1.5rem;
      border-radius: 8px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.95rem;
    }

    #gradeModal .btn-accent:hover {
      background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4);
    }

    #gradeModal .btn-accent:active {
      transform: translateY(0);
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
    }

    #gradeModal .btn-secondary {
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
      border: 1px solid #cbd5e1;
      color: #475569;
      font-weight: 500;
      padding: 0.875rem 1.5rem;
      border-radius: 8px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.95rem;
    }

    #gradeModal .btn-secondary:hover {
      background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    #gradeModal .btn-secondary:active {
      transform: translateY(0);
    }

    /* Grade Modal Animation */
    #gradeModal.modal-overlay {
      backdrop-filter: blur(8px);
      background: rgba(0, 0, 0, 0.6);
    }

    #gradeModal .modal {
      animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Textarea Character Counter */
    #gradeJobDescription {
      position: relative;
    }

    #gradeJobDescription::after {
      content: attr(data-count) " characters";
      position: absolute;
      bottom: 0.75rem;
      right: 1rem;
      font-size: 0.75rem;
      color: #94a3b8;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    #gradeJobDescription:focus::after {
      opacity: 1;
    }

    .modal-actions {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .modal-actions .btn {
      margin-bottom: 0;
      flex: 1;
    }

    /* Grading Modal Styles */
    .grade-results-modal {
      max-width: 800px;
    }

    .grade-score {
      text-align: center;
      margin-bottom: 2rem;
    }

    .score-circle {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(135deg, #10b981, #059669);
      margin-bottom: 1rem;
      position: relative;
    }

    .score-number {
      font-size: 2.5rem;
      font-weight: 700;
      color: white;
    }

    .score-label {
      font-size: 1rem;
      color: white;
      margin-left: 0.25rem;
    }

    .score-description {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .grade-feedback {
      background: var(--background);
      border-radius: var(--radius);
      padding: 1.5rem;
      margin-top: 1rem;
    }

    .grade-feedback h4 {
      color: var(--text-primary);
      margin-bottom: 1rem;
      font-size: 1.1rem;
    }

    .grade-feedback ul {
      margin: 0;
      padding-left: 1.5rem;
    }

    .grade-feedback li {
      margin-bottom: 0.5rem;
      line-height: 1.5;
    }

    .grade-feedback .strengths {
      color: #10b981;
    }

    .grade-feedback .improvements {
      color: #f59e0b;
    }

    /* Job Edit Modal Styles */
    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .form-group input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--surface);
      color: var(--text-primary);
      font-size: 1rem;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }

    /* Format Settings Collapsible Styles */
    .format-settings-header {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .expand-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: all 0.2s ease;
      width: fit-content;
      align-self: flex-start;
    }

    .expand-btn:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }

    .expand-btn i {
      transition: transform 0.2s ease;
    }

    .expand-btn.expanded i {
      transform: rotate(180deg);
    }

    .format-settings-content {
      border-top: 1px solid var(--border);
      padding-top: 1rem;
      margin-top: 1rem;
    }

    .settings-subsection {
      margin-bottom: 2rem;
    }

    .settings-subsection:last-child {
      margin-bottom: 0;
    }

    .settings-subsection h4 {
      color: var(--text-primary);
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }

    /* Authentication Modal Styles */
    .auth-modal {
      max-width: 600px;
      width: 90%;
    }

    .auth-content {
      position: relative;
    }

    .auth-form {
      animation: fadeIn 0.3s ease-out;
    }

    .auth-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .auth-header h2 {
      font-size: 1.75rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }

    .auth-header p {
      color: var(--text-secondary);
      font-size: 0.95rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }

    .form-group input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--background);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.95rem;
      transition: all 0.2s ease;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .form-group input::placeholder {
      color: var(--text-muted);
    }

    /* Personal Info Form Styles */
    .settings-section .form-group {
      margin-bottom: 1rem;
    }

    .settings-section .form-group label {
      display: block;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }

    .settings-section .form-group input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--background);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.95rem;
      transition: all 0.2s ease;
    }

    .settings-section .form-group input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .settings-section .form-group input::placeholder {
      color: var(--text-muted);
    }

    /* Current Resume Upload Styles */
    .resume-upload-container {
      margin-top: 1rem;
    }

    .file-upload-area {
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      background: var(--background);
    }

    .file-upload-area:hover {
      border-color: var(--primary-color);
      background: rgba(99, 102, 241, 0.05);
    }

    .file-upload-area.dragover {
      border-color: var(--primary-color);
      background: rgba(99, 102, 241, 0.1);
    }

    .upload-content i {
      font-size: 2rem;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }

    .upload-content p {
      color: var(--text-secondary);
      font-weight: 500;
      margin: 0.5rem 0;
    }

    .upload-content small {
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .resume-preview-container {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem;
      background: var(--background);
    }

    .resume-preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .resume-filename {
      color: var(--text-primary);
      font-weight: 500;
      font-size: 0.9rem;
    }

    .resume-actions {
      display: flex;
      gap: 0.5rem;
    }

    .btn-small {
      padding: 0.25rem 0.5rem;
      font-size: 0.8rem;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-small:hover {
      background: var(--surface-light);
      color: var(--text-primary);
    }

    .btn-small.btn-danger {
      color: #ef4444;
      border-color: rgba(239, 68, 68, 0.3);
    }

    .btn-small.btn-danger:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: #ef4444;
    }

    .resume-preview-thumbnail {
      text-align: center;
      padding: 1rem;
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    .resume-preview-thumbnail i {
      font-size: 3rem;
      color: #ef4444;
    }

    .resume-preview-thumbnail img {
      max-width: 100%;
      max-height: 200px;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* Job Titles Section Styles */
    .section-description {
      color: var(--text-muted);
      font-size: 0.85rem;
      margin-bottom: 1rem;
      font-style: italic;
    }

    .job-titles-container {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .job-title-item {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem;
      transition: all 0.2s ease;
    }

    .job-title-item:hover {
      border-color: var(--primary-color);
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.1);
    }

    .job-title-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .edit-job-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 0.5rem;
      cursor: pointer;
      font-size: 0.875rem;
      transition: background-color 0.2s ease;
    }

    .edit-job-btn:hover {
      background: var(--primary-hover);
    }

    .job-location {
      color: var(--text-muted);
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }

    .job-title-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 1rem;
      margin: 0;
    }

    .job-company {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin: 0.25rem 0;
    }

    .job-dates {
      color: var(--text-muted);
      font-size: 0.85rem;
      font-style: italic;
    }

    .job-titles-loading {
      text-align: center;
      padding: 2rem;
    }

    .job-titles-loading p {
      color: var(--text-secondary);
      margin-top: 1rem;
    }

    .job-titles-empty {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
    }

      .job-titles-empty i {
        font-size: 2rem;
        margin-bottom: 1rem;
        opacity: 0.5;
      }
      
      .job-titles-empty p {
        margin: 0;
      }

      /* Education/Certificates Styles */
      .education-container {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 15px;
        background: var(--bg-secondary);
      }
      
      .education-item {
        background: var(--bg-primary);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .education-item:last-child {
        margin-bottom: 0;
      }
      
      .education-title {
        font-weight: 500;
        color: var(--text-primary);
        margin: 0;
        font-size: 0.9rem;
      }
      
      .education-loading {
        text-align: center;
        padding: 2rem;
      }
      
      .education-loading p {
        color: var(--text-secondary);
        margin-top: 1rem;
      }
      
      .education-empty {
        text-align: center;
        padding: 2rem;
        color: var(--text-muted);
      }
      
      .education-empty i {
        font-size: 2rem;
        margin-bottom: 1rem;
        opacity: 0.5;
      }
      
      .education-empty p {
        margin: 0;
      }

      /* Loading Bar Styles */
      .loading-bar {
        width: 100%;
        height: 20px;
        background-color: var(--bg-secondary);
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
        position: relative;
      }

      .loading-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #007bff, #0056b3);
        border-radius: 10px;
        width: 0%;
        transition: width 0.3s ease;
      }

      .loading-bar-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: var(--text-primary);
        font-size: 0.8rem;
        font-weight: 500;
      }

      /* Checkbox Styles */
      .checkbox-label {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-size: 0.9rem;
        color: var(--text-primary);
        margin-bottom: 0;
      }

      .checkbox-label input[type="checkbox"] {
        display: none;
      }

      .checkmark {
        width: 20px;
        height: 20px;
        background-color: var(--bg-primary);
        border: 2px solid var(--border);
        border-radius: 4px;
        margin-right: 10px;
        position: relative;
        transition: all 0.3s ease;
      }

      .checkbox-label input[type="checkbox"]:checked + .checkmark {
        background-color: #007bff;
        border-color: #007bff;
      }

      .checkbox-label input[type="checkbox"]:checked + .checkmark::after {
        content: '';
        position: absolute;
        left: 6px;
        top: 2px;
        width: 6px;
        height: 10px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
      }

    .auth-switch {
      text-align: center;
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border);
    }

    .auth-switch p {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .auth-switch a {
      color: var(--primary-color);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s ease;
    }

    .auth-switch a:hover {
      color: var(--primary-hover);
      text-decoration: underline;
    }

    .auth-loading {
      text-align: center;
      padding: 2rem;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--surface-light);
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .auth-loading p {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .auth-error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: var(--radius);
      padding: 1rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      animation: slideInDown 0.3s ease-out;
    }

    .auth-error i {
      color: #ef4444;
      font-size: 1.1rem;
    }

    .auth-error p {
      color: #ef4444;
      font-size: 0.9rem;
      margin: 0;
    }

    /* User Info in Header */
    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-left: auto;
    }

    .user-email {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .logout-btn {
      background: var(--surface-light);
      color: var(--text-secondary);
      border: 1px solid var(--border);
      padding: 0.5rem 1rem;
      border-radius: var(--radius);
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .logout-btn:hover {
      background: var(--surface);
      color: var(--text-primary);
      border-color: var(--border-light);
    }

    /* Hide main content when not authenticated */
    .main-content.hidden {
      display: none;
    }

    .header.hidden {
      display: none;
    }

    /* Resume Preview */
    .preview-container {
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 2rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      animation: fadeInRight 0.8s ease-out 0.4s both;
    }

    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .preview-header h2 {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .preview-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: var(--radius);
      font-size: 0.9rem;
      font-weight: 500;
    }

    .status-empty {
      background: rgba(100, 116, 139, 0.2);
      color: var(--text-muted);
    }

    .status-loaded {
      background: rgba(16, 185, 129, 0.2);
      color: var(--secondary-color);
    }

    .status-error {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .resume-preview {
      background: white;
      color: #1f2937;
      padding: var(--name-top-padding, 1rem) 3rem 3rem 3rem;
      border-radius: var(--radius);
      min-height: 800px;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
      font-size: 14px;
      line-height: 1.6;
      position: relative;
      overflow: hidden;
    }

    .resume-preview::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
    }
    
    /* Clean export: remove visual chrome during PDF render */
    .resume-preview.export-clean {
      box-shadow: none !important;
      border-radius: 0 !important;
    }
    .resume-preview.export-clean::before {
      display: none !important;
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 400px;
      color: var(--text-muted);
      text-align: center;
    }

    .empty-state i {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-secondary);
    }

    .empty-state p {
      font-size: 0.95rem;
      max-width: 300px;
    }

    /* Resume Styling */
    .resume-header {
      text-align: center;
      font-size: var(--name-size, 24px);
      font-weight: 700;
      margin-bottom: 4px;
      letter-spacing: 0.5px;
      color: #1f2937;
    }

    .resume-contact {
      text-align: center;
      font-size: var(--contact-size, 14px);
      font-weight: 500;
      margin-bottom: 12px;
      color: #4b5563;
    }

    .resume-divider {
      border: none;
      border-top: 2px solid #1f2937;
      margin: 8px 0 12px 0;
      width: 100%;
    }

    .section-title {
      font-size: 18px;
      font-weight: 700;
      text-align: center;
      text-decoration: underline;
      margin: 0 0 20px 0;
      letter-spacing: 0.2px;
      color: #1f2937;
    }
    
    .resume-preview .resume-divider + .section-title {
      margin-top: 0;
    }
    
    .resume-preview .section-title:first-of-type {
      margin-top: 0;
    }

    .summary-section {
      margin-bottom: 20px;
      text-align: left;
    }

    .summary-section p {
      margin: 0;
      line-height: 1.5;
      font-size: 14px;
      color: #374151;
    }

    .job-title {
      font-weight: 700;
      font-size: var(--job-title-size, 16px);
      margin-top: 12px;
      margin-bottom: 4px;
      color: #1f2937;
    }

    .section {
      margin-bottom: 20px;
      padding-top: var(--job-padding-top, 10px);
    }
    
    .first-job-section {
      padding-top: 3px !important;
    }
    
    .last-job-section {
      padding-bottom: var(--job-padding-bottom, 10px);
    }
    


    .company-row {
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 4px;
    }

    .company {
      font-weight: 600;
      font-size: var(--company-size, 14px);
      color: #374151;
    }

    .company-details {
      font-size: var(--company-details-size, 12px);
      color: #6b7280;
    }

    .job-list {
      margin: 0 0 0 24px;
    }

    .job-list li {
      font-size: var(--bullet-size, 12px);
      margin-bottom: 8px;
      line-height: 1.6;
      color: #374151;
    }

    .cert-list {
      margin: 0 0 0 24px;
    }

    .cert-list li {
      font-size: 13px;
      margin-bottom: 6px;
      font-weight: 600;
      color: #374151;
    }

    /* Skills Section Styles */
    .skills-section {
      margin-bottom: 20px;
    }

    .skill-category {
      margin-bottom: 12px;
      display: flex;
      align-items: baseline;
      gap: 10px;
    }

    .skill-category-title {
      font-weight: 600;
      font-size: var(--bullet-size, 12px);
      color: #374151;
      flex-shrink: 0;
    }

    .skill-list {
      flex: 1;
      font-size: var(--bullet-size, 12px);
      color: #374151;
      line-height: 1.4;
    }

    .skill-item {
      display: inline;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .skill-item:hover {
      background-color: rgba(99, 102, 241, 0.1);
      border-radius: 4px;
      padding: 2px 4px;
      margin: 0 -4px;
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInLeft {
      from {
        opacity: 0;
        transform: translateX(-30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes fadeInRight {
      from {
        opacity: 0;
        transform: translateX(30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
      .main-content {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }
      
      .controls-panel {
        order: 2;
      }
      
      .preview-container {
        order: 1;
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .modal {
        padding: 1.5rem;
        width: 95%;
      }
      
      .resume-preview {
        padding: 2rem;
      }
      
      .job-portfolio-entry-fields {
        grid-template-columns: 1fr !important;
      }
      
      .job-portfolio-section {
        padding: 1.5rem;
      }
    }

    @media print {
      body, .container, .resume-preview {
        box-shadow: none !important;
        background: white !important;
        color: black !important;
      }
      .controls-panel, .modal-overlay {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header" id="mainHeader">
      <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
        <div>
      <h1>Resume Builder Pro</h1>
        </div>
        <div class="user-info" id="userInfo" style="display: none;">
          <span class="user-email" id="userEmail"></span>
          <button class="logout-btn" id="logoutBtn">
            <i class="fas fa-sign-out-alt"></i>
            Logout
          </button>
        </div>
      </div>
    </div>

    <!-- Job Portfolio Section -->
    <div class="job-portfolio-section">
        <h2>Job Portfolio</h2>
      <div class="job-portfolio-content">
        <div class="application-pending-section">
          <div class="job-portfolio-entries" id="jobPortfolioEntries">
            <!-- Job portfolio entries will be dynamically added here -->
          </div>
          <button class="btn btn-primary" id="addJobPortfolioEntryBtn">
            <i class="fas fa-plus"></i>
            Add New Entry
          </button>
        </div>
      </div>
    </div>
      
    <!-- Main Content -->
    <div class="main-content">
      <!-- Controls Panel -->
      <div class="controls-panel">
        <h2>Resume Settings</h2>
        <button class="btn btn-primary" id="generateResumeBtn">
          <i class="fas fa-magic"></i>
          Enter Job Description
        </button>
        <button class="btn btn-secondary" id="downloadPdfBtn" disabled style="display: none;">
          <i class="fas fa-file-pdf"></i>
          Download PDF
        </button>
        <button class="btn btn-secondary" id="downloadJsonBtn" disabled style="display: none;">
          <i class="fas fa-download"></i>
          Download JSON
        </button>
        <button class="btn btn-accent" id="gradeResumeBtn" disabled style="display: none;">
          <i class="fas fa-star"></i>
          Grade Me
        </button>
        <button class="btn btn-primary" id="importJsonBtn">
          <i class="fas fa-upload"></i>
          Import JSON Data
        </button>
        <!-- Hidden OCR PDF button - functionality preserved -->
        <button class="btn btn-secondary" id="downloadOcrPdfBtn" disabled style="display: none;">
          <i class="fas fa-search"></i>
          Download OCR PDF
        </button>
        <div class="loading-bar" id="ocrLoadingBar" style="display: none;">
          <div class="loading-bar-fill"></div>
          <span class="loading-bar-text">Processing OCR...</span>
        </div>
        
        <!-- Settings Section -->
        <div class="settings-section">
          <h3>Display Options</h3>
          
          <div class="setting-group">
            <label class="checkbox-label">
              <input type="checkbox" id="showSkillsCheckbox" checked>
              <span class="checkmark"></span>
              Show Skills in Resume
            </label>
          </div>
          
          <div class="setting-group">
            <label class="checkbox-label">
              <input type="checkbox" id="showSummaryCheckbox" checked>
              <span class="checkmark"></span>
              Show Professional Summary
            </label>
          </div>
          
          <div class="setting-group">
            <label class="checkbox-label">
              <input type="checkbox" id="centerHeaderCheckbox">
              <span class="checkmark"></span>
              Center Headers
            </label>
          </div>
        </div>
        
        <!-- Format Settings (Collapsible) -->
        <div class="settings-section">
          <div class="format-settings-header">
            <h3>Format Settings</h3>
            <button class="expand-btn" id="formatSettingsToggle">
              <i class="fas fa-chevron-down"></i>
              <span>Expand Menu</span>
            </button>
          </div>
          
          <div class="format-settings-content" id="formatSettingsContent" style="display: none;">
            <div class="settings-subsection">
              <h4>Font Sizes</h4>
              
              <div class="setting-group">
                <label for="nameSize">Name Font Size (px)</label>
                <input type="range" id="nameSize" min="18" max="36" value="24" class="setting-slider">
                <span class="setting-value" id="nameSizeValue">24px</span>
              </div>
              
              <div class="setting-group">
                <label for="contactSize">Contact Info Font Size (px)</label>
                <input type="range" id="contactSize" min="10" max="20" value="14" class="setting-slider">
                <span class="setting-value" id="contactSizeValue">14px</span>
              </div>
              
              <div class="setting-group">
                <label for="jobTitleSize">Job Title Font Size (px)</label>
                <input type="range" id="jobTitleSize" min="12" max="24" value="16" class="setting-slider">
                <span class="setting-value" id="jobTitleSizeValue">16px</span>
              </div>
              
              <div class="setting-group">
                <label for="companySize">Company Name Font Size (px)</label>
                <input type="range" id="companySize" min="10" max="20" value="14" class="setting-slider">
                <span class="setting-value" id="companySizeValue">14px</span>
              </div>
              
              <div class="setting-group">
                <label for="companyDetailsSize">Company Details Font Size (px)</label>
                <input type="range" id="companyDetailsSize" min="8" max="16" value="12" class="setting-slider">
                <span class="setting-value" id="companyDetailsSizeValue">12px</span>
              </div>
              
              <div class="setting-group">
                <label for="bulletSize">Bullet Points Font Size (px)</label>
                <input type="range" id="bulletSize" min="8" max="16" value="12" class="setting-slider">
                <span class="setting-value" id="bulletSizeValue">12px</span>
              </div>
            </div>
            
            <div class="settings-subsection">
              <h4>Spacing & Padding</h4>
              
              <div class="setting-group">
                <label for="nameTopPadding">Name Top Padding (px)</label>
                <input type="range" id="nameTopPadding" min="0" max="50" value="16" class="setting-slider">
                <span class="setting-value" id="nameTopPaddingValue">16px</span>
              </div>
              
              <div class="setting-group">
                <label for="jobPaddingTop">Job Entry Top Padding (px)</label>
                <input type="range" id="jobPaddingTop" min="0" max="30" value="10" class="setting-slider">
                <span class="setting-value" id="jobPaddingTopValue">10px</span>
              </div>
              
              <div class="setting-group">
                <label for="jobPaddingBottom">Last Job Bottom Padding (px)</label>
                <input type="range" id="jobPaddingBottom" min="0" max="30" value="10" class="setting-slider">
                <span class="setting-value" id="jobPaddingBottomValue">10px</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- OCR Progress Section -->
        <div class="settings-section" id="ocrProgressSection" style="display: none;">
          <h3>OCR Processing</h3>
          <div class="progress-container">
            <div class="progress-bar">
              <div class="progress-fill" id="ocrProgressFill"></div>
            </div>
            <div class="progress-text" id="ocrProgressText">Processing...</div>
          </div>
        </div>
        
        <!-- Personal Info Section -->
        <div class="settings-section">
          <h3>Personal Information</h3>
          
          <div class="form-group">
            <label for="personalName">Full Name</label>
            <input type="text" id="personalName" placeholder="Enter your full name">
          </div>
          
          <div class="form-group">
            <label for="personalAddress">Address</label>
            <input type="text" id="personalAddress" placeholder="Enter your address">
          </div>
          
          <div class="form-group">
            <label for="personalEmail">Email</label>
            <input type="email" id="personalEmail" placeholder="Enter your email">
          </div>
          
          <div class="form-group">
            <label for="personalPhone">Phone Number</label>
            <input type="tel" id="personalPhone" placeholder="Enter your phone number">
          </div>
          
          <div class="form-group">
            <button type="button" class="btn btn-primary" id="savePersonalInfoBtn">
              <i class="fas fa-save"></i>
              Save Personal Info
            </button>
          </div>
        </div>
        
        <!-- Current Resume Section -->
        <div class="settings-section">
          <h3>Current Resume</h3>
          
          <div class="resume-upload-container">
            <div class="file-upload-area" id="fileUploadArea">
              <input type="file" id="resumeFileInput" accept=".pdf,.doc,.docx" style="display: none;">
              <div class="upload-content" id="uploadContent">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>Click to upload your current resume</p>
                <small>Supports PDF, DOC, DOCX files</small>
              </div>
            </div>
            
            <div class="resume-preview-container" id="resumePreviewContainer" style="display: none;">
              <div class="resume-preview-header">
                <span class="resume-filename" id="resumeFilename"></span>
                <div class="resume-actions">
                  <button class="btn-small btn-secondary" id="viewResumeBtn">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button class="btn-small btn-danger" id="removeResumeBtn">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
              <div class="resume-preview-thumbnail" id="resumePreviewThumbnail">
                <i class="fas fa-file-pdf"></i>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Job Titles Section -->
        <div class="settings-section" id="jobTitlesSection" style="display: none;">
          <h3>Job Titles</h3>
          <p class="section-description">Extracted from your uploaded resume</p>
          
          <div class="job-titles-container" id="jobTitlesContainer">
            <!-- Job titles will be dynamically added here -->
          </div>
          
          <div class="job-titles-loading" id="jobTitlesLoading" style="display: none;">
            <div class="loading-spinner"></div>
            <p>Extracting job information from resume...</p>
          </div>
          
          <div class="job-titles-empty" id="jobTitlesEmpty" style="display: none;">
            <i class="fas fa-briefcase"></i>
            <p>No job information found in resume</p>
          </div>
        </div>
        
        <!-- Education/Certificates Section -->
        <div class="settings-section" id="educationSection" style="display: none;">
          <h3>Education/Certificates</h3>
          <p class="section-description">Extracted from your uploaded resume</p>
          
          <div class="education-container" id="educationContainer">
            <!-- Education and certificates will be dynamically added here -->
          </div>
          
          <div class="education-loading" id="educationLoading" style="display: none;">
            <div class="loading-spinner"></div>
            <p>Extracting education and certificates from resume...</p>
          </div>
          
          <div class="education-empty" id="educationEmpty" style="display: none;">
            <i class="fas fa-graduation-cap"></i>
            <p>No education or certificates found in resume</p>
          </div>
        </div>
      </div>

      <!-- Preview Container -->
      <div class="preview-container">
        <div class="preview-header">
          <h2>Resume Preview</h2>
          <div class="preview-status status-empty" id="previewStatus">
            <i class="fas fa-info-circle"></i>
            No data loaded
          </div>
        </div>
        
    <div id="resumePreview" class="resume-preview">
          <div class="empty-state">
            <i class="fas fa-file-alt"></i>
            <h3>Ready to build your resume?</h3>
            <p>Click "Import JSON Data" to get started with your resume information.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JSON Input Modal -->
  <div class="modal-overlay" id="jsonModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Import Resume Data</h3>
        <button class="close-btn" id="closeModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div>
        <label for="jsonInput" style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-weight: 500;">
          Paste your JSON data below:
        </label>
        <textarea 
          id="jsonInput" 
          class="json-input" 
          placeholder='{
  "contact": {
    "name": "Your Name",
    "email": "your.email@example.com",
    "phone": "(555) 123-4567",
    "address": "City, State"
  },
  "jobs": [
    {
      "title": "Job Title",
      "company": "Company Name",
      "location": "Location",
      "startDate": "Jan 2023",
      "endDate": "Present",
      "duties": ["Responsibility 1", "Responsibility 2"]
    }
  ],
  "skills": {
    "Languages & Frameworks": ["JavaScript", "Python", "React"],
    "Databases": ["MySQL", "PostgreSQL"],
    "Tools": ["Git", "Docker", "AWS"]
  },
  "certificates": [
    {"name": "Certificate Name"}
  ]
}'
        ></textarea>
      </div>
      
      <div class="modal-actions">
        <button class="btn btn-secondary" id="cancelImport">Cancel</button>
        <button class="btn btn-primary" id="confirmImport">Import Data</button>
      </div>
    </div>
  </div>

  <!-- Authentication Modal -->
  <div class="modal-overlay" id="authModal">
    <div class="modal auth-modal">
      <div class="modal-header">
        <h3 id="authModalTitle">Welcome to Resume Builder Pro</h3>
        <button class="close-btn" id="closeAuthModal" style="display: none;">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="auth-content">
        <!-- Sign Up Form -->
        <div class="auth-form" id="signUpForm">
          <div class="auth-header">
            <h2>Create Account</h2>
            <p>Sign up to start building your professional resume</p>
          </div>
          
          <form id="signUpFormElement">
            <div class="form-group">
              <label for="signUpEmail">Email Address</label>
              <input type="email" id="signUpEmail" required placeholder="Enter your email">
            </div>
            
            <div class="form-group">
              <label for="signUpPassword">Password</label>
              <input type="password" id="signUpPassword" required placeholder="Create a password" minlength="6">
            </div>
            
            <div class="form-group">
              <label for="signUpConfirmPassword">Confirm Password</label>
              <input type="password" id="signUpConfirmPassword" required placeholder="Confirm your password" minlength="6">
            </div>
            
            <button type="submit" class="btn btn-primary" id="signUpBtn">
              <i class="fas fa-user-plus"></i>
              Create Account
            </button>
          </form>
          
          <div class="auth-switch">
            <p>Already have an account? <a href="#" id="switchToLogin">Sign in here</a></p>
          </div>
        </div>
        
        <!-- Sign In Form -->
        <div class="auth-form" id="signInForm" style="display: none;">
          <div class="auth-header">
            <h2>Welcome Back</h2>
            <p>Sign in to continue building your resume</p>
          </div>
          
          <form id="signInFormElement">
            <div class="form-group">
              <label for="signInEmail">Email Address</label>
              <input type="email" id="signInEmail" required placeholder="Enter your email">
            </div>
            
            <div class="form-group">
              <label for="signInPassword">Password</label>
              <input type="password" id="signInPassword" required placeholder="Enter your password">
            </div>
            
            <button type="submit" class="btn btn-primary" id="signInBtn">
              <i class="fas fa-sign-in-alt"></i>
              Sign In
            </button>
          </form>
          
          <div class="auth-switch">
            <p>Don't have an account? <a href="#" id="switchToSignUp">Create one here</a></p>
          </div>
        </div>
        
        <!-- Loading State -->
        <div class="auth-loading" id="authLoading" style="display: none;">
          <div class="loading-spinner"></div>
          <p id="loadingText">Processing...</p>
        </div>
        
        <!-- Error Message -->
        <div class="auth-error" id="authError" style="display: none;">
          <i class="fas fa-exclamation-triangle"></i>
          <p id="errorMessage"></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Resume Grading Modal -->
  <div class="modal-overlay" id="gradeModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Grade My Resume</h3>
        <button class="close-btn" id="closeGradeModal">&times;</button>
      </div>
      <div class="modal-body">
        <p>Enter the job description you're applying for to get a detailed assessment of how well your resume matches the requirements.</p>
        <textarea 
          id="gradeJobDescription" 
          placeholder="Paste the job description here..."
          rows="8"
        ></textarea>
        <div class="modal-actions">
          <button class="btn btn-secondary" id="cancelGrade">Cancel</button>
          <button class="btn btn-accent" id="startGrading">
            <i class="fas fa-star"></i>
            Grade My Resume
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Grading Results Modal -->
  <div class="modal-overlay" id="gradeResultsModal">
    <div class="modal grade-results-modal">
      <div class="modal-header">
        <h3>Resume Grade Results</h3>
        <button class="close-btn" id="closeGradeResultsModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="grade-score" id="gradeScore">
          <div class="score-circle">
            <span class="score-number" id="scoreNumber">0</span>
            <span class="score-label">/ 100</span>
          </div>
          <div class="score-description" id="scoreDescription">Loading...</div>
        </div>
        <div class="grade-feedback" id="gradeFeedback">
          <!-- Detailed feedback will be inserted here -->
        </div>
        <div class="modal-actions">
          <button class="btn btn-primary" id="closeGradeResults">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Job Edit Modal -->
  <div class="modal-overlay" id="jobEditModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Edit Job Entry</h3>
        <button class="close-btn" id="closeJobEditModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="editJobTitle">Job Title</label>
          <input type="text" id="editJobTitle" placeholder="Enter job title">
        </div>
        <div class="form-group">
          <label for="editJobCompany">Company</label>
          <input type="text" id="editJobCompany" placeholder="Enter company name">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="editJobStartDate">Start Date</label>
            <input type="text" id="editJobStartDate" placeholder="e.g., June 2024">
          </div>
          <div class="form-group">
            <label for="editJobEndDate">End Date</label>
            <input type="text" id="editJobEndDate" placeholder="e.g., Current or Dec 2024">
          </div>
        </div>
        <div class="form-group">
          <label for="editJobLocation">Location</label>
          <input type="text" id="editJobLocation" placeholder="Enter location">
        </div>
        <div class="modal-actions">
          <button class="btn btn-secondary" id="cancelJobEdit">Cancel</button>
          <button class="btn btn-primary" id="saveJobEdit">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Job Description Modal -->
  <div class="modal-overlay" id="jobDescriptionModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Generate Resume from Job Description</h3>
        <button class="close-btn" id="closeJobDescriptionModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div>
        <label for="jobDescriptionInput" style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-weight: 500;">
          Paste the job description below and we'll generate a tailored resume:
        </label>
        <textarea 
          id="jobDescriptionInput" 
          class="json-input" 
          placeholder="Paste the complete job description here including:
- Job title and company
- Required skills and qualifications
- Job responsibilities
- Experience requirements
- Any specific technologies or tools mentioned

Example:
Senior Software Engineer at TechCorp
We are looking for a Senior Software Engineer with 5+ years of experience in full-stack development. The ideal candidate will have expertise in React, Node.js, Python, and cloud technologies. Responsibilities include leading development teams, architecting scalable solutions, and mentoring junior developers..."
          style="min-height: 200px;"
        ></textarea>
      </div>
      
      <div class="modal-actions">
        <button class="btn btn-secondary" id="cancelJobDescription">Cancel</button>
        <button class="btn btn-primary" id="generateResumeFromJob">
          <i class="fas fa-magic"></i>
          Generate Resume
        </button>
      </div>
      
      <!-- AI Generation Progress -->
      <div class="ai-progress" id="aiProgress" style="display: none;">
        <div class="progress-container">
          <div class="progress-bar">
            <div class="progress-fill" id="aiProgressFill"></div>
          </div>
          <div class="progress-text" id="aiProgressText">Generating your resume...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- OCR Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <!-- JSZip for creating zip files -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <!-- AI Configuration will be loaded dynamically from server -->
  
  
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
    
    import { getFirestore, doc, setDoc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCZJEsfHFPLVqKOyM9fhw7iEE-bxInzmTI",
      authDomain: "resumebuilder-7b339.firebaseapp.com",
      projectId: "resumebuilder-7b339",
      storageBucket: "resumebuilder-7b339.firebasestorage.app",
      messagingSenderId: "1007178809400",
      appId: "1:1007178809400:web:fd13f4bbb78b1a08dae6cd",
      measurementId: "G-4TBP7LZGHF"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const storage = getStorage(app);
    const db = getFirestore(app);
    
    // Make Firebase services available globally
    window.auth = auth;
    window.storage = storage;
    window.db = db;
    window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
    window.signInWithEmailAndPassword = signInWithEmailAndPassword;
    window.signOut = signOut;
    window.onAuthStateChanged = onAuthStateChanged;
    window.ref = ref;
    window.uploadBytes = uploadBytes;
    window.getDownloadURL = getDownloadURL;
    window.deleteObject = deleteObject;
    window.setDoc = setDoc;
    window.getDoc = getDoc;
    window.updateDoc = updateDoc;
    window.doc = doc;
  </script>

  <!-- Load AI Configuration from Server -->
  <script>
    // Global AI_CONFIG variable
    let AI_CONFIG = null;
    
    // Load AI configuration from server
    async function loadAIConfig() {
      try {
        const response = await fetch('/api/ai-config');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        AI_CONFIG = await response.json();
        console.log('AI Configuration loaded from server:', AI_CONFIG);
      } catch (error) {
        console.error('Failed to load AI configuration:', error);
        // Fallback configuration (no API key - server must be running)
        AI_CONFIG = {
          apiKey: null, // No fallback API key for security
          model: 'gpt-4o',
          maxTokens: 4000,
          temperature: 0.5
        };
        console.log('Using fallback AI configuration');
      }
    }
    
    // Load AI config when page loads
    loadAIConfig();
  </script>

  <script>
    let resumeData = null;
    let pdfBlobUrl = null;
    let currentUser = null;

    // Authentication state
    let isAuthenticated = false;

    // Elements
    const importJsonBtn = document.getElementById('importJsonBtn');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');
    const downloadOcrPdfBtn = document.getElementById('downloadOcrPdfBtn');
    const downloadJsonBtn = document.getElementById('downloadJsonBtn');
    const gradeResumeBtn = document.getElementById('gradeResumeBtn');
    const ocrLoadingBar = document.getElementById('ocrLoadingBar');
    const showSkillsCheckbox = document.getElementById('showSkillsCheckbox');
    const showSummaryCheckbox = document.getElementById('showSummaryCheckbox');
    const centerHeaderCheckbox = document.getElementById('centerHeaderCheckbox');
    const preview = document.getElementById('resumePreview');
    const previewStatus = document.getElementById('previewStatus');
    const jsonModal = document.getElementById('jsonModal');
    const jsonInput = document.getElementById('jsonInput');
    const closeModal = document.getElementById('closeModal');
    
    // Grading Modal Elements
    const gradeModal = document.getElementById('gradeModal');
    const gradeResultsModal = document.getElementById('gradeResultsModal');
    const gradeJobDescription = document.getElementById('gradeJobDescription');
    const closeGradeModal = document.getElementById('closeGradeModal');
    const closeGradeResultsModal = document.getElementById('closeGradeResultsModal');
    const cancelGrade = document.getElementById('cancelGrade');
    const startGrading = document.getElementById('startGrading');
    const closeGradeResults = document.getElementById('closeGradeResults');
    const scoreNumber = document.getElementById('scoreNumber');
    const scoreDescription = document.getElementById('scoreDescription');
    const gradeFeedback = document.getElementById('gradeFeedback');
    const ocrProgressSection = document.getElementById('ocrProgressSection');
    const ocrProgressFill = document.getElementById('ocrProgressFill');
    const ocrProgressText = document.getElementById('ocrProgressText');
    const cancelImport = document.getElementById('cancelImport');
    const confirmImport = document.getElementById('confirmImport');

    // Authentication Elements
    const authModal = document.getElementById('authModal');
    const signUpForm = document.getElementById('signUpForm');
    const signInForm = document.getElementById('signInForm');
    const signUpFormElement = document.getElementById('signUpFormElement');
    const signInFormElement = document.getElementById('signInFormElement');
    const switchToLogin = document.getElementById('switchToLogin');
    const switchToSignUp = document.getElementById('switchToSignUp');
    const authLoading = document.getElementById('authLoading');
    const authError = document.getElementById('authError');
    const errorMessage = document.getElementById('errorMessage');
    const loadingText = document.getElementById('loadingText');
    const userInfo = document.getElementById('userInfo');
    const userEmail = document.getElementById('userEmail');
    const logoutBtn = document.getElementById('logoutBtn');
    const mainHeader = document.getElementById('mainHeader');
    const mainContent = document.querySelector('.main-content');

    // Personal Info Elements
    const personalName = document.getElementById('personalName');
    const personalAddress = document.getElementById('personalAddress');
    const personalEmail = document.getElementById('personalEmail');
    const personalPhone = document.getElementById('personalPhone');
    const savePersonalInfoBtn = document.getElementById('savePersonalInfoBtn');

    // Job Portfolio Elements
    const jobPortfolioEntries = document.getElementById('jobPortfolioEntries');
    const addJobPortfolioEntryBtn = document.getElementById('addJobPortfolioEntryBtn');

    // Job Description Elements
    const generateResumeBtn = document.getElementById('generateResumeBtn');
    const jobDescriptionModal = document.getElementById('jobDescriptionModal');
    const jobDescriptionInput = document.getElementById('jobDescriptionInput');
    const closeJobDescriptionModal = document.getElementById('closeJobDescriptionModal');
    const cancelJobDescription = document.getElementById('cancelJobDescription');
    const generateResumeFromJob = document.getElementById('generateResumeFromJob');
    const aiProgress = document.getElementById('aiProgress');
    const aiProgressFill = document.getElementById('aiProgressFill');
    const aiProgressText = document.getElementById('aiProgressText');

    // Current Resume Elements
    const fileUploadArea = document.getElementById('fileUploadArea');
    const resumeFileInput = document.getElementById('resumeFileInput');
    const uploadContent = document.getElementById('uploadContent');
    const resumePreviewContainer = document.getElementById('resumePreviewContainer');
    const resumeFilename = document.getElementById('resumeFilename');
    const viewResumeBtn = document.getElementById('viewResumeBtn');
    const removeResumeBtn = document.getElementById('removeResumeBtn');
    const resumePreviewThumbnail = document.getElementById('resumePreviewThumbnail');

    // Job Titles Elements
    const jobTitlesSection = document.getElementById('jobTitlesSection');
    const jobTitlesContainer = document.getElementById('jobTitlesContainer');
    const jobTitlesLoading = document.getElementById('jobTitlesLoading');
    const jobTitlesEmpty = document.getElementById('jobTitlesEmpty');

    // Job Edit Modal Elements
    const jobEditModal = document.getElementById('jobEditModal');
    const closeJobEditModal = document.getElementById('closeJobEditModal');
    const cancelJobEdit = document.getElementById('cancelJobEdit');
    const saveJobEdit = document.getElementById('saveJobEdit');
    const editJobTitle = document.getElementById('editJobTitle');
    const editJobCompany = document.getElementById('editJobCompany');
    const editJobStartDate = document.getElementById('editJobStartDate');
    const editJobEndDate = document.getElementById('editJobEndDate');
    const editJobLocation = document.getElementById('editJobLocation');

    // Format Settings Elements
    const formatSettingsToggle = document.getElementById('formatSettingsToggle');
    const formatSettingsContent = document.getElementById('formatSettingsContent');

    // Education Elements
    const educationSection = document.getElementById('educationSection');
    const educationContainer = document.getElementById('educationContainer');
    const educationLoading = document.getElementById('educationLoading');
    const educationEmpty = document.getElementById('educationEmpty');

    // Modal Controls
    importJsonBtn.addEventListener('click', () => {
      jsonModal.classList.add('active');
      jsonInput.focus();
    });

    closeModal.addEventListener('click', closeJsonModal);
    cancelImport.addEventListener('click', closeJsonModal);

    jsonModal.addEventListener('click', (e) => {
      if (e.target === jsonModal) {
        closeJsonModal();
      }
    });

    function closeJsonModal() {
      jsonModal.classList.remove('active');
      jsonInput.value = '';
    }

    // Grading Modal Event Listeners
    gradeResumeBtn.addEventListener('click', () => {
      if (!resumeData || !resumeData.contact) {
        alert('Please generate or import a resume first before grading.');
        return;
      }
      gradeModal.classList.add('active');
      gradeJobDescription.focus();
    });

    closeGradeModal.addEventListener('click', closeGradeModalFunc);
    cancelGrade.addEventListener('click', closeGradeModalFunc);
    closeGradeResultsModal.addEventListener('click', closeGradeResultsModalFunc);
    closeGradeResults.addEventListener('click', closeGradeResultsModalFunc);

    gradeModal.addEventListener('click', (e) => {
      if (e.target === gradeModal) {
        closeGradeModalFunc();
      }
    });

    // Character counter for grade job description
    gradeJobDescription.addEventListener('input', () => {
      const count = gradeJobDescription.value.length;
      gradeJobDescription.setAttribute('data-count', count);
    });

    gradeResultsModal.addEventListener('click', (e) => {
      if (e.target === gradeResultsModal) {
        closeGradeResultsModalFunc();
      }
    });

    startGrading.addEventListener('click', async () => {
      const jobDescription = gradeJobDescription.value.trim();
      if (!jobDescription) {
        alert('Please enter a job description to grade your resume against.');
        return;
      }
      
      closeGradeModalFunc();
      await gradeResume(jobDescription);
    });

    function closeGradeModalFunc() {
      gradeModal.classList.remove('active');
      gradeJobDescription.value = '';
    }

    function closeGradeResultsModalFunc() {
      gradeResultsModal.classList.remove('active');
    }

    // Skills checkbox listener
    showSkillsCheckbox.addEventListener('change', () => {
      if (resumeData) {
        renderResume(resumeData);
      }
      saveDisplayPreferencesToFirebase();
    });
    
    // Summary checkbox listener
    showSummaryCheckbox.addEventListener('change', () => {
      if (resumeData) {
        renderResume(resumeData);
      }
      saveDisplayPreferencesToFirebase();
    });
    
    // Center header checkbox listener
    centerHeaderCheckbox.addEventListener('change', () => {
      if (resumeData) {
        renderResume(resumeData);
      }
      saveDisplayPreferencesToFirebase();
    });

    // Format Settings Toggle
    formatSettingsToggle.addEventListener('click', () => {
      const isExpanded = formatSettingsContent.style.display !== 'none';
      
      if (isExpanded) {
        formatSettingsContent.style.display = 'none';
        formatSettingsToggle.classList.remove('expanded');
        formatSettingsToggle.querySelector('span').textContent = 'Expand Menu';
      } else {
        formatSettingsContent.style.display = 'block';
        formatSettingsToggle.classList.add('expanded');
        formatSettingsToggle.querySelector('span').textContent = 'Collapse Menu';
      }
    });

    // Import JSON Data
    confirmImport.addEventListener('click', () => {
      const jsonText = jsonInput.value.trim();
      if (!jsonText) {
        showPreviewError('Please enter JSON data');
        return;
      }

      try {
        resumeData = JSON.parse(jsonText);
        console.log('JSON imported successfully:', resumeData);
        console.log('Imported name:', resumeData?.contact?.name);
        
        // Update form fields with imported data
        if (resumeData.contact) {
          if (personalName) personalName.value = resumeData.contact.name || '';
          if (personalAddress) personalAddress.value = resumeData.contact.address || '';
          if (personalEmail) personalEmail.value = resumeData.contact.email || '';
          if (personalPhone) personalPhone.value = resumeData.contact.phone || '';
        }
        
          renderResume(resumeData);
        updatePreviewStatus('loaded', 'Data loaded successfully');
        downloadJsonBtn.disabled = false;
        downloadJsonBtn.style.display = 'block';
        gradeResumeBtn.disabled = false;
        gradeResumeBtn.style.display = 'block';
        generatePDFandStore();
        closeJsonModal();
      } catch (err) {
        showPreviewError('Invalid JSON format. Please check your data.');
        console.error('JSON Parse Error:', err);
      }
    });

    function showPreviewError(message) {
      updatePreviewStatus('error', message);
      preview.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-exclamation-triangle"></i>
          <h3>Error</h3>
          <p>${message}</p>
        </div>
      `;
      downloadJsonBtn.disabled = true;
      downloadJsonBtn.style.display = 'none';
      downloadPdfBtn.disabled = true;
      downloadPdfBtn.style.display = 'none';
      downloadOcrPdfBtn.disabled = true;
      downloadOcrPdfBtn.style.display = 'none';
      gradeResumeBtn.disabled = true;
      gradeResumeBtn.style.display = 'none';
    }

    function updatePreviewStatus(type, message) {
      previewStatus.className = `preview-status status-${type}`;
      previewStatus.innerHTML = `
        <i class="fas fa-${type === 'loaded' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
        ${message}
      `;
    }

    // JSON Download
    downloadJsonBtn.addEventListener('click', () => {
      if (!resumeData) return;
      const blob = new Blob([JSON.stringify(resumeData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'resume-data.json';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 0);
    });

    // PDF Download
    downloadPdfBtn.addEventListener('click', () => {
      if (!pdfBlobUrl) return;
      const a = document.createElement('a');
      a.href = pdfBlobUrl;
      const personName = resumeData?.contact?.name || 'resume';
      const cleanName = personName.replace(/[^a-zA-Z0-9\s-]/g, '').replace(/\s+/g, '-');
      a.download = `${cleanName}-Resume.pdf`;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(pdfBlobUrl); // optional cleanup
        pdfBlobUrl = null;
      }, 0);

      // Also export LaTeX source alongside the PDF download
      try {
        if (typeof generateLatexResume === 'function' && typeof downloadLatexSource === 'function' && resumeData) {
          const latex = generateLatexResume(resumeData);
          downloadLatexSource(latex);
        }
      } catch (e) {
        console.error('Failed to export LaTeX alongside PDF:', e);
      }
    });

    // OCR PDF Download
    downloadOcrPdfBtn.addEventListener('click', async () => {
      if (!pdfBlobUrl) return;
      
      try {
        downloadOcrPdfBtn.disabled = true;
        ocrProgressSection.style.display = 'block';
        ocrLoadingBar.style.display = 'block';
        
        // Reset loading bar
        const loadingBarFill = document.querySelector('.loading-bar-fill');
        const loadingBarText = document.querySelector('.loading-bar-text');
        if (loadingBarFill) {
          loadingBarFill.style.width = '0%';
          loadingBarFill.style.animation = 'none';
        }
        if (loadingBarText) {
          loadingBarText.textContent = 'Starting...';
        }
        
        // Fetch the PDF blob
        const response = await fetch(pdfBlobUrl);
        const pdfBlob = await response.blob();
        
        // Convert blob to array buffer
        const arrayBuffer = await pdfBlob.arrayBuffer();
        
        // Process with OCR
        const ocrPdfBlob = await processPdfWithOCR(arrayBuffer);
        
        // Download the OCR PDF with person's name
        const url = URL.createObjectURL(ocrPdfBlob);
        const a = document.createElement('a');
        a.href = url;
        const personName = resumeData?.contact?.name || 'resume';
        const cleanName = personName.replace(/[^a-zA-Z0-9\s-]/g, '').replace(/\s+/g, '-');
        a.download = `${cleanName}-Resume.pdf`;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 0);
        
      } catch (error) {
        console.error('OCR processing failed:', error);
        alert('OCR processing failed. Please try again.');
      } finally {
        downloadOcrPdfBtn.disabled = false;
        ocrProgressSection.style.display = 'none';
        ocrProgressFill.style.width = '0%';
        ocrLoadingBar.style.display = 'none';
      }
    });

    // Date parsing helper function
    function parseDate(dateString) {
      if (!dateString) return new Date(0);
      
      // Handle "Present" or current job
      if (dateString.toLowerCase() === 'present') {
        return new Date();
      }
      
      // Handle various date formats
      const months = {
        'jan': 0, 'january': 0, 'feb': 1, 'february': 1, 'mar': 2, 'march': 2,
        'apr': 3, 'april': 3, 'may': 4, 'jun': 5, 'june': 5, 'jul': 6, 'july': 6,
        'aug': 7, 'august': 7, 'sep': 8, 'september': 8, 'oct': 9, 'october': 9,
        'nov': 10, 'november': 10, 'dec': 11, 'december': 11
      };
      
      // Try to parse common formats
      const parts = dateString.toLowerCase().trim().split(/\s+/);
      
      if (parts.length >= 2) {
        const month = months[parts[0]];
        const year = parseInt(parts[1]);
        
        if (month !== undefined && !isNaN(year)) {
          return new Date(year, month, 1);
        }
      }
      
      // Try direct date parsing
      const parsed = new Date(dateString);
      if (!isNaN(parsed.getTime())) {
        return parsed;
      }
      
      // Fallback to current date if parsing fails
      console.warn(`Could not parse date: ${dateString}, using current date`);
      return new Date();
    }

    // Resume Renderer
    function renderResume(data) {
      // Sort jobs by start date (newest first)
      const sortedJobs = [...data.jobs].sort((a, b) => {
        const dateA = parseDate(a.startDate);
        const dateB = parseDate(b.startDate);
        return dateB - dateA; // Descending order (newest first)
      });

  // Get personal info values (use form values if they have content, otherwise use data)
  const name = (personalName && personalName.value.trim()) ? personalName.value : data.contact.name;
  const address = (personalAddress && personalAddress.value.trim()) ? personalAddress.value : data.contact.address;
  const email = (personalEmail && personalEmail.value.trim()) ? personalEmail.value : data.contact.email;
  const phone = (personalPhone && personalPhone.value.trim()) ? personalPhone.value : data.contact.phone;

  preview.innerHTML = `
        <div class="resume-header" data-editable="contact.name">${escapeHtml(name)}</div>
    <div class="resume-contact">
          <span data-editable="contact.address">${escapeHtml(address)}</span>
          - <a href="mailto:${escapeHtml(email)}" style="color:#4b5563;text-decoration:underline;" data-editable="contact.email">
          ${escapeHtml(email)}
        </a>
          - <span data-editable="contact.phone">${escapeHtml(phone)}</span>
    </div>
    <hr class="resume-divider">

        ${data.summary && showSummaryCheckbox.checked ? `
        <div class="section-title">Professional Summary</div>
        <div class="summary-section">
          <p data-editable="summary">${escapeHtml(data.summary)}</p>
        </div>
        ` : ''}

        <div class="section-title">Work Experience</div>
        ${sortedJobs.map((job, jobIndex) => `
          <div class="section ${jobIndex === 0 ? 'first-job-section' : ''} ${jobIndex === sortedJobs.length - 1 ? 'last-job-section' : ''}">
            <div class="job-title" data-editable="jobs.${jobIndex}.title">${escapeHtml(job.title)}</div>
        <div class="company-row">
              <span class="company" data-editable="jobs.${jobIndex}.company">${escapeHtml(job.company)}</span>
          <span class="company-details">
                - <span data-editable="jobs.${jobIndex}.location">${escapeHtml(job.location)}</span> 
                (<span data-editable="jobs.${jobIndex}.startDate">${escapeHtml(job.startDate)}</span>${job.endDate ? ' - <span data-editable="jobs.' + jobIndex + '.endDate">' + escapeHtml(job.endDate) + '</span>' : ''})
          </span>
        </div>
        <ul class="job-list">
              ${job.duties.map((duty, dutyIndex) => `
                <li data-editable="jobs.${jobIndex}.duties.${dutyIndex}" class="editable-bullet">
                  ${escapeHtml(duty)}
                </li>
              `).join('')}
        </ul>
      </div>
    `).join('')}

    <hr class="resume-divider">

        ${data.skills && Object.keys(data.skills).length > 0 && showSkillsCheckbox.checked ? `
        <div class="section-title">Technical Skills</div>
        <div class="skills-section">
          ${Object.entries(data.skills).map(([category, skills]) => `
            <div class="skill-category">
              <div class="skill-category-title">${escapeHtml(category)}:</div>
              <div class="skill-list">
                ${skills.map((skill, skillIndex) => `
                  <span class="skill-item" data-editable="skills.${category}.${skillIndex}">${escapeHtml(skill)}</span>
                `).join(', ')}
              </div>
            </div>
          `).join('')}
        </div>
        <hr class="resume-divider">
        ` : ''}

        <div class="section-title">Education/Certificates</div>
    <ul class="cert-list">
          ${data.certificates.map((cert, certIndex) => `
            <li data-editable="certificates.${certIndex}.name" class="editable-bullet">
              ${escapeHtml(typeof cert === 'string' ? cert : cert.name || '')}
            </li>
          `).join('')}
    </ul>
  `;

      // Add click event listeners for editable elements
      addEditListeners();
      
      // Regenerate PDF when resume is rendered (e.g., when display options change)
      if (resumeData) {
        generatePDFandStore();
      }
    }

    // Add event listeners for editable elements
    function addEditListeners() {
      const editableElements = preview.querySelectorAll('[data-editable]');
      
      editableElements.forEach(element => {
        element.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          const fieldPath = this.getAttribute('data-editable');
          const currentValue = this.textContent.trim();
          
          // Create input field
          const input = document.createElement('input');
          input.type = 'text';
          input.value = currentValue;
          input.className = 'inline-edit-input';
          input.style.cssText = `
            width: 100%;
            padding: 4px 8px;
            border: 2px solid var(--primary-color);
            border-radius: 4px;
            font-family: inherit;
            font-size: inherit;
            background: white;
            color: #1f2937;
            outline: none;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.2);
          `;
          
          // Replace element content with input
          const originalContent = this.innerHTML;
          this.innerHTML = '';
          this.appendChild(input);
          input.focus();
          input.select();
          
          // Handle save on Enter or blur
          const saveEdit = () => {
            const newValue = input.value.trim();
            if (newValue !== currentValue) {
              updateResumeData(fieldPath, newValue);
              renderResume(resumeData);
            } else {
              this.innerHTML = originalContent;
            }
          };
          
          const cancelEdit = () => {
            this.innerHTML = originalContent;
          };
          
          input.addEventListener('blur', saveEdit);
          input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
              e.preventDefault();
              saveEdit();
            } else if (e.key === 'Escape') {
              e.preventDefault();
              cancelEdit();
            }
          });
        });
        
        // Add hover effect
        element.style.cursor = 'pointer';
        element.addEventListener('mouseenter', function() {
          this.style.backgroundColor = 'rgba(99, 102, 241, 0.1)';
          this.style.borderRadius = '4px';
          this.style.padding = '2px 4px';
          this.style.margin = '0 -4px';
        });
        
        element.addEventListener('mouseleave', function() {
          this.style.backgroundColor = '';
          this.style.borderRadius = '';
          this.style.padding = '';
          this.style.margin = '';
        });
      });
    }

    // Update resume data at specific path
    function updateResumeData(path, value) {
      const pathParts = path.split('.');
      let current = resumeData;
      
      // Navigate to the parent object
      for (let i = 0; i < pathParts.length - 1; i++) {
        current = current[pathParts[i]];
      }
      
      // Update the value
      current[pathParts[pathParts.length - 1]] = value;
      
      // Update Personal Info form fields if it's a contact field
      if (pathParts[0] === 'contact') {
        const field = pathParts[1];
        if (field === 'name' && personalName) personalName.value = value;
        else if (field === 'address' && personalAddress) personalAddress.value = value;
        else if (field === 'email' && personalEmail) personalEmail.value = value;
        else if (field === 'phone' && personalPhone) personalPhone.value = value;
      }
      
      // Re-generate PDF after update
      generatePDFandStore();
    }

    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      return String(text)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // Generate LaTeX-based PDF
    async function generatePDFandStore() {
      downloadPdfBtn.disabled = true;
      downloadPdfBtn.style.display = 'none';
      downloadOcrPdfBtn.disabled = true;

      if (pdfBlobUrl) {
        URL.revokeObjectURL(pdfBlobUrl);
        pdfBlobUrl = null;
      }
      if (!resumeData) {
        updatePreviewStatus('error', 'No resume data available');
        return;
      }

      try {
        const latexContent = generateLatexResume(resumeData);
        const blob = await compileLatexToPDF(latexContent);

        pdfBlobUrl = URL.createObjectURL(blob);
        updatePreviewStatus('loaded', 'PDF ready (LaTeX/Server)');
        downloadPdfBtn.disabled = false;
        downloadPdfBtn.style.display = 'block';
        downloadOcrPdfBtn.disabled = false;
        gradeResumeBtn.disabled = false;
        gradeResumeBtn.style.display = 'block';
      } catch (err) {
        console.error('Server compile failed:', err);
        updatePreviewStatus('error', 'Server failed to build PDF');
        alert('PDF build failed via server. Check console for details.');
        downloadPdfBtn.disabled = true;
        downloadPdfBtn.style.display = 'none';
        downloadOcrPdfBtn.disabled = true;
        gradeResumeBtn.disabled = true;
        gradeResumeBtn.style.display = 'none';
      }
    }

    // Download LaTeX source as text file
    function downloadLatexSource(latexContent, filename = 'resume.tex') {
      try {
        const blob = new Blob([latexContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        console.log(`LaTeX source downloaded as ${filename}`);
      } catch (error) {
        console.error('Error downloading LaTeX source:', error);
      }
    }


    // Generate LaTeX resume content
    function generateLatexResume(data) {
      const escapeLatex = (text) => {
        if (!text) return '';
        return String(text)
          .replace(/\\/g, '\\textbackslash{}')
          .replace(/\{/g, '\\{')
          .replace(/\}/g, '\\}')
          .replace(/\$/g, '\\$')
          .replace(/&/g, '\\&')
          .replace(/%/g, '\\%')
          .replace(/#/g, '\\#')
          .replace(/\^/g, '\\textasciicircum{}')
          .replace(/_/g, '\\_')
          .replace(/~/g, '\\textasciitilde{}');
      };

      const formatDate = (dateStr) => {
        if (!dateStr) return '';
        return dateStr;
      };

      const formatJobDuties = (duties) => {
        if (!duties || !Array.isArray(duties)) return '';
        return duties.map(duty => {
          // Add period at the end if not already present
          const cleanDuty = duty.trim();
          const hasPeriod = cleanDuty.endsWith('.');
          return `  \\item ${escapeLatex(cleanDuty)}${hasPeriod ? '' : '.'}`;
        }).join('\n');
      };

      const formatSkills = (skills) => {
        if (!skills) return '';
        const skillCategories = Object.keys(skills);
        return skillCategories.map(category => {
          const skillList = Array.isArray(skills[category]) ? skills[category].join(', ') : '';
          return `\\textbf{${escapeLatex(category)}:} ${escapeLatex(skillList)}`;
        }).join(' \\\\\n');
      };

      const formatEducation = (education) => {
        if (!education || !Array.isArray(education)) return '';
        return education.map(edu => {
          // Replace "from" with em dash for better formatting
          const formattedEdu = edu.replace(/\s+from\s+/g, ' ‚Äî ');
          return `  \\educationentry{${escapeLatex(formattedEdu)}}`;
        }).join('\n');
      };

      const formatCertificates = (certificates) => {
        if (!certificates || !Array.isArray(certificates)) return '';
        return certificates.map(cert => {
          const certName = typeof cert === 'string' ? cert : cert.name || '';
          return `  \\educationentry{${escapeLatex(certName)}}`;
        }).join('\n');
      };

      // Generate LaTeX document
      let latex = `\\documentclass[10.5pt,a4paper]{article}

% --- Basics ---
\\usepackage{fontspec}
\\defaultfontfeatures{Ligatures=TeX}
% Use system fonts that are available - don't specify font name to use defaults
% This avoids font loading errors with Tectonic
\\renewcommand{\\familydefault}{\\sfdefault}
\\usepackage[margin=1in,top=0.5in,bottom=0.5in]{geometry}
\\usepackage{microtype}
\\usepackage{enumitem}
\\usepackage{xcolor}
\\usepackage[hidelinks]{hyperref}
\\usepackage{tabularx}
\\usepackage{array}
\\usepackage{needspace}

% --- Colors ---
\\definecolor{accent}{HTML}{0A66C2}
\\definecolor{lightgray}{gray}{0.6}
\\hypersetup{colorlinks=true, urlcolor=accent}

% --- Spacing / lists ---
\\setlength{\\parindent}{0pt}
\\linespread{1.08}
\\setlist[itemize]{leftmargin=1.5em,label=\\textbullet,itemsep=3pt,topsep=2pt}

% --- Page break control ---
\\raggedbottom
\\widowpenalty=10000
\\clubpenalty=10000
\\interlinepenalty=10000
\\brokenpenalty=10000
\\predisplaypenalty=10000
\\postdisplaypenalty=10000

% --- Custom commands for better page break control ---
\\newcommand{\\educationentry}[1]{%
  \\nopagebreak[3]%
  \\item #1%
}

% --- Unified section heading (used for ALL sections) ---
\\newcommand{\\sectiontitle}[1]{%
  \\vspace{10pt}% top breathing room
  {\\large\\bfseries\\textcolor{accent}{#1}}\\par
  \\vspace{2pt}\\textcolor{accent}{\\rule{\\textwidth}{0.6pt}}\\vspace{4pt}%
}

% --- Role block ---
\\newcommand{\\roleblock}[4]{% title, company, location, dates
  {\\textbf{#1}}\\par
  {\\itshape #2 -- #3\\ (#4)}\\par\\vspace{4pt}
}

% --- Header ---
\\pagenumbering{gobble}
\\begin{document}
\\begin{center}
{\\Huge \\bfseries ${escapeLatex(data.contact?.name || 'Your Name')}}\\par
\\vspace{4pt}
\\href{mailto:${escapeLatex(data.contact?.email || 'email@example.com')}}{${escapeLatex(data.contact?.email || 'email@example.com')}} \\,\\,|\\,\\, ${escapeLatex(data.contact?.phone || 'Phone')} \\,\\,|\\,\\, ${escapeLatex(data.contact?.address || 'Location')}
\\end{center}
\\vspace{4pt}`;

      // Professional Summary
      if (data.summary && showSummaryCheckbox.checked) {
        latex += `\n\n\\sectiontitle{Professional Summary}\n\\vspace{4pt}\n\\noindent\\parbox{\\textwidth}{\n${escapeLatex(data.summary)}\n}\n`;
      }

      // Work Experience
      if (data.jobs && data.jobs.length > 0) {
        const headerFormat = centerHeaderCheckbox.checked ? 
          `{\\centering\\sectiontitle{Work Experience}\\par}` : 
          `\\sectiontitle{Work Experience}`;

          latex += `\\vspace{4pt}\n`; // Add space before work experience
        latex += `\n\n% =========================\n% WORK EXPERIENCE\n% =========================\n${headerFormat}\n`;
        
        data.jobs.forEach((job, index) => {
          const location = job.location || 'Location';
          const dates = `${formatDate(job.startDate)} -- ${formatDate(job.endDate)}`;
          
          // Calculate space needed for this job entry
          const dutyCount = job.duties ? job.duties.length : 0;
          const estimatedLines = 4 + dutyCount; // Job title + company + dates + duties + spacing
          const spaceNeeded = `${Math.max(estimatedLines * 1.5, 8)}em`; // More aggressive spacing
          
          // Use needspace to prevent page breaks
          latex += `\n\\needspace{${spaceNeeded}}\n`;
          latex += `\\nopagebreak[4]\n`; // Strong penalty against page breaks
          
          
          // Use samepage environment to keep job entry together
          latex += `\\begin{samepage}\n`;
          latex += `\\roleblock{${escapeLatex(job.title)}}\n          {${escapeLatex(job.company)}}{${escapeLatex(location)}}{${escapeLatex(dates)}}\n`;
          
          if (job.duties && job.duties.length > 0) {
            latex += `\\begin{itemize}\n${formatJobDuties(job.duties)}\n\\end{itemize}\n`;
          }
          
          latex += `\\end{samepage}\n`;
          latex += `\\vspace{8pt}\n`; // Add space after job entry
          
          // Add page break protection between jobs
          if (index < data.jobs.length - 1) {
            latex += `\\nopagebreak[3]\n`;
          }
        });
      }

      // Skills
      if (data.skills && showSkillsCheckbox.checked) {
        const headerFormat = centerHeaderCheckbox.checked ? 
          `{\\centering\\sectiontitle{Skills}\\par}` : 
          `\\sectiontitle{Skills}`;
        latex += `\n\n% =========================\n% SKILLS\n% =========================\n${headerFormat}\n`;
        
        const skillCategories = Object.keys(data.skills);
        if (skillCategories.length > 0) {
          // Calculate space needed for skills section
          const categoryCount = skillCategories.length;
          const estimatedLines = Math.ceil(categoryCount / 2) * 3 + 4; // More conservative estimate for two-column layout + header + spacing
          const spaceNeeded = `${Math.max(estimatedLines * 1.5, 10)}em`; // More aggressive spacing
          
          // Use needspace to prevent page breaks
          latex += `\n\\needspace{${spaceNeeded}}\n`;
          latex += `\\nopagebreak[4]\n`; // Strong penalty against page breaks
          
          // Use samepage environment to keep skills section together
          latex += `\\begin{samepage}\n`;
          latex += `\\nopagebreak[4]\n`; // Additional page break prevention
          latex += `\\begin{tabularx}{\\textwidth}{@{} >{\\raggedright\\arraybackslash}X >{\\raggedright\\arraybackslash}X @{}}\n`;
          
          // Process skills in pairs
          for (let i = 0; i < skillCategories.length; i += 2) {
            const leftCategory = skillCategories[i];
            const rightCategory = skillCategories[i + 1];
            
            const leftSkills = Array.isArray(data.skills[leftCategory]) ? data.skills[leftCategory].join(', ') : '';
            const rightSkills = rightCategory && Array.isArray(data.skills[rightCategory]) ? data.skills[rightCategory].join(', ') : '';
            
            // Add page break prevention for each row
            latex += `\\nopagebreak[3]\n`;
            latex += `\\vspace{5pt}\\textbf{${escapeLatex(leftCategory)}:} ${escapeLatex(leftSkills)}`;
            latex += `\n&\n`;
            latex += `\\vspace{5pt}\\textbf{${escapeLatex(rightCategory || '')}:} ${escapeLatex(rightSkills || '')}`;
            latex += ` \\\\[4pt]\n\n`;
            
           
          }
          
          latex += `\\end{tabularx}\n`;
          latex += `\\end{samepage}\n`;
          latex += `\\vspace{8pt}\n`; // Add space after skills section
        }
      }

      // Education & Certificates (combined section)
      if ((data.education && data.education.length > 0) || (data.certificates && data.certificates.length > 0)) {
        // Calculate space needed for education section
        const eduCount = (data.education ? data.education.length : 0) + (data.certificates ? data.certificates.length : 0);
        const spaceNeeded = `${Math.max(eduCount * 1.5 + 4, 6)}em`; // More aggressive spacing
        
        // Use needspace and page break prevention for education section
        latex += `\n\n\\needspace{${spaceNeeded}}\n`;
        latex += `\\nopagebreak[4]\n`; // Strong penalty against page breaks
        const headerFormat = centerHeaderCheckbox.checked ? 
          `{\\centering\\sectiontitle{Education \\& Certifications}\\par}` : 
          `\\sectiontitle{Education \\& Certifications}`;
        latex += `\\vspace{5pt}\n% =========================\n% EDUCATION & CERTIFICATIONS\n% =========================\n${headerFormat}\n`;
        latex += `\\begin{samepage}\n`;
        latex += `\\begin{itemize}\n`;
        
        // Add education items
        if (data.education && data.education.length > 0) {
          latex += formatEducation(data.education);
        }
        
        // Add certificate items
        if (data.certificates && data.certificates.length > 0) {
          latex += formatCertificates(data.certificates);
        }
        
        latex += `\\end{itemize}\n`;
        latex += `\\end{samepage}\n`;
      }

      latex += `\n\\end{document}`;
      
      return latex;
    }

    async function compileLatexToPDF(latexContent) {
      try {
        const res = await fetch('/compile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tex: latexContent })
        });

        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          const error = (data && (data.log || data.error)) ? (data.log || data.error) : `HTTP ${res.status}`;
          throw new Error(error);
        }

        return await res.blob();
      } catch (e) {
        console.error('Server compile failed:', e);
        throw e;
      }
    }

    // Enhanced jsPDF fallback that closely mimics LaTeX output
    async function generateEnhancedPDFFallback(resumeData) {
      try {
        console.log('=== ENHANCED JSPDF FALLBACK DEBUG ===');
        console.log('Generating enhanced PDF with LaTeX-like styling...');
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
          orientation: 'portrait',
          unit: 'in',
          format: 'a4'
        });
        
        // Set up fonts and colors to match LaTeX exactly
        const accentColor = '#0A66C2';
        const textColor = '#000000';
        const lightGray = '#666666';
        
        // Page dimensions (A4: 8.27" x 11.69")
        const pageWidth = 8.27;
        const pageHeight = 11.69;
        const margin = 1.0;
        const contentWidth = pageWidth - (2 * margin);
        
        let currentY = 0.4; // Start position (matching LaTeX top margin)
        
        // Helper function to add text with proper wrapping
        const addText = (text, x, y, options = {}) => {
          const {
            fontSize = 10,
            fontStyle = 'normal',
            color = textColor,
            align = 'left',
            maxWidth = contentWidth
          } = options;
          
          doc.setFontSize(fontSize);
          doc.setFont('helvetica', fontStyle);
          doc.setTextColor(color);
          
          const lines = doc.splitTextToSize(text, maxWidth);
          doc.text(lines, x, y, { align });
          return y + (lines.length * fontSize * 0.04);
        };
        
        // Helper function to add section header (matching LaTeX \sectiontitle)
        const addSectionHeader = (title, y) => {
          // Add space before section (matching \vspace{10pt})
          const newY = addText(title, margin, y + 0.15, {
            fontSize: 12,
            fontStyle: 'bold',
            color: accentColor
          });
          
          // Add underline (matching LaTeX \rule{\textwidth}{0.6pt})
          doc.setDrawColor(accentColor);
          doc.setLineWidth(0.6);
          doc.line(margin, newY + 0.05, margin + contentWidth, newY + 0.05);
          
          return newY + 0.1; // Space after header (matching \vspace{4pt})
        };
        
        // Header (matching LaTeX \begin{center}...\end{center})
        const name = resumeData.contact?.name || 'Your Name';
        const email = resumeData.contact?.email || 'email@example.com';
        const phone = resumeData.contact?.phone || 'Phone';
        const address = resumeData.contact?.address || 'Location';
        
        currentY = addText(name, margin, currentY, {
          fontSize: 18,
          fontStyle: 'bold',
          align: 'center',
          maxWidth: contentWidth
        });
        
        currentY = addText(`${email} | ${phone} | ${address}`, margin, currentY + 0.1, {
          fontSize: 10,
          align: 'center',
          color: textColor,
          maxWidth: contentWidth
        });
        
        currentY += 0.2;
        
        // Professional Summary
        if (resumeData.summary) {
          currentY = addSectionHeader('PROFESSIONAL SUMMARY', currentY);
          currentY = addText(resumeData.summary, margin, currentY, {
            fontSize: 10,
            maxWidth: contentWidth
          });
          currentY += 0.2; // Extra space after summary
        }
        
        // Work Experience (matching LaTeX \roleblock)
        if (resumeData.jobs && resumeData.jobs.length > 0) {
          currentY = addSectionHeader('WORK EXPERIENCE', currentY);
          
          resumeData.jobs.forEach((job, index) => {
            // Job title (bold) - matching \textbf{#1}
            const jobTitle = job.title || '';
            currentY = addText(jobTitle, margin, currentY, {
              fontSize: 10,
              fontStyle: 'bold'
            });
            
            // Company -- Location (dates) (italic) - matching \itshape #2 -- #3\ (#4)
            const company = job.company || '';
            const location = job.location || '';
            const dates = `${job.startDate || ''} -- ${job.endDate || ''}`;
            currentY = addText(`${company} -- ${location} (${dates})`, margin, currentY, {
              fontSize: 10,
              fontStyle: 'italic',
              color: lightGray
            });
            
            currentY += 0.05; // Small space before duties (matching \par\vspace{4pt})
            
            // Job duties with proper bullet formatting (matching \begin{itemize})
            if (job.duties && Array.isArray(job.duties)) {
              job.duties.forEach(duty => {
                currentY = addText(`‚Ä¢ ${duty}`, margin, currentY + 0.05, {
                  fontSize: 9,
                  maxWidth: contentWidth
                });
              });
            }
            
            currentY += 0.1; // Space between jobs (matching \vspace{8pt})
          });
        }
        
        // Skills (matching LaTeX tabularx)
        if (resumeData.skills && showSkillsCheckbox.checked) {
          currentY = addSectionHeader('SKILLS', currentY);
          
          const skillCategories = Object.keys(resumeData.skills);
          if (skillCategories.length > 0) {
            // Create two-column layout for skills (matching tabularx)
            const leftColumn = [];
            const rightColumn = [];
            
            skillCategories.forEach((category, index) => {
              const skills = Array.isArray(resumeData.skills[category]) 
                ? resumeData.skills[category].join(', ') 
                : '';
              const skillText = `${category}: ${skills}`;
              
              if (index % 2 === 0) {
                leftColumn.push(skillText);
              } else {
                rightColumn.push(skillText);
              }
            });
            
            // Add skills in two columns (matching tabularx layout)
            const maxRows = Math.max(leftColumn.length, rightColumn.length);
            for (let i = 0; i < maxRows; i++) {
              const leftText = leftColumn[i] || '';
              const rightText = rightColumn[i] || '';
              
              // Left column
              if (leftText) {
                currentY = addText(leftText, margin, currentY, {
                  fontSize: 9,
                  maxWidth: contentWidth / 2 - 0.1
                });
              }
              
              // Right column
              if (rightText) {
                currentY = addText(rightText, margin + contentWidth / 2 + 0.1, currentY - (leftText ? 0.15 : 0), {
                  fontSize: 9,
                  maxWidth: contentWidth / 2 - 0.1
                });
              } else if (leftText) {
                currentY += 0.15; // Add space if only left column has content
              }
            }
          }
          currentY += 0.1;
        }
        
        // Education & Certifications (matching LaTeX itemize)
        const education = resumeData.education || [];
        const certificates = resumeData.certificates || [];
        
        if (education.length > 0 || certificates.length > 0) {
          currentY = addSectionHeader('EDUCATION & CERTIFICATIONS', currentY);
          
          // Education
          education.forEach(edu => {
            const formattedEdu = edu.replace(/\s+from\s+/g, ' ‚Äî ');
            currentY = addText(`‚Ä¢ ${formattedEdu}`, margin, currentY + 0.05, {
              fontSize: 9,
              maxWidth: contentWidth
            });
          });
          
          // Certificates
          certificates.forEach(cert => {
            const certName = typeof cert === 'string' ? cert : cert.name || '';
            currentY = addText(`‚Ä¢ ${certName}`, margin, currentY + 0.05, {
              fontSize: 9,
              maxWidth: contentWidth
            });
          });
        }
        
        // Generate PDF blob
        const pdfBlob = doc.output('blob');
        const url = URL.createObjectURL(pdfBlob);
        
        console.log('Enhanced PDF fallback generation successful');
        return pdfBlob;
        
      } catch (error) {
        console.error('Enhanced PDF fallback error:', error);
        throw error;
      }
    }


    // Fallback PDF generation using jsPDF with LaTeX styling
    async function generatePDFWithJsPDF(data) {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
      
      // PDF styling constants (matching LaTeX template)
      const pageWidth = 612; // Letter width
      const pageHeight = 792; // Letter height
      const margin = 72; // 1 inch margins
      const contentWidth = pageWidth - (margin * 2);
      let currentY = margin + 20; // Start a bit below top margin

      // Helper function to add text with word wrapping
      function addText(text, fontSize = 12, isBold = false, color = '#000000', maxWidth = contentWidth, alignment = 'left') {
        if (!text) return;
        
        pdf.setFontSize(fontSize);
        pdf.setFont('helvetica', isBold ? 'bold' : 'normal');
        pdf.setTextColor(color);
        
        const lines = pdf.splitTextToSize(String(text), maxWidth);
        for (let i = 0; i < lines.length; i++) {
          if (currentY > pageHeight - margin - 20) {
            pdf.addPage();
            currentY = margin + 20;
          }
          
          let xPos = margin;
          if (alignment === 'center') {
            xPos = pageWidth / 2;
            pdf.text(lines[i], xPos, currentY, { align: 'center' });
          } else {
            pdf.text(lines[i], xPos, currentY);
          }
          currentY += fontSize * 1.2; // Better line spacing
        }
      }

      // Helper function to add a section header (matching LaTeX \sectiontitle)
      function addSectionHeader(text) {
        currentY += 10; // Space before section
        addText(text, 14, true, '#0A66C2'); // Blue color like LaTeX
        currentY += 4; // Space after text, before line
        
        // Add blue underline (matching LaTeX rule)
        pdf.setDrawColor(10, 102, 194);
        pdf.setLineWidth(0.6);
        pdf.line(margin, currentY, pageWidth - margin, currentY);
        currentY += 6; // Space after rule
      }

      // Helper function for role blocks (matching LaTeX \roleblock)
      function addRoleBlock(title, company, location, dates) {
        addText(title, 12, true); // Bold title
        currentY += 2;
        
        const companyLocation = company + (location ? ` -- ${location}` : '');
        const dateStr = dates ? ` (${dates})` : '';
        addText(`${companyLocation}${dateStr}`, 11, false, '#666666'); // Italic style
        currentY += 6; // More space before duties
      }

      // Contact Information (centered like LaTeX)
      if (data.contact) {
        addText(data.contact.name, 20, true, '#000000', contentWidth, 'center');
        currentY += 4;
        
        const contactInfo = [];
        if (data.contact.email) contactInfo.push(data.contact.email);
        if (data.contact.phone) contactInfo.push(data.contact.phone);
        if (data.contact.address) contactInfo.push(data.contact.address);
        
        addText(contactInfo.join(' | '), 11, false, '#000000', contentWidth, 'center');
        currentY += 20;
      }

      // Professional Summary
      if (data.summary && showSummaryCheckbox.checked) {
        addSectionHeader('PROFESSIONAL SUMMARY');
        addText(data.summary, 11);
        currentY += 10;
      }

      // Work Experience
      if (data.jobs && data.jobs.length > 0) {
        addSectionHeader('WORK EXPERIENCE');
        
        data.jobs.forEach(job => {
          const location = job.location || '';
          const dates = `${job.startDate || ''} -- ${job.endDate || ''}`;
          
          addRoleBlock(job.title, job.company, location, dates);
          
          if (job.duties && job.duties.length > 0) {
            job.duties.forEach(duty => {
              addText('‚Ä¢ ' + duty, 10, false, '#000000', contentWidth - 30);
              currentY += 2; // Small space between duties
            });
          }
          currentY += 12; // More space between jobs
        });
      }

      // Skills (simplified single-column format for better layout)
      if (data.skills && showSkillsCheckbox.checked) {
        addSectionHeader('SKILLS');
        
        Object.keys(data.skills).forEach(category => {
          const skills = data.skills[category];
          if (Array.isArray(skills) && skills.length > 0) {
            addText(`${category}: ${skills.join(', ')}`, 11, false, '#000000');
            currentY += 3; // Small space between skill categories
          }
        });
        currentY += 10;
      }

      // Education & Certificates (combined section)
      if ((data.education && data.education.length > 0) || (data.certificates && data.certificates.length > 0)) {
        addSectionHeader('EDUCATION & CERTIFICATIONS');
        
        // Add education items
        if (data.education && data.education.length > 0) {
          data.education.forEach(edu => {
            addText('‚Ä¢ ' + edu, 11);
          });
        }
        
        // Add certificate items
        if (data.certificates && data.certificates.length > 0) {
          data.certificates.forEach(cert => {
            const certName = typeof cert === 'string' ? cert : cert.name || '';
            addText('‚Ä¢ ' + certName, 11);
          });
        }
        
        currentY += 10;
      }

      return pdf.output('blob');
}

// OCR Processing Functions
async function processPdfWithOCR(pdfArrayBuffer) {
  const scale = 2.0; // Using your preferred scale
  const lang = 'eng';
  
  try {
    // Load PDF with pdf-lib
    const srcDoc = await PDFLib.PDFDocument.load(pdfArrayBuffer);
    const pageCount = srcDoc.getPageCount();
    
    // Create output document
    const outDoc = await PDFLib.PDFDocument.create();
    const helv = await outDoc.embedFont(PDFLib.StandardFonts.Helvetica);
    
    // Copy all pages as vector backgrounds
    const copied = await outDoc.copyPages(srcDoc, Array.from({length: pageCount}, (_,i)=>i));
    
    // Load PDF.js for rendering
    await ensurePdfJs();
    const readerPdf = await window.pdfjsLib.getDocument({ data: pdfArrayBuffer }).promise;
    
    for (let i = 1; i <= pageCount; i++) {
      // Update progress - show progress at the START of each page
      const progress = ((i - 1) / pageCount) * 100;
      const loadingBarFill = document.querySelector('.loading-bar-fill');
      const loadingBarText = document.querySelector('.loading-bar-text');
      
      if (loadingBarFill) {
        loadingBarFill.style.width = `${progress}%`;
        loadingBarFill.style.animation = 'none'; // Stop the CSS animation
      }
      if (loadingBarText) {
        loadingBarText.textContent = `Loading page ${i}`;
      }
      
      // Render page to canvas for OCR
      const { canvas, pageWidthPts, pageHeightPts } = await renderPdfPageToCanvas(readerPdf, i, scale);
      const pageOut = outDoc.addPage(copied[i-1]);
      
      // Run OCR on the canvas
      const result = await Tesseract.recognize(canvas, lang, { logger: m => {} });
      const words = wordsFromTesseract(result);
      
      // Add hidden text layer
      drawHiddenTextLayer(pageOut, words, canvas.width, canvas.height, pageWidthPts, pageHeightPts, helv);
      
      // Clean up canvas
      canvas.width = 0;
      canvas.height = 0;
      
      // Update progress to show completion of this page
      const completionProgress = (i / pageCount) * 100;
      if (loadingBarFill) {
        loadingBarFill.style.width = `${completionProgress}%`;
      }
    }
    
    if (document.querySelector('.loading-bar-text')) {
      document.querySelector('.loading-bar-text').textContent = 'Packaging...';
    }
    const outBytes = await outDoc.save();
    
    if (document.querySelector('.loading-bar-fill')) {
      document.querySelector('.loading-bar-fill').style.width = '100%';
    }
    if (document.querySelector('.loading-bar-text')) {
      document.querySelector('.loading-bar-text').textContent = 'Complete!';
    }
    
    return new Blob([outBytes], { type: 'application/pdf' });
    
  } catch (error) {
    console.error('OCR processing error:', error);
    throw error;
  }
}

async function ensurePdfJs() {
  if (window.pdfjsLib) {
    try { 
      window.pdfjsLib.GlobalWorkerOptions.workerSrc ||= 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js'; 
    } catch(e) {}
    return window.pdfjsLib;
  }
  
  // Load pdf.js dynamically
  const script = document.createElement('script');
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
  document.head.appendChild(script);
  
  return new Promise((resolve, reject) => {
    script.onload = () => {
      window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      resolve(window.pdfjsLib);
    };
    script.onerror = reject;
  });
}

async function renderPdfPageToCanvas(pdf, pageNum, ocrScale) {
  const page = await pdf.getPage(pageNum);
  const viewportPts = page.getViewport({ scale: 1 });
  const viewport = page.getViewport({ scale: ocrScale });
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = Math.floor(viewport.width);
  canvas.height = Math.floor(viewport.height);
  await page.render({ canvasContext: ctx, viewport }).promise;
  return { canvas, pageWidthPts: viewportPts.width, pageHeightPts: viewportPts.height };
}

function wordsFromTesseract(result) {
  return (result && result.data && Array.isArray(result.data.words)) ? result.data.words : [];
}

function drawHiddenTextLayer(pageOut, words, canvasWpx, canvasHpx, pageWpts, pageHpts, font) {
  const scaleX = pageWpts / canvasWpx;
  const scaleY = pageHpts / canvasHpx;
  for (const w of words) {
    if (!w || !w.text) continue;
    const b = w.bbox || w.bbox0 || w.boundingBox || {};
    const x0px = (b.x0 ?? b.left ?? 0);
    const y1px = (b.y1 ?? b.bottom ?? ((b.y0 ?? b.top ?? 0) + 10));
    const heightPx = Math.max(1, (b.y1 ?? b.bottom ?? 0) - (b.y0 ?? b.top ?? 0));
    const fontSizePts = Math.max(6, Math.min(48, heightPx * scaleY));
    const xPts = x0px * scaleX;
    const yPts = pageHpts - y1px * scaleY; // convert to PDF coords
    pageOut.drawText(w.text, { x: xPts, y: yPts, size: fontSizePts, font, color: PDFLib.rgb(0,0,0), opacity: 0.01 });
  }
}

    // Authentication Functions
    function showAuthModal() {
      authModal.classList.add('active');
      showSignUpForm();
    }

    function hideAuthModal() {
      authModal.classList.remove('active');
      hideError();
      hideLoading();
    }

    function showSignUpForm() {
      signUpForm.style.display = 'block';
      signInForm.style.display = 'none';
      hideError();
    }

    function showSignInForm() {
      signInForm.style.display = 'block';
      signUpForm.style.display = 'none';
      hideError();
    }

    function showLoading(text = 'Processing...') {
      authLoading.style.display = 'block';
      signUpForm.style.display = 'none';
      signInForm.style.display = 'none';
      loadingText.textContent = text;
    }

    function hideLoading() {
      authLoading.style.display = 'none';
    }

    function showAuthError(message) {
      authError.style.display = 'flex';
      errorMessage.textContent = message;
    }

    function hideError() {
      authError.style.display = 'none';
    }

    function updateUIForUser(user) {
      currentUser = user;
      isAuthenticated = true;
      
      // Show main content
      mainHeader.classList.remove('hidden');
      mainContent.classList.remove('hidden');
      
      // Show user info
      userInfo.style.display = 'flex';
      userEmail.textContent = user.email;
      
      // Load user's resume, job titles, personal info, display preferences, and job portfolio
      loadUserResume();
      loadJobTitlesFromFirebase();
      loadPersonalInfoFromFirebase();
      loadDisplayPreferencesFromFirebase();
      loadJobPortfolioFromFirebase();
      
      // Hide auth modal
      hideAuthModal();
    }

    function updateUIForGuest() {
      currentUser = null;
      isAuthenticated = false;
      
      // Hide main content
      mainHeader.classList.add('hidden');
      mainContent.classList.add('hidden');
      
      // Hide user info
      userInfo.style.display = 'none';
      
      // Hide job titles section
      if (jobTitlesSection) {
        jobTitlesSection.style.display = 'none';
      }
      
      // Hide education section
      if (educationSection) {
        educationSection.style.display = 'none';
      }
      
      // Show auth modal
      showAuthModal();
    }

    // Authentication Event Listeners
    switchToLogin.addEventListener('click', (e) => {
      e.preventDefault();
      showSignInForm();
    });

    switchToSignUp.addEventListener('click', (e) => {
      e.preventDefault();
      showSignUpForm();
    });

    signUpFormElement.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('signUpEmail').value;
      const password = document.getElementById('signUpPassword').value;
      const confirmPassword = document.getElementById('signUpConfirmPassword').value;
      
      if (password !== confirmPassword) {
        showAuthError('Passwords do not match');
        return;
      }
      
      if (password.length < 6) {
        showAuthError('Password must be at least 6 characters');
        return;
      }
      
      try {
        showLoading('Creating your account...');
        const userCredential = await window.createUserWithEmailAndPassword(window.auth, email, password);
        console.log('User created:', userCredential.user);
        // updateUIForUser will be called by onAuthStateChanged
      } catch (error) {
        console.error('Sign up error:', error);
        hideLoading();
        showSignUpForm();
        
        let errorMsg = 'Failed to create account. Please try again.';
        if (error.code === 'auth/email-already-in-use') {
          errorMsg = 'This email is already registered. Please sign in instead.';
        } else if (error.code === 'auth/invalid-email') {
          errorMsg = 'Please enter a valid email address.';
        } else if (error.code === 'auth/weak-password') {
          errorMsg = 'Password is too weak. Please choose a stronger password.';
        }
        showAuthError(errorMsg);
      }
    });

    signInFormElement.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('signInEmail').value;
      const password = document.getElementById('signInPassword').value;
      
      try {
        showLoading('Signing you in...');
        const userCredential = await window.signInWithEmailAndPassword(window.auth, email, password);
        console.log('User signed in:', userCredential.user);
        // updateUIForUser will be called by onAuthStateChanged
      } catch (error) {
        console.error('Sign in error:', error);
        hideLoading();
        showSignInForm();
        
        let errorMsg = 'Failed to sign in. Please try again.';
        if (error.code === 'auth/user-not-found') {
          errorMsg = 'No account found with this email. Please sign up first.';
        } else if (error.code === 'auth/wrong-password') {
          errorMsg = 'Incorrect password. Please try again.';
        } else if (error.code === 'auth/invalid-email') {
          errorMsg = 'Please enter a valid email address.';
        } else if (error.code === 'auth/too-many-requests') {
          errorMsg = 'Too many failed attempts. Please try again later.';
        }
        showAuthError(errorMsg);
      }
    });

    logoutBtn.addEventListener('click', async () => {
      try {
        await window.signOut(window.auth);
        console.log('User signed out');
        // updateUIForGuest will be called by onAuthStateChanged
      } catch (error) {
        console.error('Sign out error:', error);
        showAuthError('Failed to sign out. Please try again.');
      }
    });

    // Initialize authentication state listener
    function initializeAuth() {
      window.onAuthStateChanged(window.auth, (user) => {
        if (user) {
          updateUIForUser(user);
        } else {
          updateUIForGuest();
        }
      });
    }

    // Personal Info Event Listeners
    function addPersonalInfoListeners() {
      [personalName, personalAddress, personalEmail, personalPhone].forEach(input => {
        if (input) {
          input.addEventListener('input', updatePersonalInfo);
        }
      });
      
      // Add explicit save button listener
      if (savePersonalInfoBtn) {
        savePersonalInfoBtn.addEventListener('click', async () => {
          console.log('Save Personal Info button clicked');
          await savePersonalInfoToFirebase();
        });
      }
    }

    function updatePersonalInfo() {
      if (resumeData) {
        // Update resume data with personal info
        resumeData.contact.name = personalName.value;
        resumeData.contact.address = personalAddress.value;
        resumeData.contact.email = personalEmail.value;
        resumeData.contact.phone = personalPhone.value;
        
        // Save to Firebase immediately
        savePersonalInfoToFirebase();
        
        // Re-render resume
        renderResume(resumeData);
        generatePDFandStore();
      }
    }

    // Save personal info to Firebase in real-time
    async function savePersonalInfoToFirebase() {
      console.log('=== SAVING PERSONAL INFO TO FIREBASE ===');
      console.log('Current user:', currentUser ? currentUser.uid : 'No user');
      console.log('Resume data exists:', !!resumeData);
      
      if (!currentUser) {
        console.error('No authenticated user - cannot save to Firebase');
        alert('Please sign in to save personal information');
        return;
      }
      
      try {
        const personalInfo = {
          name: personalName ? personalName.value : '',
          address: personalAddress ? personalAddress.value : '',
          email: personalEmail ? personalEmail.value : '',
          phone: personalPhone ? personalPhone.value : '',
          lastUpdated: new Date().toISOString()
        };
        
        console.log('Personal info to save:', personalInfo);
        
        // Save to Firestore instead of Storage to avoid CORS issues
        const personalInfoRef = doc(db, 'users', currentUser.uid, 'personalInfo', 'data');
        console.log('Firestore path: users/', currentUser.uid, '/personalInfo/data');
        
        await setDoc(personalInfoRef, personalInfo);
        console.log('‚úÖ Personal info saved to Firestore successfully!');
        
        // Show success message
        if (savePersonalInfoBtn) {
          const originalText = savePersonalInfoBtn.innerHTML;
          savePersonalInfoBtn.innerHTML = '<i class="fas fa-check"></i> Saved!';
          savePersonalInfoBtn.style.backgroundColor = '#22c55e';
          setTimeout(() => {
            savePersonalInfoBtn.innerHTML = originalText;
            savePersonalInfoBtn.style.backgroundColor = '';
          }, 2000);
        }
        
      } catch (error) {
        console.error('‚ùå Error saving personal info to Firebase:', error);
        alert('Failed to save personal information: ' + error.message);
      }
    }

    // Load personal info from Firebase
    async function loadPersonalInfoFromFirebase() {
      if (!currentUser) {
        console.log('No authenticated user - cannot load personal info');
        return;
      }
      
      console.log('=== LOADING PERSONAL INFO FROM FIREBASE ===');
      console.log('User ID:', currentUser.uid);
      
      try {
        // Load from Firestore instead of Storage to avoid CORS issues
        const personalInfoRef = doc(db, 'users', currentUser.uid, 'personalInfo', 'data');
        console.log('Firestore path: users/', currentUser.uid, '/personalInfo/data');
        
        const personalInfoDoc = await getDoc(personalInfoRef);
        
        if (!personalInfoDoc.exists()) {
          console.log('No personal info document found in Firestore');
          return;
        }
        
        const personalInfo = personalInfoDoc.data();
        console.log('Personal info loaded from Firestore:', personalInfo);
        
        // Update form fields with loaded data
        if (personalName) {
          personalName.value = personalInfo.name || '';
          console.log('Updated personalName field:', personalName.value);
        }
        if (personalAddress) {
          personalAddress.value = personalInfo.address || '';
          console.log('Updated personalAddress field:', personalAddress.value);
        }
        if (personalEmail) {
          personalEmail.value = personalInfo.email || '';
          console.log('Updated personalEmail field:', personalEmail.value);
        }
        if (personalPhone) {
          personalPhone.value = personalInfo.phone || '';
          console.log('Updated personalPhone field:', personalPhone.value);
        }
        
        // Update resume data if it exists
        if (resumeData) {
          resumeData.contact.name = personalInfo.name || '';
          resumeData.contact.address = personalInfo.address || '';
          resumeData.contact.email = personalInfo.email || '';
          resumeData.contact.phone = personalInfo.phone || '';
          
          // Re-render resume with updated personal info
          renderResume(resumeData);
        }
        
        console.log('‚úÖ Personal info loaded from Firestore successfully!');
        
        // Show success message on save button if it exists
        if (savePersonalInfoBtn) {
          const originalText = savePersonalInfoBtn.innerHTML;
          savePersonalInfoBtn.innerHTML = '<i class="fas fa-check"></i> Loaded!';
          savePersonalInfoBtn.style.backgroundColor = '#22c55e';
          setTimeout(() => {
            savePersonalInfoBtn.innerHTML = originalText;
            savePersonalInfoBtn.style.backgroundColor = '';
          }, 2000);
        }
        
      } catch (error) {
        console.log('No personal info found in Firestore (this is normal for new users):', error.message);
      }
    }

    // Job Portfolio Functions
    let jobPortfolioData = [];
    let expandedEntries = new Set(); // Track which entries are expanded
    let resumeOpenEntries = new Set(); // Track which entries have resume menu open
    let resumeEditModeEntries = new Set(); // Track which entries are in edit mode (JSON input shown below preview)

    // Initialize job portfolio event listeners
    function initializeJobPortfolio() {
      if (addJobPortfolioEntryBtn) {
        addJobPortfolioEntryBtn.addEventListener('click', addJobPortfolioEntry);
      }
    }

    // Add a new job portfolio entry
    function addJobPortfolioEntry() {
      const entryId = Date.now().toString();
      const entry = {
        id: entryId,
        jobTitle: '',
        jobDescription: '',
        dueDate: '',
        jobLink: '',
        status: 'pending', // Default status
        resumeJson: '', // Resume JSON for this entry
        questions: [] // Questions array for this entry
      };
      
      jobPortfolioData.push(entry);
      // New entries start expanded so user can fill them in
      expandedEntries.add(entryId);
      // Sort entries (new entries without due dates will go to bottom)
      sortJobPortfolioEntries();
      renderJobPortfolioEntries();
      saveJobPortfolioToFirebase();
    }

    // Toggle resume menu
    function toggleResumeMenu(entryId) {
      if (resumeOpenEntries.has(entryId)) {
        resumeOpenEntries.delete(entryId);
      } else {
        resumeOpenEntries.add(entryId);
        // Close edit menu when opening resume menu
        expandedEntries.delete(entryId);
      }
      renderJobPortfolioEntries();
    }


    // Generate resume PDF for a specific entry
    async function generateResumePDFForEntry(entryId, resumeData, previewContainer) {
      try {
        // Hide loading screen if it exists
        const loadingScreen = document.getElementById(`resumeLoading_${entryId}`);
        if (loadingScreen) {
          loadingScreen.style.display = 'none';
        }
        
        // Generate LaTeX from resume data
        const latex = generateLatexResume(resumeData);
        
        // Compile to PDF
        const pdfBlob = await compileLatexToPDF(latex);
        const pdfUrl = URL.createObjectURL(pdfBlob);
        
        // Show preview
        const iframe = previewContainer.querySelector('.resume-preview-iframe');
        if (iframe) {
          iframe.src = pdfUrl;
          previewContainer.style.display = 'block';
          previewContainer.classList.add('active');
        }
        
        // Store PDF URL for download
        const entry = jobPortfolioData.find(e => e.id === entryId);
        if (entry) {
          entry._pdfBlobUrl = pdfUrl;
        }
      } catch (error) {
        console.error('Error generating PDF preview:', error);
        previewContainer.style.display = 'none';
        previewContainer.classList.remove('active');
        // Hide loading screen on error too
        const loadingScreen = document.getElementById(`resumeLoading_${entryId}`);
        if (loadingScreen) {
          loadingScreen.style.display = 'none';
        }
      }
    }

    // Download resume PDF for a specific entry
    async function downloadResumePDFForEntry(entryId, resumeData) {
      try {
        // Get the entry to access job title
        const entry = jobPortfolioData.find(e => e.id === entryId);
        const jobTitle = entry?.jobTitle || 'Resume';
        
        // Clean job title for filename (remove special characters, replace spaces with hyphens)
        const cleanJobTitle = jobTitle.replace(/[^a-zA-Z0-9\s-]/g, '').replace(/\s+/g, '-') || 'Resume';
        
        // Generate LaTeX from resume data
        const latex = generateLatexResume(resumeData);
        
        // Compile to PDF
        const pdfBlob = await compileLatexToPDF(latex);
        const pdfUrl = URL.createObjectURL(pdfBlob);
        
        // Download PDF
        const pdfLink = document.createElement('a');
        pdfLink.href = pdfUrl;
        pdfLink.download = `${cleanJobTitle}.pdf`;
        document.body.appendChild(pdfLink);
        pdfLink.click();
        setTimeout(() => {
          document.body.removeChild(pdfLink);
          URL.revokeObjectURL(pdfUrl);
        }, 100);
        
        // Create and download LaTeX .txt file
        const latexBlob = new Blob([latex], { type: 'text/plain' });
        const latexUrl = URL.createObjectURL(latexBlob);
        const latexLink = document.createElement('a');
        latexLink.href = latexUrl;
        latexLink.download = `${cleanJobTitle}.txt`;
        document.body.appendChild(latexLink);
        latexLink.click();
        setTimeout(() => {
          document.body.removeChild(latexLink);
          URL.revokeObjectURL(latexUrl);
        }, 100);
      } catch (error) {
        console.error('Error downloading PDF:', error);
        throw error;
      }
    }

    // Download zip file with resume PDF, job description, and master prompt
    async function downloadJobApplicationZip(entryId) {
      try {
        // Check if JSZip is available
        if (typeof JSZip === 'undefined') {
          alert('JSZip library not loaded. Please refresh the page and try again.');
          return;
        }

        const entry = jobPortfolioData.find(e => e.id === entryId);
        if (!entry) {
          alert('Entry not found');
          return;
        }

        const jobTitle = entry?.jobTitle || 'Resume';
        const cleanJobTitle = jobTitle.replace(/[^a-zA-Z0-9\s-]/g, '').replace(/\s+/g, '-') || 'Resume';

        // Master prompt text
        const masterPrompt = `You are a resume and government job application writing assistant. Your goal is to write responses that are clear, direct, technically confident, and easy for a tired human reviewer to read. Avoid long sentences, corporate filler, vague claims, or buzzword padding. Every response must follow this structure:

EXPERIENCE ‚Üí KNOWLEDGE ‚Üí SKILLS/APPLICATION

- EXPERIENCE: Identify specific relevant experience by role, organization, and environment.

- KNOWLEDGE: Explain what technical or operational understanding was gained from that experience.

- SKILLS/APPLICATION: Show exactly how that knowledge is applied using concrete actions, tools, and outcomes.

STYLE REQUIREMENTS:

- Write in short, readable sentences.

- Use plain professional language.

- Show competence through examples, not adjectives.

- Use technical keywords relevant to the job description for ATS optimization.

- Use bullet points only when they improve readability.

- Avoid fluff, repetition, or unnecessary storytelling.

- End each response by reinforcing capability relevant to the question.

TONE:

- Confident but not arrogant.

- Skilled but not exaggerated.

- Government professional tone.

- No word salad. No filler.

DO NOT:

- Do not use long paragraphs of more than 4 lines.

- Do not write generic statements like "I am passionate" or "I have strong communication skills."

- Do not restate the question.

- Do not talk about unrelated experience.

- Do not overuse adjectives like "excellent," "highly," or "strong."

PRIMARY GOAL:

Produce responses that clearly show: I have this experience ‚Üí it taught me this knowledge ‚Üí I used it to apply these skills to solve real problems.`;

        const zip = new JSZip();

        // Add resume PDF if it exists
        if (entry.resumeJson && entry.resumeJson.trim()) {
          try {
            const resumeData = safeJsonParse(entry.resumeJson);
            const latex = generateLatexResume(resumeData);
            const pdfBlob = await compileLatexToPDF(latex);
            zip.file(`${cleanJobTitle}-Resume.pdf`, pdfBlob);
          } catch (error) {
            console.error('Error generating PDF for zip:', error);
            // Continue without PDF if generation fails
          }
        }

        // Add job description
        if (entry.jobDescription && entry.jobDescription.trim()) {
          zip.file(`${cleanJobTitle}-JobDescription.txt`, entry.jobDescription);
        }

        // Add master prompt
        zip.file('Master-Prompt.txt', masterPrompt);

        // Generate zip file
        const zipBlob = await zip.generateAsync({ type: 'blob' });
        const zipUrl = URL.createObjectURL(zipBlob);

        // Download zip
        const zipLink = document.createElement('a');
        zipLink.href = zipUrl;
        zipLink.download = `${cleanJobTitle}-Application.zip`;
        document.body.appendChild(zipLink);
        zipLink.click();
        setTimeout(() => {
          document.body.removeChild(zipLink);
          URL.revokeObjectURL(zipUrl);
        }, 100);
      } catch (error) {
        console.error('Error creating zip file:', error);
        alert('Error creating zip file. Please try again.');
      }
    }

    // Toggle entry expansion
    function toggleEntryExpansion(entryId) {
      if (expandedEntries.has(entryId)) {
        expandedEntries.delete(entryId);
      } else {
        expandedEntries.add(entryId);
        // Close resume menu when opening edit menu
        resumeOpenEntries.delete(entryId);
      }
      renderJobPortfolioEntries();
    }

    // Format date for display
    function formatDateForDisplay(dateString) {
      if (!dateString) return '';
      try {
        const date = new Date(dateString + 'T00:00:00'); // Add time to avoid timezone issues
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      } catch (e) {
        return dateString;
      }
    }

    // Remove a job portfolio entry
    function removeJobPortfolioEntry(entryId) {
      jobPortfolioData = jobPortfolioData.filter(entry => entry.id !== entryId);
      expandedEntries.delete(entryId); // Remove from expanded set
      renderJobPortfolioEntries();
      saveJobPortfolioToFirebase();
    }

    // Sanitize JSON by fixing common control character issues
    function sanitizeJson(jsonString) {
      if (!jsonString || !jsonString.trim()) return jsonString;
      
      try {
        // First, try to parse as-is - if it works, return it
        JSON.parse(jsonString);
        return jsonString;
      } catch (e) {
        // If parsing fails, try to fix common issues
        let fixed = jsonString;
        
        // Fix the specific case where there's a newline between quote and closing quote
        // Pattern: "value\n" where \n is a literal newline (not escaped)
        // This handles cases like: "email": "value\n",
        fixed = fixed.replace(/"([^"]*?)\r?\n\s*"/gm, (match, content) => {
          // Remove trailing whitespace - the newline is outside the string, so we just remove it
          return `"${content.trim()}"`;
        });
        
        // Fix unescaped control characters within string values
        // Process string values character by character to handle escaped sequences properly
        let result = '';
        let inString = false;
        let escapeNext = false;
        
        for (let i = 0; i < fixed.length; i++) {
          const char = fixed[i];
          
          if (escapeNext) {
            result += char;
            escapeNext = false;
            continue;
          }
          
          if (char === '\\') {
            result += char;
            escapeNext = true;
            continue;
          }
          
          if (char === '"') {
            inString = !inString;
            result += char;
            continue;
          }
          
          if (inString) {
            // Inside a string - escape control characters
            if (char === '\n') result += '\\n';
            else if (char === '\r') result += '\\r';
            else if (char === '\t') result += '\\t';
            else if (char === '\f') result += '\\f';
            else if (char === '\b') result += '\\b';
            else result += char;
          } else {
            result += char;
          }
        }
        
        return result;
      }
    }
    
    // Safe JSON parse that tries to sanitize first
    function safeJsonParse(jsonString) {
      if (!jsonString || !jsonString.trim()) return null;
      
      try {
        return JSON.parse(jsonString);
      } catch (e) {
        // Try sanitizing and parsing again
        try {
          const sanitized = sanitizeJson(jsonString);
          return JSON.parse(sanitized);
        } catch (e2) {
          throw e; // Throw original error if sanitization doesn't help
        }
      }
    }

    // Update a job portfolio entry
    function updateJobPortfolioEntry(entryId, field, value) {
      const entry = jobPortfolioData.find(e => e.id === entryId);
      if (entry) {
        entry[field] = value;
        // Re-sort and re-render if due date or status changed
        if (field === 'dueDate' || field === 'status') {
          sortJobPortfolioEntries();
          renderJobPortfolioEntries();
        }
        // Always save to Firebase
        saveJobPortfolioToFirebase();
      }
    }

    // Auto-grow function for textareas
    function autoGrowTextarea(textarea) {
      // Reset height to auto to get the correct scrollHeight
      textarea.style.height = 'auto';
      // Set height to scrollHeight (CSS min/max will handle constraints)
      const newHeight = textarea.scrollHeight;
      textarea.style.height = newHeight + 'px';
    }

    // Create a question entry element
    function createQuestionEntry(entryId, questionIndex, question) {
      const questionEntry = document.createElement('div');
      questionEntry.className = 'question-entry';
      questionEntry.id = `questionEntry_${entryId}_${questionIndex}`;
      
      // Question entry header
      const questionHeader = document.createElement('div');
      questionHeader.className = 'question-entry-header';
      
      // Question title input (converted to textarea for auto-grow)
      const questionTitleInput = document.createElement('textarea');
      questionTitleInput.className = 'question-entry-title-input';
      questionTitleInput.placeholder = 'Enter question title';
      questionTitleInput.value = question.title || '';
      questionTitleInput.setAttribute('data-entry-id', entryId);
      questionTitleInput.setAttribute('data-question-index', questionIndex);
      questionTitleInput.setAttribute('data-field', 'title');
      // Set small initial height for empty fields (10% taller)
      if (!question.title || question.title.trim() === '') {
        questionTitleInput.style.height = '2.486rem';
        questionTitleInput.style.minHeight = '2.486rem';
        questionTitleInput.style.maxHeight = '2.486rem';
      }
      
      // Remove question button
      const removeQuestionBtn = document.createElement('button');
      removeQuestionBtn.className = 'question-entry-remove-btn';
      removeQuestionBtn.innerHTML = '<i class="fas fa-trash"></i> Remove';
      removeQuestionBtn.addEventListener('click', () => {
        const entry = jobPortfolioData.find(e => e.id === entryId);
        if (entry && entry.questions) {
          entry.questions.splice(questionIndex, 1);
          // Re-render to update indices
          renderJobPortfolioEntries();
          // Save to Firebase
          saveJobPortfolioToFirebase();
        }
      });
      
      questionHeader.appendChild(questionTitleInput);
      questionHeader.appendChild(removeQuestionBtn);
      
      // Question answer textarea
      const questionAnswerTextarea = document.createElement('textarea');
      questionAnswerTextarea.className = 'question-entry-answer';
      questionAnswerTextarea.placeholder = 'Enter your answer...';
      questionAnswerTextarea.value = question.answer || '';
      questionAnswerTextarea.setAttribute('data-entry-id', entryId);
      questionAnswerTextarea.setAttribute('data-question-index', questionIndex);
      questionAnswerTextarea.setAttribute('data-field', 'answer');
      // Set small initial height for empty fields (10% taller)
      if (!question.answer || question.answer.trim() === '') {
        // Padding top + bottom (0.75rem each = 1.5rem) + line-height for one line
        questionAnswerTextarea.style.height = '3.036rem';
        questionAnswerTextarea.style.minHeight = '3.036rem';
      }
      
      // Auto-grow on focus and input for title
      questionTitleInput.addEventListener('focus', () => {
        // Remove max-height constraint when focused
        questionTitleInput.style.maxHeight = '300px';
        autoGrowTextarea(questionTitleInput);
      });
      questionTitleInput.addEventListener('input', () => {
        // Remove max-height constraint when typing
        questionTitleInput.style.maxHeight = '300px';
        autoGrowTextarea(questionTitleInput);
        updateQuestionField(entryId, questionIndex, 'title', questionTitleInput.value);
      });
      
      // Auto-grow on focus and input for answer
      questionAnswerTextarea.addEventListener('focus', () => {
        autoGrowTextarea(questionAnswerTextarea);
      });
      questionAnswerTextarea.addEventListener('input', () => {
        autoGrowTextarea(questionAnswerTextarea);
        updateQuestionField(entryId, questionIndex, 'answer', questionAnswerTextarea.value);
      });
      
      // Add double-click to copy functionality for question title
      questionTitleInput.addEventListener('dblclick', async () => {
        const textToCopy = questionTitleInput.value;
        if (textToCopy && textToCopy.trim()) {
          try {
            await navigator.clipboard.writeText(textToCopy);
            
            // Visual indicator - add a class temporarily
            questionTitleInput.classList.add('copied-indicator');
            
            // Remove the indicator after 1 second
            setTimeout(() => {
              questionTitleInput.classList.remove('copied-indicator');
            }, 1000);
          } catch (err) {
            console.error('Failed to copy:', err);
          }
        }
      });
      
      // Add double-click to copy functionality for question answer
      questionAnswerTextarea.addEventListener('dblclick', async () => {
        const textToCopy = questionAnswerTextarea.value;
        if (textToCopy && textToCopy.trim()) {
          try {
            await navigator.clipboard.writeText(textToCopy);
            
            // Visual indicator - add a class temporarily
            questionAnswerTextarea.classList.add('copied-indicator');
            
            // Remove the indicator after 1 second
            setTimeout(() => {
              questionAnswerTextarea.classList.remove('copied-indicator');
            }, 1000);
          } catch (err) {
            console.error('Failed to copy:', err);
          }
        }
      });
      
      // Auto-grow for fields with existing content
      setTimeout(() => {
        if (questionTitleInput.value.trim() !== '') {
          autoGrowTextarea(questionTitleInput);
        }
        if (questionAnswerTextarea.value.trim() !== '') {
          autoGrowTextarea(questionAnswerTextarea);
        }
      }, 0);
      
      questionEntry.appendChild(questionHeader);
      questionEntry.appendChild(questionAnswerTextarea);
      
      return questionEntry;
    }
    
    // Update a question field
    function updateQuestionField(entryId, questionIndex, field, value) {
      const entry = jobPortfolioData.find(e => e.id === entryId);
      if (entry && entry.questions && entry.questions[questionIndex]) {
        entry.questions[questionIndex][field] = value;
        // Save to Firebase
        saveJobPortfolioToFirebase();
      }
    }

    // Sort job portfolio entries by status priority, then by due date
    // Priority order: Accepted > Pending > Applied > Rejected
    function sortJobPortfolioEntries() {
      jobPortfolioData.sort((a, b) => {
        const statusA = a.status || 'pending';
        const statusB = b.status || 'pending';
        
        // Define status priority (lower number = higher priority)
        const statusPriority = {
          'accepted': 1,
          'pending': 2,
          'applied': 3,
          'rejected': 4
        };
        
        const priorityA = statusPriority[statusA] || 2;
        const priorityB = statusPriority[statusB] || 2;
        
        // First, sort by status priority
        if (priorityA !== priorityB) {
          return priorityA - priorityB;
        }
        
        // Same status - sort by due date (nearest first)
        // Entries without due dates go to the bottom within their status group
        if (!a.dueDate && !b.dueDate) return 0;
        if (!a.dueDate) return 1; // a goes after b (to bottom)
        if (!b.dueDate) return -1; // a goes before b (to top)
        
        // Compare dates (nearest first - ascending order)
        const dateA = new Date(a.dueDate);
        const dateB = new Date(b.dueDate);
        
        // Check for invalid dates
        if (isNaN(dateA.getTime()) && isNaN(dateB.getTime())) return 0;
        if (isNaN(dateA.getTime())) return 1; // Invalid date goes to bottom
        if (isNaN(dateB.getTime())) return -1; // Valid date goes to top
        
        return dateA - dateB; // Ascending order (earliest dates first)
      });
    }

    // Render all job portfolio entries
    async function renderJobPortfolioEntries() {
      if (!jobPortfolioEntries) return;
      
      jobPortfolioEntries.innerHTML = '';
      
      if (jobPortfolioData.length === 0) {
        const emptyState = document.createElement('div');
        emptyState.className = 'job-portfolio-empty';
        emptyState.style.cssText = 'text-align: center; padding: 2rem; color: var(--text-muted);';
        emptyState.innerHTML = '<i class="fas fa-briefcase" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i><p>No job applications yet. Click "Add New Entry" to get started.</p>';
        jobPortfolioEntries.appendChild(emptyState);
        return;
      }
      
      // Sort entries by due date before rendering
      sortJobPortfolioEntries();
      
      jobPortfolioData.forEach(entry => {
        const isExpanded = expandedEntries.has(entry.id);
        const status = entry.status || 'pending'; // Default to pending if not set
        const entryElement = document.createElement('div');
        const isResumeOpen = resumeOpenEntries.has(entry.id);
        entryElement.className = `job-portfolio-entry ${isExpanded ? 'expanded' : 'collapsed'} ${isResumeOpen ? 'resume-open' : ''} status-${status}`;
        
        // Create header with preview info
        const header = document.createElement('div');
        header.className = 'job-portfolio-entry-header';
        
        const preview = document.createElement('div');
        preview.className = 'job-portfolio-entry-preview';
        
        const title = document.createElement('div');
        title.className = 'job-portfolio-entry-title';
        title.textContent = entry.jobTitle || 'Untitled Entry';
        preview.appendChild(title);
        
        const dueDate = document.createElement('div');
        dueDate.className = 'job-portfolio-entry-due-date';
        dueDate.textContent = entry.dueDate ? formatDateForDisplay(entry.dueDate) : 'No due date';
        preview.appendChild(dueDate);
        
        header.appendChild(preview);
        
        // Create actions container
        const actions = document.createElement('div');
        actions.className = 'job-portfolio-entry-actions';
        
        // Download zip button (icon only, grey colored) - to the left of status dropdown
        const downloadZipHeaderBtn = document.createElement('button');
        downloadZipHeaderBtn.className = 'job-portfolio-entry-download';
        downloadZipHeaderBtn.innerHTML = '<i class="fas fa-download"></i>';
        downloadZipHeaderBtn.setAttribute('data-entry-id', entry.id);
        downloadZipHeaderBtn.title = 'Download Application Package (PDF, Job Description, Master Prompt)';
        downloadZipHeaderBtn.addEventListener('click', async () => {
          const entryId = downloadZipHeaderBtn.getAttribute('data-entry-id');
          await downloadJobApplicationZip(entryId);
        });
        actions.appendChild(downloadZipHeaderBtn);
        
        // Status dropdown (without label)
        const statusContainer = document.createElement('div');
        statusContainer.className = 'job-portfolio-entry-status';
        const statusSelect = document.createElement('select');
        statusSelect.id = `status_${entry.id}`;
        statusSelect.setAttribute('data-entry-id', entry.id);
        statusSelect.setAttribute('data-field', 'status');
        
        // Create options
        const options = [
          { value: 'pending', text: 'Pending' },
          { value: 'applied', text: 'Applied' },
          { value: 'accepted', text: 'Accepted' },
          { value: 'rejected', text: 'Rejected' }
        ];
        
        options.forEach(option => {
          const optionElement = document.createElement('option');
          optionElement.value = option.value;
          optionElement.textContent = option.text;
          if (option.value === status) {
            optionElement.selected = true;
          }
          statusSelect.appendChild(optionElement);
        });
        
        statusSelect.addEventListener('change', (e) => {
          const entryId = e.target.getAttribute('data-entry-id');
          const newStatus = e.target.value;
          updateJobPortfolioEntry(entryId, 'status', newStatus);
          // Re-render to update border color
          renderJobPortfolioEntries();
        });
        
        statusContainer.appendChild(statusSelect);
        actions.appendChild(statusContainer);
        
        // Resume button (to the left of Edit)
        const resumeBtn = document.createElement('button');
        resumeBtn.className = 'job-portfolio-entry-resume';
        resumeBtn.innerHTML = isResumeOpen 
          ? '<i class="fas fa-chevron-up"></i> Close Resume' 
          : '<i class="fas fa-file-alt"></i> Resume';
        resumeBtn.addEventListener('click', () => toggleResumeMenu(entry.id));
        actions.appendChild(resumeBtn);
        
        // Edit button
        const editBtn = document.createElement('button');
        editBtn.className = 'job-portfolio-entry-edit';
        editBtn.innerHTML = isExpanded 
          ? '<i class="fas fa-chevron-up"></i> Close' 
          : '<i class="fas fa-edit"></i> Edit';
        editBtn.addEventListener('click', () => toggleEntryExpansion(entry.id));
        actions.appendChild(editBtn);
        
        const removeBtn = document.createElement('button');
        removeBtn.className = 'job-portfolio-entry-remove';
        removeBtn.innerHTML = '<i class="fas fa-trash"></i> Remove';
        removeBtn.addEventListener('click', () => removeJobPortfolioEntry(entry.id));
        actions.appendChild(removeBtn);
        
        header.appendChild(actions);
        entryElement.appendChild(header);
        
        // Create collapsible content container
        const content = document.createElement('div');
        content.className = 'job-portfolio-entry-content';
        
        // Create fields container
        const fieldsContainer = document.createElement('div');
        fieldsContainer.className = 'job-portfolio-entry-fields';
        
        // Job Title field
        const jobTitleField = document.createElement('div');
        jobTitleField.className = 'job-portfolio-entry-field';
        const jobTitleLabel = document.createElement('label');
        jobTitleLabel.setAttribute('for', `jobTitle_${entry.id}`);
        jobTitleLabel.textContent = 'Job Title';
        const jobTitleInput = document.createElement('input');
        jobTitleInput.type = 'text';
        jobTitleInput.id = `jobTitle_${entry.id}`;
        jobTitleInput.placeholder = 'Enter job title';
        jobTitleInput.value = entry.jobTitle || '';
        jobTitleInput.setAttribute('data-entry-id', entry.id);
        jobTitleInput.setAttribute('data-field', 'jobTitle');
        jobTitleField.appendChild(jobTitleLabel);
        jobTitleField.appendChild(jobTitleInput);
        fieldsContainer.appendChild(jobTitleField);
        
        // Due Date field
        const dueDateField = document.createElement('div');
        dueDateField.className = 'job-portfolio-entry-field';
        const dueDateLabel = document.createElement('label');
        dueDateLabel.setAttribute('for', `dueDate_${entry.id}`);
        dueDateLabel.textContent = 'Due Date';
        const dueDateInput = document.createElement('input');
        dueDateInput.type = 'date';
        dueDateInput.id = `dueDate_${entry.id}`;
        dueDateInput.value = entry.dueDate || '';
        dueDateInput.setAttribute('data-entry-id', entry.id);
        dueDateInput.setAttribute('data-field', 'dueDate');
        dueDateField.appendChild(dueDateLabel);
        dueDateField.appendChild(dueDateInput);
        fieldsContainer.appendChild(dueDateField);
        
        // Job Description field (full width)
        const jobDescField = document.createElement('div');
        jobDescField.className = 'job-portfolio-entry-field full-width';
        const jobDescLabel = document.createElement('label');
        jobDescLabel.setAttribute('for', `jobDescription_${entry.id}`);
        jobDescLabel.textContent = 'Job Description';
        const jobDescTextarea = document.createElement('textarea');
        jobDescTextarea.id = `jobDescription_${entry.id}`;
        jobDescTextarea.placeholder = 'Enter job description (as long as you want)';
        jobDescTextarea.textContent = entry.jobDescription || '';
        jobDescTextarea.setAttribute('data-entry-id', entry.id);
        jobDescTextarea.setAttribute('data-field', 'jobDescription');
        
        // Add double-click to copy functionality
        jobDescTextarea.addEventListener('dblclick', async () => {
          const textToCopy = jobDescTextarea.value;
          if (textToCopy && textToCopy.trim()) {
            try {
              await navigator.clipboard.writeText(textToCopy);
              
              // Visual indicator - add a class temporarily
              jobDescTextarea.classList.add('copied-indicator');
              
              // Remove the indicator after 1 second
              setTimeout(() => {
                jobDescTextarea.classList.remove('copied-indicator');
              }, 1000);
            } catch (err) {
              console.error('Failed to copy:', err);
            }
          }
        });
        
        jobDescField.appendChild(jobDescLabel);
        jobDescField.appendChild(jobDescTextarea);
        fieldsContainer.appendChild(jobDescField);
        
        // Job Link field (full width)
        const jobLinkField = document.createElement('div');
        jobLinkField.className = 'job-portfolio-entry-field full-width';
        const jobLinkLabel = document.createElement('label');
        jobLinkLabel.setAttribute('for', `jobLink_${entry.id}`);
        jobLinkLabel.textContent = 'Job Link';
        const jobLinkInput = document.createElement('input');
        jobLinkInput.type = 'url';
        jobLinkInput.id = `jobLink_${entry.id}`;
        jobLinkInput.placeholder = 'Enter job application link';
        jobLinkInput.value = entry.jobLink || '';
        jobLinkInput.setAttribute('data-entry-id', entry.id);
        jobLinkInput.setAttribute('data-field', 'jobLink');
        
        // Add double-click to copy functionality
        jobLinkInput.addEventListener('dblclick', async () => {
          const textToCopy = jobLinkInput.value;
          if (textToCopy && textToCopy.trim()) {
            try {
              await navigator.clipboard.writeText(textToCopy);
              
              // Visual indicator - add a class temporarily
              jobLinkInput.classList.add('copied-indicator');
              
              // Remove the indicator after 1 second
              setTimeout(() => {
                jobLinkInput.classList.remove('copied-indicator');
              }, 1000);
            } catch (err) {
              console.error('Failed to copy:', err);
            }
          }
        });
        
        // Add triple-click to open link in new tab
        let clickCount = 0;
        let clickTimer = null;
        jobLinkInput.addEventListener('mousedown', (e) => {
          clickCount++;
          if (clickTimer) {
            clearTimeout(clickTimer);
          }
          clickTimer = setTimeout(() => {
            if (clickCount === 3) {
              e.preventDefault(); // Prevent text selection
              const linkUrl = jobLinkInput.value.trim();
              if (linkUrl) {
                // Ensure URL has protocol
                let urlToOpen = linkUrl;
                if (!urlToOpen.startsWith('http://') && !urlToOpen.startsWith('https://')) {
                  urlToOpen = 'https://' + urlToOpen;
                }
                window.open(urlToOpen, '_blank');
              }
            }
            clickCount = 0;
          }, 400);
        });
        
        jobLinkField.appendChild(jobLinkLabel);
        jobLinkField.appendChild(jobLinkInput);
        fieldsContainer.appendChild(jobLinkField);
        
        // Questions section (full width)
        const questionsSection = document.createElement('div');
        questionsSection.className = 'job-portfolio-entry-field full-width';
        questionsSection.style.cssText = 'margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);';
        
        const questionsLabel = document.createElement('label');
        questionsLabel.textContent = 'Questions';
        questionsLabel.style.cssText = 'font-size: 1rem; font-weight: 500; color: var(--text-primary); margin-bottom: 1rem; display: block;';
        
        // Initialize questions array if it doesn't exist
        if (!entry.questions) {
          entry.questions = [];
        }
        
        // Questions container
        const questionsContainer = document.createElement('div');
        questionsContainer.className = 'questions-container';
        questionsContainer.id = `questionsContainer_${entry.id}`;
        
        // Empty state
        const questionsEmptyState = document.createElement('div');
        questionsEmptyState.className = 'questions-empty-state';
        questionsEmptyState.id = `questionsEmptyState_${entry.id}`;
        questionsEmptyState.textContent = 'You currently have no questions for this entry';
        questionsEmptyState.style.display = entry.questions.length === 0 ? 'block' : 'none';
        
        // Render existing questions
        entry.questions.forEach((question, questionIndex) => {
          const questionEntry = createQuestionEntry(entry.id, questionIndex, question);
          questionsContainer.appendChild(questionEntry);
          
          // Add one line break after each question answer except the last one
          if (questionIndex < entry.questions.length - 1) {
            const br = document.createElement('br');
            questionsContainer.appendChild(br);
          }
        });
        
        // Add question button
        const addQuestionBtn = document.createElement('button');
        addQuestionBtn.className = 'add-question-btn';
        addQuestionBtn.textContent = 'Add question';
        addQuestionBtn.addEventListener('click', () => {
          // Add new question to entry
          if (!entry.questions) {
            entry.questions = [];
          }
          const newQuestion = {
            title: '',
            answer: ''
          };
          entry.questions.push(newQuestion);
          
          // Update empty state
          const emptyState = document.getElementById(`questionsEmptyState_${entry.id}`);
          if (emptyState) {
            emptyState.style.display = 'none';
          }
          
          // Create and add question entry
          const questionEntry = createQuestionEntry(entry.id, entry.questions.length - 1, newQuestion);
          const container = document.getElementById(`questionsContainer_${entry.id}`);
          if (container) {
            // If there were previous questions, find the last question entry and add breaks after it
            if (entry.questions.length > 1) {
              // Find the previous last question entry (before we added the new one, it was the last)
              const previousLastIndex = entry.questions.length - 2;
              const previousLastEntry = container.querySelector(`#questionEntry_${entry.id}_${previousLastIndex}`);
              if (previousLastEntry) {
                // Add one line break after the previous last question
                const br = document.createElement('br');
                previousLastEntry.after(br);
              }
            }
            container.appendChild(questionEntry);
          }
          
          // Save to Firebase
          saveJobPortfolioToFirebase();
        });
        
        questionsSection.appendChild(questionsLabel);
        questionsSection.appendChild(questionsEmptyState);
        questionsSection.appendChild(questionsContainer);
        questionsSection.appendChild(addQuestionBtn);
        fieldsContainer.appendChild(questionsSection);
        
        content.appendChild(fieldsContainer);
        entryElement.appendChild(content);
        
        // Create resume menu section
        const resumeMenu = document.createElement('div');
        resumeMenu.className = 'job-portfolio-entry-resume-menu';
        
        const resumeMenuContent = document.createElement('div');
        resumeMenuContent.className = 'resume-menu-content';
        
        // Check if entry has existing resume JSON data
        const hasExistingResumeJson = entry.resumeJson && entry.resumeJson.trim();
        const isEditMode = resumeEditModeEntries.has(entry.id);
        
        // Resume JSON input section (wrapper for conditional display)
        const resumeJsonSection = document.createElement('div');
        resumeJsonSection.className = 'resume-json-section';
        
        const resumeJsonLabel = document.createElement('label');
        resumeJsonLabel.setAttribute('for', `resumeJson_${entry.id}`);
        resumeJsonLabel.textContent = 'Resume JSON';
        resumeJsonLabel.style.cssText = 'font-size: 0.9rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.5rem; display: block;';
        
        const resumeJsonInput = document.createElement('textarea');
        resumeJsonInput.id = `resumeJson_${entry.id}`;
        resumeJsonInput.className = 'resume-json-input';
        resumeJsonInput.placeholder = 'Paste your resume JSON here...';
        resumeJsonInput.value = entry.resumeJson || '';
        resumeJsonInput.setAttribute('data-entry-id', entry.id);
        
        resumeJsonInput.addEventListener('input', (e) => {
          const entryId = e.target.getAttribute('data-entry-id');
          const jsonValue = e.target.value;
          // Only save to Firebase, don't generate preview automatically
          updateJobPortfolioEntry(entryId, 'resumeJson', jsonValue);
        });
        
        resumeJsonSection.appendChild(resumeJsonLabel);
        resumeJsonSection.appendChild(resumeJsonInput);
        
        // Create Resume button (uses AI to generate resume from job description)
        // Only show when there's NO existing JSON (mutually exclusive with Edit Resume button)
        const createResumeBtn = document.createElement('button');
        createResumeBtn.className = 'btn btn-primary create-resume-btn';
        createResumeBtn.id = `createResumeBtn_${entry.id}`;
        createResumeBtn.innerHTML = '<i class="fas fa-magic"></i> Create Resume';
        createResumeBtn.style.cssText = 'margin-top: 1rem; width: 100%;';
        createResumeBtn.setAttribute('data-entry-id', entry.id);
        
        // Edit Resume button (shown when there's existing JSON, toggles edit mode)
        // Position changes based on edit mode:
        // - When NOT in edit mode: in button container below Download LaTeX
        // - When IN edit mode: below JSON input
        const editResumeBtn = document.createElement('button');
        editResumeBtn.className = 'btn btn-secondary';
        // Style will be set based on where it's placed
        editResumeBtn.innerHTML = isEditMode ? '<i class="fas fa-check"></i> Done Editing' : '<i class="fas fa-edit"></i> Edit Resume';
        editResumeBtn.setAttribute('data-entry-id', entry.id);
        editResumeBtn.addEventListener('click', () => {
          const entryId = editResumeBtn.getAttribute('data-entry-id');
          if (isEditMode) {
            // Exit edit mode
            resumeEditModeEntries.delete(entryId);
          } else {
            // Enter edit mode
            resumeEditModeEntries.add(entryId);
          }
          renderJobPortfolioEntries();
        });
        
        // Only append Create Resume button if there's no existing JSON
        if (!hasExistingResumeJson) {
          resumeJsonSection.appendChild(createResumeBtn);
        } else if (isEditMode) {
          // When in edit mode, append Edit Resume button below JSON input with full width styling
          editResumeBtn.style.cssText = 'margin-top: 0.5rem; margin-left: 0; width: 100%;';
          resumeJsonSection.appendChild(editResumeBtn);
        }
        
        createResumeBtn.addEventListener('click', async () => {
          const entryId = createResumeBtn.getAttribute('data-entry-id');
          const currentEntry = jobPortfolioData.find(e => e.id === entryId);
          
          const jsonInput = document.getElementById(`resumeJson_${entryId}`);
          const previewContainer = document.getElementById(`resumePreview_${entryId}`);
          const loadingScreen = document.getElementById(`resumeLoading_${entryId}`);
          const aiLoadingScreen = document.getElementById(`resumeAILoading_${entryId}`);
          const resumeJsonSectionEl = jsonInput ? jsonInput.closest('.resume-json-section') : null;
          
          // Check if there's existing JSON in the textarea
          let existingJson = null;
          if (jsonInput && jsonInput.value && jsonInput.value.trim()) {
            try {
              existingJson = safeJsonParse(jsonInput.value.trim());
              // Validate it's a proper resume object
              if (existingJson && (existingJson.contact || existingJson.jobs || existingJson.summary)) {
                // Valid JSON exists, use it directly
                createResumeBtn.disabled = true;
                createResumeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Building...';
                
                // Hide the Resume JSON section
                if (resumeJsonSectionEl) {
                  resumeJsonSectionEl.style.display = 'none';
                }
                if (previewContainer) {
                  previewContainer.style.display = 'none';
                }
                if (loadingScreen) {
                  loadingScreen.style.display = 'flex';
                }
                
                // Update the entry data
                updateJobPortfolioEntry(entryId, 'resumeJson', jsonInput.value.trim());
                
                // Save to Firebase
                await saveJobPortfolioToFirebase();
                
                // Generate PDF preview using existing JSON
                await generateResumePDFForEntry(entryId, existingJson, previewContainer);
                
                // Hide loading screen once PDF is ready
                if (loadingScreen) {
                  loadingScreen.style.display = 'none';
                }
                
                createResumeBtn.disabled = false;
                createResumeBtn.innerHTML = '<i class="fas fa-magic"></i> Create Resume';
                return; // Exit early, we're done
              }
            } catch (parseError) {
              // Invalid JSON, fall through to AI generation
              console.log('Existing JSON is invalid, generating new resume with AI');
            }
          }
          
          // No valid JSON found, proceed with AI generation
          if (!currentEntry || !currentEntry.jobDescription || !currentEntry.jobDescription.trim()) {
            alert('Please enter a job description first before creating a resume.');
            return;
          }
          
          // Hide the Resume JSON section (textarea + button)
          if (resumeJsonSectionEl) {
            resumeJsonSectionEl.style.display = 'none';
          }
          if (aiLoadingScreen) {
            aiLoadingScreen.style.display = 'flex';
          }
          if (previewContainer) {
            previewContainer.style.display = 'none';
          }
          createResumeBtn.disabled = true;
          createResumeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Building...';
          
          try {
            // Generate resume with AI using the entry's job description
            const generatedResume = await generateResumeWithAI(
              currentEntry.jobDescription, 
              extractedJobData, 
              extractedEducationData
            );
            
            // Convert to JSON string
            const resumeJsonString = JSON.stringify(generatedResume, null, 2);
            
            // Update the textarea value
            if (jsonInput) {
              jsonInput.value = resumeJsonString;
            }
            
            // Update the entry data
            updateJobPortfolioEntry(entryId, 'resumeJson', resumeJsonString);
            
            // Save to Firebase
            await saveJobPortfolioToFirebase();
            
            // Hide AI loading screen, show regular loading screen for PDF generation
            if (aiLoadingScreen) {
              aiLoadingScreen.style.display = 'none';
            }
            if (loadingScreen) {
              loadingScreen.style.display = 'flex';
            }
            
            // Generate PDF preview
            if (previewContainer) {
              await generateResumePDFForEntry(entryId, generatedResume, previewContainer);
            }
            
            // Hide loading screen once PDF is ready
            if (loadingScreen) {
              loadingScreen.style.display = 'none';
            }
            
          } catch (error) {
            console.error('Error creating resume:', error);
            alert('Failed to generate resume. Please check your API key and try again.');
            if (aiLoadingScreen) {
              aiLoadingScreen.style.display = 'none';
            }
            // Show the Resume JSON section again on error
            if (resumeJsonSectionEl) {
              resumeJsonSectionEl.style.display = 'block';
            }
          } finally {
            createResumeBtn.disabled = false;
            createResumeBtn.innerHTML = '<i class="fas fa-magic"></i> Create Resume';
          }
        });
        
        // Resume PDF preview container
        const resumePreviewContainer = document.createElement('div');
        resumePreviewContainer.className = 'resume-preview-container';
        resumePreviewContainer.id = `resumePreview_${entry.id}`;
        
        const resumePreviewIframe = document.createElement('iframe');
        resumePreviewIframe.className = 'resume-preview-iframe';
        resumePreviewIframe.id = `resumePreviewIframe_${entry.id}`;
        
        const downloadResumeBtn = document.createElement('button');
        downloadResumeBtn.className = 'btn btn-secondary';
        downloadResumeBtn.style.cssText = 'margin-top: 1rem;';
        downloadResumeBtn.innerHTML = '<i class="fas fa-file-pdf"></i> Download PDF';
        downloadResumeBtn.setAttribute('data-entry-id', entry.id);
        downloadResumeBtn.addEventListener('click', async () => {
          const entryId = downloadResumeBtn.getAttribute('data-entry-id');
          const entry = jobPortfolioData.find(e => e.id === entryId);
          if (entry && entry.resumeJson) {
            try {
              const resumeData = safeJsonParse(entry.resumeJson);
              await downloadResumePDFForEntry(entryId, resumeData);
            } catch (error) {
              console.error('Error downloading PDF:', error);
              alert('Error generating PDF. Please check your JSON format.');
            }
          }
        });
        
        // Download LaTeX button
        const downloadLatexBtn = document.createElement('button');
        downloadLatexBtn.className = 'btn btn-secondary';
        downloadLatexBtn.style.cssText = 'margin-top: 0.5rem;';
        downloadLatexBtn.innerHTML = '<i class="fas fa-file-code"></i> Download LaTeX';
        downloadLatexBtn.setAttribute('data-entry-id', entry.id);
        downloadLatexBtn.addEventListener('click', () => {
          const entryId = downloadLatexBtn.getAttribute('data-entry-id');
          const entry = jobPortfolioData.find(e => e.id === entryId);
          if (entry && entry.resumeJson) {
            try {
              const resumeData = safeJsonParse(entry.resumeJson);
              const jobTitle = entry.jobTitle || 'Resume';
              const cleanJobTitle = jobTitle.replace(/[^a-zA-Z0-9\s-]/g, '').replace(/\s+/g, '-') || 'Resume';
              
              // Generate LaTeX from resume data
              const latex = generateLatexResume(resumeData);
              
              // Download LaTeX file
              downloadLatexSource(latex, `${cleanJobTitle}.tex`);
            } catch (error) {
              console.error('Error downloading LaTeX:', error);
              alert('Error generating LaTeX. Please check your JSON format.');
            }
          }
        });
        
        // Button container
        const buttonContainer = document.createElement('div');
        buttonContainer.style.cssText = 'display: flex; flex-direction: column; gap: 0.5rem; margin-top: 1rem;';
        
        // Only show Download PDF and LaTeX buttons when NOT in edit mode
        if (!isEditMode) {
          buttonContainer.appendChild(downloadResumeBtn);
          buttonContainer.appendChild(downloadLatexBtn);
          
          // Show Edit Resume button when there's existing JSON and NOT in edit mode (positioned below Download LaTeX)
          if (hasExistingResumeJson) {
            editResumeBtn.style.cssText = 'margin-top: 0.5rem; margin-left: 0;';
            buttonContainer.appendChild(editResumeBtn);
          }
        }
        
        resumePreviewContainer.appendChild(resumePreviewIframe);
        resumePreviewContainer.appendChild(buttonContainer);
        
        // Loading screen (only shown when there's existing JSON and PDF is being generated)
        const loadingScreen = document.createElement('div');
        loadingScreen.className = 'resume-loading-screen';
        loadingScreen.id = `resumeLoading_${entry.id}`;
        loadingScreen.style.display = hasExistingResumeJson ? 'flex' : 'none'; // Hide initially if no existing JSON
        loadingScreen.innerHTML = `
          <div class="resume-loading-spinner"></div>
          <div class="resume-loading-text">Generating Resume Preview</div>
          <div class="resume-loading-subtext">This may take a few moments...</div>
        `;
        
        // AI Loading screen (shown when AI is building the resume)
        const aiLoadingScreen = document.createElement('div');
        aiLoadingScreen.className = 'resume-loading-screen ai-building-screen';
        aiLoadingScreen.id = `resumeAILoading_${entry.id}`;
        aiLoadingScreen.style.display = 'none';
        aiLoadingScreen.innerHTML = `
          <div class="ai-building-animation">
            <div class="ai-building-icon">
              <i class="fas fa-robot"></i>
            </div>
            <div class="ai-building-particles">
              <span></span><span></span><span></span><span></span><span></span>
            </div>
          </div>
          <div class="resume-loading-text ai-building-text">Building custom-tailored resume</div>
          <div class="resume-loading-subtext">AI is analyzing job requirements and optimizing your resume...</div>
          <div class="ai-progress-dots">
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
          </div>
        `;
        
        // Check if JSON is valid before deciding layout
        let isValidJson = false;
        if (hasExistingResumeJson) {
          try {
            safeJsonParse(entry.resumeJson);
            isValidJson = true;
          } catch (e) {
            isValidJson = false;
            console.warn('Invalid JSON detected, will show textarea for editing');
          }
        }
        
        // Determine layout based on whether entry has existing JSON
        if (hasExistingResumeJson && isValidJson) {
          // Entry has valid existing JSON: show loading screen first, then preview, then JSON input below if in edit mode
          if (!isEditMode) {
            // Not in edit mode: hide JSON input initially
            resumeJsonSection.style.display = 'none';
          }
          // Show loading screen initially
          resumeMenuContent.appendChild(aiLoadingScreen);
          resumeMenuContent.appendChild(loadingScreen);
          resumeMenuContent.appendChild(resumePreviewContainer);
          // JSON input goes below preview when in edit mode
          if (isEditMode) {
            resumeMenuContent.appendChild(resumeJsonSection);
          } else {
            // Still append it to DOM but hidden, so it can be shown if needed
            resumeMenuContent.appendChild(resumeJsonSection);
          }
        } else {
          // No existing JSON or invalid JSON: show JSON input above preview (normal flow)
          resumeMenuContent.appendChild(resumeJsonSection);
          resumeMenuContent.appendChild(aiLoadingScreen);
          resumeMenuContent.appendChild(loadingScreen);
          resumeMenuContent.appendChild(resumePreviewContainer);
          // If invalid JSON, show it immediately and don't try to generate preview
          if (hasExistingResumeJson && !isValidJson) {
            loadingScreen.style.display = 'none';
            aiLoadingScreen.style.display = 'none';
          }
        }
        
        // Load existing resume JSON and generate preview if available and valid
        if (hasExistingResumeJson && isValidJson) {
          (async () => {
            try {
              const resumeData = safeJsonParse(entry.resumeJson);
              // Valid JSON - generate preview
              await generateResumePDFForEntry(entry.id, resumeData, resumePreviewContainer);
              // Hide loading screen and show preview once PDF is ready
              loadingScreen.style.display = 'none';
            } catch (error) {
              console.error('Error loading resume preview:', error);
              loadingScreen.style.display = 'none';
              // Show the JSON section so user can edit it
              resumeJsonSection.style.display = 'block';
            }
          })();
        }
        
        resumeMenu.appendChild(resumeMenuContent);
        entryElement.appendChild(resumeMenu);
        
        jobPortfolioEntries.appendChild(entryElement);
        
        // Add event listeners for inputs
        const inputs = entryElement.querySelectorAll('input, textarea');
        inputs.forEach(input => {
          input.addEventListener('input', () => {
            const entryId = input.getAttribute('data-entry-id');
            const field = input.getAttribute('data-field');
            const value = input.value;
            updateJobPortfolioEntry(entryId, field, value);
            
            // Update preview if job title or due date changed
            if (field === 'jobTitle') {
              title.textContent = value || 'Untitled Entry';
            } else if (field === 'dueDate') {
              dueDate.textContent = value ? formatDateForDisplay(value) : 'No due date';
            }
          });
        });
      });
    }


    // Save job portfolio to Firebase
    async function saveJobPortfolioToFirebase() {
      if (!currentUser) {
        console.log('No authenticated user - cannot save job portfolio');
        return;
      }
      
      try {
        const portfolioData = {
          entries: jobPortfolioData,
          lastUpdated: new Date().toISOString()
        };
        
        console.log('Job portfolio to save:', portfolioData);
        
        const portfolioRef = doc(db, 'users', currentUser.uid, 'jobPortfolio', 'data');
        await setDoc(portfolioRef, portfolioData);
        console.log('‚úÖ Job portfolio saved to Firestore successfully!');
        
      } catch (error) {
        console.error('‚ùå Error saving job portfolio to Firebase:', error);
      }
    }

    // Load job portfolio from Firebase
    async function loadJobPortfolioFromFirebase() {
      if (!currentUser) {
        console.log('No authenticated user - cannot load job portfolio');
        return;
      }
      
      try {
        const portfolioRef = doc(db, 'users', currentUser.uid, 'jobPortfolio', 'data');
        const portfolioDoc = await getDoc(portfolioRef);
        
        if (portfolioDoc.exists()) {
          const portfolioData = portfolioDoc.data();
          console.log('Job portfolio loaded:', portfolioData);
          
          if (portfolioData.entries && Array.isArray(portfolioData.entries)) {
            jobPortfolioData = portfolioData.entries;
            // Ensure all entries have a status (default to 'pending' if missing), resumeJson, and questions
            jobPortfolioData.forEach(entry => {
              if (!entry.status) {
                entry.status = 'pending';
              }
              if (!entry.resumeJson) {
                entry.resumeJson = '';
              }
              if (!entry.questions) {
                entry.questions = [];
              }
            });
            // Sort entries by due date when loading
            sortJobPortfolioEntries();
            renderJobPortfolioEntries();
            console.log('‚úÖ Job portfolio loaded from Firestore successfully!');
          }
        } else {
          console.log('No job portfolio found in Firestore (this is normal for new users)');
        }
        
      } catch (error) {
        console.log('No job portfolio found in Firestore (this is normal for new users):', error.message);
      }
    }

    // Save display preferences to Firebase
    async function saveDisplayPreferencesToFirebase() {
      if (!currentUser) {
        console.log('No authenticated user - cannot save display preferences');
        return;
      }
      
      try {
        const displayPreferences = {
          showSkills: showSkillsCheckbox ? showSkillsCheckbox.checked : true,
          showSummary: showSummaryCheckbox ? showSummaryCheckbox.checked : true,
          centerHeaders: centerHeaderCheckbox ? centerHeaderCheckbox.checked : false,
          lastUpdated: new Date().toISOString()
        };
        
        console.log('Display preferences to save:', displayPreferences);
        
        const preferencesRef = doc(db, 'users', currentUser.uid, 'displayPreferences', 'data');
        await setDoc(preferencesRef, displayPreferences);
        console.log('‚úÖ Display preferences saved to Firestore successfully!');
        
      } catch (error) {
        console.error('‚ùå Error saving display preferences to Firebase:', error);
      }
    }

    // Load display preferences from Firebase
    async function loadDisplayPreferencesFromFirebase() {
      if (!currentUser) {
        console.log('No authenticated user - cannot load display preferences');
        return;
      }
      
      try {
        const preferencesRef = doc(db, 'users', currentUser.uid, 'displayPreferences', 'data');
        const preferencesDoc = await getDoc(preferencesRef);
        
        if (preferencesDoc.exists()) {
          const preferences = preferencesDoc.data();
          console.log('Display preferences loaded:', preferences);
          
          // Apply loaded preferences to checkboxes
          if (showSkillsCheckbox) {
            showSkillsCheckbox.checked = preferences.showSkills !== undefined ? preferences.showSkills : true;
          }
          if (showSummaryCheckbox) {
            showSummaryCheckbox.checked = preferences.showSummary !== undefined ? preferences.showSummary : true;
          }
          if (centerHeaderCheckbox) {
            centerHeaderCheckbox.checked = preferences.centerHeaders !== undefined ? preferences.centerHeaders : false;
          }
          
          console.log('‚úÖ Display preferences loaded from Firestore successfully!');
        } else {
          console.log('No display preferences found in Firestore (using defaults)');
        }
        
      } catch (error) {
        console.log('No display preferences found in Firestore (this is normal for new users):', error.message);
      }
    }

    // Current Resume Functions
    let currentResumeUrl = null;
    let currentResumeRef = null;

    async function uploadResumeToFirebase(file) {
      if (!currentUser) {
        throw new Error('User must be authenticated to upload resume');
      }

      try {
        // Delete existing resume if any
        if (currentResumeRef) {
          try {
            await window.deleteObject(currentResumeRef);
          } catch (error) {
            console.log('No existing resume to delete');
          }
        }

        // Create new file reference
        const fileName = `resume_${currentUser.uid}_${Date.now()}.${file.name.split('.').pop()}`;
        const resumeRef = window.ref(window.storage, `resumes/${fileName}`);
        
        // Upload file
        const snapshot = await window.uploadBytes(resumeRef, file);
        const downloadURL = await window.getDownloadURL(snapshot.ref);
        
        // Save resume info to Firestore
        await window.setDoc(window.doc(window.db, 'users', currentUser.uid), {
          resumeUrl: downloadURL,
          resumeFileName: file.name,
          resumeRef: fileName,
          lastUpdated: new Date()
        }, { merge: true });

        currentResumeUrl = downloadURL;
        currentResumeRef = resumeRef;
        
        return { downloadURL, fileName: file.name };
      } catch (error) {
        console.error('Error uploading resume:', error);
        throw error;
      }
    }

    async function loadUserResume() {
      if (!currentUser) return;

      try {
        const userDoc = await window.getDoc(window.doc(window.db, 'users', currentUser.uid));
        if (userDoc.exists()) {
          const userData = userDoc.data();
          if (userData.resumeUrl) {
            currentResumeUrl = userData.resumeUrl;
            currentResumeRef = window.ref(window.storage, `resumes/${userData.resumeRef}`);
            showResumePreview(userData.resumeFileName, userData.resumeUrl);
          }
        }
      } catch (error) {
        console.error('Error loading user resume:', error);
      }
    }

    function showResumePreview(fileName, url) {
      fileUploadArea.style.display = 'none';
      resumePreviewContainer.style.display = 'block';
      resumeFilename.textContent = fileName;
      
      // Set up thumbnail based on file type
      const fileExtension = fileName.split('.').pop().toLowerCase();
      const thumbnail = resumePreviewThumbnail;
      
      if (fileExtension === 'pdf') {
        thumbnail.innerHTML = '<i class="fas fa-file-pdf" style="color: #ef4444;"></i>';
      } else if (['doc', 'docx'].includes(fileExtension)) {
        thumbnail.innerHTML = '<i class="fas fa-file-word" style="color: #2563eb;"></i>';
      } else {
        thumbnail.innerHTML = '<i class="fas fa-file" style="color: var(--text-muted);"></i>';
      }
    }

    function hideResumePreview() {
      fileUploadArea.style.display = 'block';
      resumePreviewContainer.style.display = 'none';
      currentResumeUrl = null;
      currentResumeRef = null;
      
      // Clear and hide job titles when resume is removed
      clearJobTitles();
    }

    async function removeResume() {
      if (!currentUser || !currentResumeRef) return;

      try {
        // Delete from Storage
        await window.deleteObject(currentResumeRef);
        
        // Remove from Firestore
        await window.updateDoc(window.doc(window.db, 'users', currentUser.uid), {
          resumeUrl: null,
          resumeFileName: null,
          resumeRef: null,
          jobTitles: null,
          education: null
        });

        hideResumePreview();
      } catch (error) {
        console.error('Error removing resume:', error);
        showPreviewError('Failed to remove resume. Please try again.');
      }
    }

    function viewResume() {
      if (currentResumeUrl) {
        window.open(currentResumeUrl, '_blank');
      }
    }

    // File upload event listeners
    fileUploadArea.addEventListener('click', () => {
      resumeFileInput.click();
    });

    resumeFileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      // Validate file type
      const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
      if (!allowedTypes.includes(file.type)) {
        showPreviewError('Please upload a PDF, DOC, or DOCX file');
        return;
      }

      // Validate file size (max 10MB)
      if (file.size > 10 * 1024 * 1024) {
        showPreviewError('File size must be less than 10MB');
        return;
      }

      try {
        showLoading('Uploading resume...');
        const result = await uploadResumeToFirebase(file);
        showResumePreview(result.fileName, result.downloadURL);
        hideLoading();
        
        // Extract job titles from the uploaded resume
        await extractJobTitlesFromResume(file);
      } catch (error) {
        hideLoading();
        showPreviewError(`Failed to upload resume: ${error.message}`);
      }
    });

    // Drag and drop functionality
    fileUploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      fileUploadArea.classList.add('dragover');
    });

    fileUploadArea.addEventListener('dragleave', () => {
      fileUploadArea.classList.remove('dragover');
    });

    fileUploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      fileUploadArea.classList.remove('dragover');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        resumeFileInput.files = files;
        resumeFileInput.dispatchEvent(new Event('change'));
      }
    });

    // Action buttons
    viewResumeBtn.addEventListener('click', viewResume);
    removeResumeBtn.addEventListener('click', removeResume);

    // Job Titles Extraction Functions
    let extractedJobData = [];
    let extractedEducationData = [];
    let currentEditingJobIndex = -1;

    async function extractJobTitlesFromResume(file) {
      try {
        // Show loading state
        jobTitlesSection.style.display = 'block';
        jobTitlesLoading.style.display = 'block';
        jobTitlesEmpty.style.display = 'none';
        jobTitlesContainer.innerHTML = '';

        // Convert file to image for OCR
        const imageUrl = await convertFileToImage(file);
        
        // Process each page separately and combine results
        let jobData = [];
        let educationData = [];
        try {
          const result = await extractJobsFromAllPages(file);
          jobData = result.jobs;
          educationData = result.education;
        } catch (error) {
          console.error('Multi-page extraction failed:', error);
          // Fallback to single image processing
          try {
            const result = await extractJobsAndEducationWithChatGPTVision(imageUrl);
            jobData = result.jobs;
            educationData = result.education;
          } catch (visionError) {
            console.error('ChatGPT Vision failed:', visionError);
            // Final fallback to OCR
            const result = await Tesseract.recognize(imageUrl, 'eng', {
              logger: m => {
                if (m.status === 'recognizing text') {
                  // Update progress if needed
                }
              }
            });
            jobData = await extractJobsWithChatGPT(result.data.text);
            educationData = []; // OCR doesn't extract education yet
          }
        }
        
        if (jobData.length > 0 || educationData.length > 0) {
          extractedJobData = jobData;
          extractedEducationData = educationData;
          displayJobTitles(jobData);
          displayEducation(educationData);
          await saveJobTitlesToFirebase(jobData);
          await saveEducationToFirebase(educationData);
          
          // Extract and save personal information
          await extractPersonalInfoFromResume(file);
        } else {
          showJobTitlesEmpty();
          showEducationEmpty();
        }

        // Clean up
        URL.revokeObjectURL(imageUrl);
        jobTitlesLoading.style.display = 'none';

      } catch (error) {
        console.error('Error extracting job titles:', error);
        jobTitlesLoading.style.display = 'none';
        showJobTitlesEmpty();
        showPreviewError('Failed to extract job information from resume');
      }
    }

    async function convertFileToImage(file) {
      return new Promise(async (resolve, reject) => {
        if (file.type === 'application/pdf') {
          try {
            // Load PDF.js if not already loaded
            await ensurePdfJs();
            
            // Convert PDF to image using PDF.js
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            
            // Process all pages and combine them
            const pageCount = pdf.numPages;
            const allPagesCanvas = document.createElement('canvas');
            const allPagesContext = allPagesCanvas.getContext('2d');
            
            let totalHeight = 0;
            let maxWidth = 0;
            
            // First pass: calculate total dimensions
            for (let pageNum = 1; pageNum <= pageCount; pageNum++) {
              const page = await pdf.getPage(pageNum);
              const viewport = page.getViewport({ scale: 2.0 });
              totalHeight += viewport.height;
              maxWidth = Math.max(maxWidth, viewport.width);
            }
            
            // Set canvas dimensions
            allPagesCanvas.width = maxWidth;
            allPagesCanvas.height = totalHeight;
            
            // Second pass: render all pages
            let currentY = 0;
            for (let pageNum = 1; pageNum <= pageCount; pageNum++) {
              const page = await pdf.getPage(pageNum);
              const viewport = page.getViewport({ scale: 2.0 });
              
              const renderContext = {
                canvasContext: allPagesContext,
                viewport: viewport,
                transform: [1, 0, 0, 1, 0, currentY]
              };
              
              await page.render(renderContext).promise;
              currentY += viewport.height;
            }
            
            resolve(allPagesCanvas.toDataURL('image/png'));
          } catch (error) {
            console.error('Error converting PDF to image:', error);
            // Fallback to a simple canvas
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 1000;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'black';
            ctx.font = '16px Arial';
            ctx.fillText('PDF Resume - Processing...', 50, 50);
            resolve(canvas.toDataURL());
          }
        } else {
          // For image files, convert to data URL
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        }
      });
    }

    function parseJobTitlesFromText(text) {
      const jobs = [];
      const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
      
      console.log('OCR Text extracted:', text); // Debug log
      
      // Look for work experience section
      let workExperienceStart = -1;
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].toLowerCase();
        if (line.includes('work experience') || line.includes('employment') || 
            line.includes('professional experience') || line.includes('career') ||
            line.includes('experience') || line.includes('employment history')) {
          workExperienceStart = i;
          break;
        }
      }
      
      // If no work experience section found, start from beginning
      const startIndex = workExperienceStart >= 0 ? workExperienceStart : 0;
      
      // Look for job entries
      for (let i = startIndex; i < lines.length; i++) {
        const line = lines[i];
        
        // Skip section headers
        if (isSectionHeader(line)) continue;
        
        // Check if line contains job title indicators
        if (isJobTitleLine(line)) {
          const job = extractJobFromLine(line, lines, i);
          if (job.title && job.company) {
            jobs.push(job);
            console.log('Extracted job:', job); // Debug log
          }
        }
      }

      return jobs;
    }

    function isSectionHeader(line) {
      const sectionHeaders = [
        'work experience', 'employment', 'professional experience', 'career',
        'education', 'skills', 'certifications', 'projects', 'achievements',
        'summary', 'objective', 'contact', 'personal information'
      ];
      
      const lowerLine = line.toLowerCase();
      return sectionHeaders.some(header => lowerLine.includes(header));
    }

    function isJobTitleLine(line) {
      const jobKeywords = [
        'engineer', 'developer', 'manager', 'analyst', 'specialist', 'coordinator',
        'director', 'lead', 'senior', 'junior', 'associate', 'intern', 'consultant',
        'advisor', 'architect', 'designer', 'programmer', 'technician', 'administrator',
        'supervisor', 'executive', 'officer', 'representative', 'assistant', 'clerk',
        'agent', 'operator', 'technologist', 'scientist', 'researcher', 'strategist',
        'planner', 'facilitator', 'liaison', 'advocate', 'expert', 'professional',
        'practitioner'
      ];

      const lowerLine = line.toLowerCase();
      return jobKeywords.some(keyword => lowerLine.includes(keyword)) ||
             line.includes(' at ') || line.includes(' @ ') || line.includes(', ');
    }

    function extractJobFromLine(line, allLines, currentIndex) {
      const job = { title: '', company: '', startDate: '', endDate: '', location: '', dates: '' };

      // Extract title and company
      const atMatch = line.match(/(.+?)\s+(?:at|@|,)\s+(.+)/i);
      if (atMatch) {
        job.title = atMatch[1].trim();
        job.company = atMatch[2].trim();
      } else {
        job.title = line;
        // Look for company in next few lines
        for (let i = currentIndex + 1; i < Math.min(currentIndex + 5, allLines.length); i++) {
          const nextLine = allLines[i];
          if (nextLine && !isJobTitleLine(nextLine) && !containsDates(nextLine) && 
              !isSectionHeader(nextLine) && nextLine.length > 2) {
            job.company = nextLine;
            break;
          }
        }
      }

      // Look for dates and location in the next few lines
      for (let i = currentIndex + 1; i < Math.min(currentIndex + 5, allLines.length); i++) {
        const nextLine = allLines[i];
        if (nextLine && containsDates(nextLine)) {
          // Extract dates
          const dateMatch = nextLine.match(/(\w+\s+\d{4})\s*[-‚Äì‚Äî]\s*(\w+\s+\d{4}|current|present)/i);
          if (dateMatch) {
            job.startDate = dateMatch[1].trim();
            job.endDate = dateMatch[2].trim();
            job.dates = `${job.startDate} - ${job.endDate}`;
          } else {
            // Try to extract single date
            const singleDateMatch = nextLine.match(/(\w+\s+\d{4})/i);
            if (singleDateMatch) {
              job.startDate = singleDateMatch[1].trim();
              job.endDate = 'Current';
              job.dates = `${job.startDate} - Current`;
            }
          }
        } else if (nextLine && !isJobTitleLine(nextLine) && !isSectionHeader(nextLine) && 
                   nextLine.length > 2 && !containsDates(nextLine)) {
          // This might be location
          if (!job.location) {
            job.location = nextLine.trim();
          }
        }
      }

      // Extract dates from current line or nearby lines
      job.dates = extractDatesFromLine(line) || 
                  extractDatesFromContext(allLines, currentIndex);

      return job;
    }

    function containsDates(line) {
      return /\d{4}|\d{1,2}\/\d{4}|\w+\s+\d{4}/.test(line);
    }

    function extractDatesFromLine(line) {
      const datePatterns = [
        /(\d{4})\s*[-‚Äì‚Äî]\s*(\d{4}|\w+)/g,
        /(\w+\s+\d{4})\s*[-‚Äì‚Äî]\s*(\w+\s+\d{4}|\w+)/g,
        /(\d{1,2}\/\d{4})\s*[-‚Äì‚Äî]\s*(\d{1,2}\/\d{4}|\w+)/g
      ];

      for (const pattern of datePatterns) {
        const match = line.match(pattern);
        if (match) {
          return match[0];
        }
      }
      return null;
    }

    function extractDatesFromContext(allLines, currentIndex) {
      // Look in current line and next 2 lines for dates
      for (let i = currentIndex; i < Math.min(currentIndex + 3, allLines.length); i++) {
        const dates = extractDatesFromLine(allLines[i]);
        if (dates) return dates;
      }
      return '';
    }

    function displayJobTitles(jobs) {
      jobTitlesContainer.innerHTML = '';
      
      jobs.forEach((job, index) => {
        const jobElement = document.createElement('div');
        jobElement.className = 'job-title-item';
        
        // Parse dates if they exist
        const startDate = job.startDate || '';
        const endDate = job.endDate || '';
        const location = job.location || '';
        
        jobElement.innerHTML = `
          <div class="job-title-header">
            <h4 class="job-title-name">${escapeHtml(job.title)}</h4>
            <button class="edit-job-btn" data-index="${index}">
              <i class="fas fa-edit"></i>
            </button>
          </div>
          <p class="job-company">${escapeHtml(job.company)}</p>
          <p class="job-dates">${startDate} ${endDate ? ' - ' + endDate : ''}</p>
          ${location ? `<p class="job-location">${escapeHtml(location)}</p>` : ''}
        `;
        
        // Add click listener for edit button
        const editBtn = jobElement.querySelector('.edit-job-btn');
        editBtn.addEventListener('click', () => openJobEditModal(index));
        
        jobTitlesContainer.appendChild(jobElement);
      });

      jobTitlesEmpty.style.display = 'none';
    }

    function showJobTitlesEmpty() {
      jobTitlesContainer.innerHTML = '';
      jobTitlesEmpty.style.display = 'block';
    }

    function clearJobTitles() {
      // Clear the job titles data
      extractedJobData = [];
      
      // Hide the job titles section
      jobTitlesSection.style.display = 'none';
      
      // Clear the container
      jobTitlesContainer.innerHTML = '';
      
      // Hide loading and empty states
      jobTitlesLoading.style.display = 'none';
      jobTitlesEmpty.style.display = 'none';
      
      // Also clear education when resume is removed
      clearEducation();
    }

    // Personal Information Extraction
    async function extractPersonalInfoFromResume(file) {
      try {
        console.log('Extracting personal information from resume...');
        
        // Convert file to image for OCR
        const imageUrl = await convertFileToImage(file);
        
        // Use ChatGPT Vision to extract personal information
        const personalInfo = await extractPersonalInfoWithChatGPTVision(imageUrl);
        
        if (personalInfo) {
          // Update the personal information form fields
          if (personalInfo.name && personalName) {
            personalName.value = personalInfo.name;
          }
          if (personalInfo.address && personalAddress) {
            personalAddress.value = personalInfo.address;
          }
          if (personalInfo.email && personalEmail) {
            personalEmail.value = personalInfo.email;
          }
          if (personalInfo.phone && personalPhone) {
            personalPhone.value = personalInfo.phone;
          }
          
          // Save to Firebase
          await savePersonalInfoToFirebase({
            name: personalInfo.name || '',
            address: personalInfo.address || '',
            email: personalInfo.email || '',
            phone: personalInfo.phone || '',
            lastUpdated: new Date().toISOString()
          });
          
          console.log('Personal information extracted and saved:', personalInfo);
        }
      } catch (error) {
        console.error('Failed to extract personal information:', error);
        // Don't show error to user as this is a background process
      }
    }

    async function extractPersonalInfoWithChatGPTVision(imageUrl) {
      try {
        if (!AI_CONFIG || !AI_CONFIG.apiKey) {
          throw new Error('AI configuration not available');
        }

        // Convert data URL to base64
        const base64Image = imageUrl.split(',')[1];
        
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${AI_CONFIG.apiKey}`
          },
          body: JSON.stringify({
            model: 'gpt-4o',
            messages: [
              {
                role: 'system',
                content: `You are an expert at extracting contact details from resumes. Extract the following information from the provided resume image and return it in JSON format:

{
  "name": "Full Name",
  "address": "Complete Address", 
  "email": "Email Address",
  "phone": "Phone Number"
}

Rules:
- Extract the person's full name (usually at the top of the resume)
- Extract the complete address (street, city, state, zip)
- Extract the email address
- Extract the phone number
- If any information is not found, use null for that field
- Return ONLY the JSON object, no other text`
              },
              {
                role: 'user',
                content: [
                  {
                    type: 'text',
                    text: 'Extract the name, email, and phone number from this resume.'
                  },
                  {
                    type: 'image_url',
                    image_url: {
                      url: `data:image/png;base64,${base64Image}`
                    }
                  }
                ]
              }
            ],
            max_tokens: 500,
            temperature: 0.1
          })
        });

        if (!response.ok) {
          throw new Error(`OpenAI API error: ${response.status}`);
        }

        const data = await response.json();
        const content = data.choices[0].message.content;
        
        console.log('Personal info extraction response:', content);
        
        // Parse the JSON response
        try {
          const jsonMatch = content.match(/\{[\s\S]*\}/);
          if (jsonMatch) {
            return JSON.parse(jsonMatch[0]);
          } else {
            throw new Error('No valid JSON found in response');
          }
        } catch (parseError) {
          console.error('JSON parsing error:', parseError);
          throw new Error('Failed to parse personal information response');
        }

      } catch (error) {
        console.error('Personal info extraction error:', error);
        throw error;
      }
    }

    // Job Edit Modal Functions
    function openJobEditModal(jobIndex) {
      currentEditingJobIndex = jobIndex;
      const job = extractedJobData[jobIndex];
      
      // Populate form fields
      editJobTitle.value = job.title || '';
      editJobCompany.value = job.company || '';
      editJobStartDate.value = job.startDate || '';
      editJobEndDate.value = job.endDate || '';
      editJobLocation.value = job.location || '';
      
      // Show modal
      jobEditModal.classList.add('active');
      editJobTitle.focus();
    }

    function closeJobEditModalFunc() {
      jobEditModal.classList.remove('active');
      currentEditingJobIndex = -1;
    }

    function saveJobEditData() {
      if (currentEditingJobIndex === -1) return;
      
      const job = extractedJobData[currentEditingJobIndex];
      
      // Update job data
      job.title = editJobTitle.value.trim();
      job.company = editJobCompany.value.trim();
      job.startDate = editJobStartDate.value.trim();
      job.endDate = editJobEndDate.value.trim();
      job.location = editJobLocation.value.trim();
      
      // Update the display
      displayJobTitles(extractedJobData);
      
      // Save to Firebase
      saveJobTitlesToFirebase(extractedJobData);
      
      // Close modal
      closeJobEditModalFunc();
    }

    // Job Edit Modal Event Listeners
    closeJobEditModal.addEventListener('click', closeJobEditModalFunc);
    cancelJobEdit.addEventListener('click', closeJobEditModalFunc);
    saveJobEdit.addEventListener('click', saveJobEditData);

    jobEditModal.addEventListener('click', (e) => {
      if (e.target === jobEditModal) {
        closeJobEditModalFunc();
      }
    });

    // Handle Enter key in form fields
    [editJobTitle, editJobCompany, editJobStartDate, editJobEndDate, editJobLocation].forEach(input => {
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          saveJobEditData();
        }
      });
    });

    async function saveJobTitlesToFirebase(jobData) {
      if (!currentUser) return;

      try {
        await window.setDoc(window.doc(window.db, 'users', currentUser.uid), {
          jobTitles: jobData,
          lastUpdated: new Date()
        }, { merge: true });
      } catch (error) {
        console.error('Error saving job titles to Firebase:', error);
      }
    }

    async function loadJobTitlesFromFirebase() {
      if (!currentUser) return;

      try {
        const userDoc = await window.getDoc(window.doc(window.db, 'users', currentUser.uid));
        if (userDoc.exists()) {
          const userData = userDoc.data();
          // Only load job titles if there's a resume
          if (userData.resumeUrl && userData.jobTitles && userData.jobTitles.length > 0) {
            extractedJobData = userData.jobTitles;
            displayJobTitles(userData.jobTitles);
            jobTitlesSection.style.display = 'block';
          } else {
            // Clear job titles if no resume
            clearJobTitles();
          }
          // Only load education data if there's a resume
          if (userData.resumeUrl && userData.education && userData.education.length > 0) {
            extractedEducationData = userData.education;
            displayEducation(userData.education);
            educationSection.style.display = 'block';
          } else {
            // Clear education data if no resume
            clearEducation();
          }
        }
      } catch (error) {
        console.error('Error loading job titles from Firebase:', error);
      }
    }

    function displayEducation(education) {
      educationContainer.innerHTML = '';
      
      if (education.length === 0) {
        showEducationEmpty();
        return;
      }
      
      education.forEach((item, index) => {
        const educationElement = document.createElement('div');
        educationElement.className = 'education-item';
        
        // Handle both string and object formats
        let displayText = '';
        if (typeof item === 'string') {
          displayText = item;
        } else if (typeof item === 'object' && item !== null) {
          // Handle old object format for backward compatibility
          if (item.title && item.institution) {
            displayText = `${item.title} from ${item.institution}`;
          } else if (item.title) {
            displayText = item.title;
          } else {
            displayText = JSON.stringify(item);
          }
        } else {
          displayText = String(item);
        }
        
        educationElement.innerHTML = `
          <div class="education-title" data-index="${index}" style="cursor: pointer;">${escapeHtml(displayText)}</div>
        `;
        
        // Add click listener for editing
        const titleElement = educationElement.querySelector('.education-title');
        titleElement.addEventListener('click', () => editEducationField(titleElement, index));
        
        educationContainer.appendChild(educationElement);
      });

      educationEmpty.style.display = 'none';
      educationSection.style.display = 'block';
    }

    function showEducationEmpty() {
      educationContainer.innerHTML = '';
      educationEmpty.style.display = 'block';
      educationSection.style.display = 'block';
    }

    function clearEducation() {
      // Clear the education data
      extractedEducationData = [];
      
      // Hide the education section
      educationSection.style.display = 'none';
      
      // Clear the container
      educationContainer.innerHTML = '';
      
      // Hide loading and empty states
      educationLoading.style.display = 'none';
      educationEmpty.style.display = 'none';
    }

    async function saveEducationToFirebase(educationData) {
      if (!currentUser) return;

      try {
        await window.setDoc(window.doc(window.db, 'users', currentUser.uid), {
          education: educationData,
          lastUpdated: new Date()
        }, { merge: true });
        console.log('Education data saved to Firebase');
      } catch (error) {
        console.error('Error saving education to Firebase:', error);
      }
    }

    function editJobField(element, index) {
      const field = element.dataset.field;
      const currentValue = element.textContent;
      
      // Create input element
      const input = document.createElement('input');
      input.type = 'text';
      input.value = currentValue;
      input.className = 'edit-input';
      input.style.cssText = `
        width: 100%;
        padding: 4px 8px;
        border: 2px solid #007bff;
        border-radius: 4px;
        background: white;
        color: #333;
        font-size: inherit;
        font-family: inherit;
      `;
      
      // Replace element content with input
      element.innerHTML = '';
      element.appendChild(input);
      input.focus();
      input.select();
      
      // Handle save on Enter or blur
      const saveEdit = () => {
        const newValue = input.value.trim();
        if (newValue !== currentValue) {
          // Update the data
          extractedJobData[index][field] = newValue;
          
          // Update the display
          element.innerHTML = escapeHtml(newValue);
          element.style.cursor = 'pointer';
          
          // Save to Firebase
          saveJobTitlesToFirebase(extractedJobData);
        } else {
          // Restore original display
          element.innerHTML = escapeHtml(currentValue);
          element.style.cursor = 'pointer';
        }
      };
      
      // Handle cancel on Escape
      const cancelEdit = () => {
        element.innerHTML = escapeHtml(currentValue);
        element.style.cursor = 'pointer';
      };
      
      input.addEventListener('blur', saveEdit);
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          saveEdit();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          cancelEdit();
        }
      });
    }

    function editEducationField(element, index) {
      const currentValue = element.textContent;
      
      // Create input element
      const input = document.createElement('input');
      input.type = 'text';
      input.value = currentValue;
      input.className = 'edit-input';
      input.style.cssText = `
        width: 100%;
        padding: 4px 8px;
        border: 2px solid #007bff;
        border-radius: 4px;
        background: white;
        color: #333;
        font-size: inherit;
        font-family: inherit;
      `;
      
      // Replace element content with input
      element.innerHTML = '';
      element.appendChild(input);
      input.focus();
      input.select();
      
      // Handle save on Enter or blur
      const saveEdit = () => {
        const newValue = input.value.trim();
        if (newValue !== currentValue) {
          // Update the data
          extractedEducationData[index] = newValue;
          
          // Update the display
          element.innerHTML = escapeHtml(newValue);
          element.style.cursor = 'pointer';
          
          // Save to Firebase
          saveEducationToFirebase(extractedEducationData);
        } else {
          // Restore original display
          element.innerHTML = escapeHtml(currentValue);
          element.style.cursor = 'pointer';
        }
      };
      
      // Handle cancel on Escape
      const cancelEdit = () => {
        element.innerHTML = escapeHtml(currentValue);
        element.style.cursor = 'pointer';
      };
      
      input.addEventListener('blur', saveEdit);
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          saveEdit();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          cancelEdit();
        }
      });
    }

    async function extractJobsFromAllPages(file) {
      if (file.type !== 'application/pdf') {
        // For non-PDF files, use single image processing
        const imageUrl = await convertFileToImage(file);
        return await extractJobsWithChatGPTVision(imageUrl);
      }

      try {
        // Load PDF.js if not already loaded
        await ensurePdfJs();
        
        // Convert PDF to array buffer
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        const pageCount = pdf.numPages;
        
        console.log(`Processing ${pageCount} pages into single image...`);
        
        // Create a single combined image from all pages
        const combinedImageUrl = await createCombinedImageFromPDF(pdf);
        
        // Debug: Uncomment to download combined image
        // downloadCombinedImage(combinedImageUrl);
        
        // Send the combined image to ChatGPT Vision (single API call for both jobs and education)
        const result = await extractJobsAndEducationWithChatGPTVision(combinedImageUrl);
        
        console.log(`Total jobs found: ${result.jobs.length}`);
        console.log(`Total education/certs found: ${result.education.length}`);
        
        // Clean up the combined image
        URL.revokeObjectURL(combinedImageUrl);
        
        return result;
      } catch (error) {
        console.error('Error processing PDF pages:', error);
        throw error;
      }
    }

    async function createCombinedImageFromPDF(pdf) {
      const pageCount = pdf.numPages;
      console.log(`Creating combined image from ${pageCount} pages`);
      
      const allPagesCanvas = document.createElement('canvas');
      const allPagesContext = allPagesCanvas.getContext('2d');
      
      let totalHeight = 0;
      let maxWidth = 0;
      const pageHeights = [];
      
      // First pass: calculate total dimensions and store page heights
      for (let pageNum = 1; pageNum <= pageCount; pageNum++) {
        const page = await pdf.getPage(pageNum);
        const viewport = page.getViewport({ scale: 2.0 });
        pageHeights[pageNum - 1] = viewport.height;
        totalHeight += viewport.height;
        maxWidth = Math.max(maxWidth, viewport.width);
        console.log(`Page ${pageNum}: ${viewport.width}x${viewport.height}`);
      }
      
      // Add gaps between pages
      totalHeight += (pageCount - 1) * 20;
      
      // Set canvas dimensions
      allPagesCanvas.width = maxWidth;
      allPagesCanvas.height = totalHeight;
      console.log(`Combined canvas: ${maxWidth}x${totalHeight}`);
      
      // Fill background with white
      allPagesContext.fillStyle = 'white';
      allPagesContext.fillRect(0, 0, allPagesCanvas.width, allPagesCanvas.height);
      
      // Second pass: render all pages with proper positioning
      let currentY = 0;
      for (let pageNum = 1; pageNum <= pageCount; pageNum++) {
        console.log(`Rendering page ${pageNum} at Y position: ${currentY}`);
        
        const page = await pdf.getPage(pageNum);
        const viewport = page.getViewport({ scale: 2.0 });
        
        // Save the current context state
        allPagesContext.save();
        
        // Translate to the correct position
        allPagesContext.translate(0, currentY);
        
        const renderContext = {
          canvasContext: allPagesContext,
          viewport: viewport
        };
        
        await page.render(renderContext).promise;
        
        // Restore the context state
        allPagesContext.restore();
        
        // Move to next page position
        currentY += viewport.height + 20; // Add 20px gap between pages
      }
      
      return allPagesCanvas.toDataURL('image/png');
    }

    function downloadCombinedImage(imageUrl) {
      // Create a download link for the combined image
      const link = document.createElement('a');
      link.href = imageUrl;
      link.download = 'combined-resume-pages.png';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      console.log('Combined image downloaded for debugging');
    }


    async function extractJobsWithChatGPTVision(imageUrl) {
      try {
        // Convert data URL to base64
        const base64Image = imageUrl.split(',')[1];
        
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${AI_CONFIG.apiKey}`
          },
          body: JSON.stringify({
            model: 'gpt-4o',
            messages: [
              {
                role: 'user',
                content: [
                  {
                    type: 'text',
                    text: `Analyze this resume image and extract all job titles, companies, employment dates, and locations. Return ONLY a JSON array in this exact format:
[
  {
    "title": "Job Title",
    "company": "Company Name",
    "startDate": "Start Date (e.g., June 2024)",
    "endDate": "End Date (e.g., Current or December 2024)",
    "location": "Location (e.g., San Francisco, CA)",
    "dates": "Start Date - End Date"
  }
]

Look for the Work Experience or Employment section and extract each job entry. If no job information is found, return an empty array [].`
                  },
                  {
                    type: 'image_url',
                    image_url: {
                      url: `data:image/png;base64,${base64Image}`
                    }
                  }
                ]
              }
            ],
            max_tokens: 1000,
            temperature: 0.1
          })
        });

        if (!response.ok) {
          throw new Error(`OpenAI API error: ${response.status}`);
        }

        const data = await response.json();
        const content = data.choices[0].message.content.trim();
        
        console.log('ChatGPT Vision response:', content);
        
        // Extract JSON from response
        const jsonMatch = content.match(/\[[\s\S]*\]/);
        if (jsonMatch) {
          return JSON.parse(jsonMatch[0]);
        }
        
        return [];
      } catch (error) {
        console.error('ChatGPT Vision extraction error:', error);
        return [];
      }
    }

    async function extractJobsAndEducationWithChatGPTVision(imageUrl) {
      try {
        // Convert data URL to base64
        const base64Image = imageUrl.split(',')[1];
        
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${AI_CONFIG.apiKey}`
          },
          body: JSON.stringify({
            model: 'gpt-4o',
            messages: [
              {
                role: 'user',
                content: [
                  {
                    type: 'text',
                    text: `Analyze this resume image and extract both job information and education/certifications. Return ONLY a JSON object in this exact format:

{
  "jobs": [
    {
      "title": "Job Title",
      "company": "Company Name",
      "startDate": "Start Date (e.g., June 2024)",
      "endDate": "End Date (e.g., Current or December 2024)",
      "location": "Location (e.g., San Francisco, CA)",
      "dates": "Start Date - End Date"
    }
  ],
  "education": [
    "Bachelor of Science in Computer Science from University of California",
    "AWS Certified Solutions Architect",
    "Google Analytics Certification"
  ]
}

For jobs: Look for Work Experience or Employment section and extract each job entry with title, company, start date, end date, and location.
For education: Extract degrees, certifications, and training as simple one-liners. For degrees, use format "[Degree Name] from [Institution]". For certifications, just list the certification name.

If any job information is missing (start date, end date, or location), use null for that field.
If no information is found in a category, return an empty array for that category.`
                  },
                  {
                    type: 'image_url',
                    image_url: {
                      url: `data:image/png;base64,${base64Image}`
                    }
                  }
                ]
              }
            ],
            max_tokens: 1500,
            temperature: 0.1
          })
        });

        if (!response.ok) {
          throw new Error(`OpenAI API error: ${response.status}`);
        }

        const data = await response.json();
        const content = data.choices[0].message.content.trim();
        
        console.log('ChatGPT Vision combined response:', content);
        
        // Extract JSON from response
        const jsonMatch = content.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
          const result = JSON.parse(jsonMatch[0]);
          return {
            jobs: result.jobs || [],
            education: result.education || []
          };
        }
        
        return { jobs: [], education: [] };
      } catch (error) {
        console.error('ChatGPT Vision combined extraction error:', error);
        return { jobs: [], education: [] };
      }
    }

    async function extractJobsWithChatGPT(text) {
      try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${AI_CONFIG.apiKey}`
          },
          body: JSON.stringify({
            model: AI_CONFIG.model,
            messages: [
              {
                role: 'system',
                content: `You are a resume parser. Extract job titles, companies, employment dates, and locations from the provided resume text. Return ONLY a JSON array in this exact format:
[
  {
    "title": "Job Title",
    "company": "Company Name",
    "startDate": "Start Date (e.g., June 2024)",
    "endDate": "End Date (e.g., Current or December 2024)",
    "location": "Location (e.g., San Francisco, CA)",
    "dates": "Start Date - End Date"
  }
]

If no job information is found, return an empty array [].`
              },
              {
                role: 'user',
                content: `Extract job information from this resume text:\n\n${text}`
              }
            ],
            max_tokens: 1000,
            temperature: 0.3
          })
        });

        if (!response.ok) {
          throw new Error(`OpenAI API error: ${response.status}`);
        }

        const data = await response.json();
        const content = data.choices[0].message.content.trim();
        
        // Extract JSON from response
        const jsonMatch = content.match(/\[[\s\S]*\]/);
        if (jsonMatch) {
          return JSON.parse(jsonMatch[0]);
        }
        
        return [];
      } catch (error) {
        console.error('ChatGPT job extraction error:', error);
        return [];
      }
    }

    // ChatGPT Integration Functions
    async function generateResumeWithAI(jobDescription, userJobData = [], userEducationData = []) {
      try {
        // Get user's personal info from the form
        const personalInfo = {
          name: document.getElementById('personalName').value || 'John Doe',
          address: document.getElementById('personalAddress').value || 'City, State',
          email: document.getElementById('personalEmail').value || 'email@example.com',
          phone: document.getElementById('personalPhone').value || '(555) 123-4567'
        };

        // Create enhanced system prompt that uses user's existing job data and education
        const enhancedSystemPrompt = `You are an AI Resume Generator that creates professional, ATS-optimized resumes based on job descriptions. Follow these comprehensive rules:

## CRITICAL PRESERVATION RULES (DO NOT CHANGE):
- Use EXACTLY the job titles, companies, and employment dates from user's history
- Use EXACTLY the contact information provided
- Include ALL education/certificates from user's data (not just relevant ones)
- NEVER fabricate experience, credentials, or dates
- **MANDATORY: Include EVERY SINGLE job from the user's job history - do not skip any jobs**
- **MANDATORY: The jobs array must contain ALL jobs provided in the user data, not just a subset**

## OPTIMIZATION RULES (REWRITE THESE):
- **CRITICAL: Write a professional summary that is EXACTLY 3 sentences long - no more, no less. This is mandatory.**
- The summary must mention ALL job titles from the user's work history
- Show career progression by referencing each role in the summary
- Rewrite job duties/responsibilities to highlight relevant technologies and outcomes
- **MANDATORY: Each job MUST have AT LEAST 4 bullet points (duties) - generate more if the user provided fewer**
- Optimize skills section using keywords from job description
- Use strong action verbs ("Led," "Developed," "Integrated," "Implemented")
- Make each bullet point results-oriented with quantifiable achievements
- Ensure 70-90% alignment with job description terminology
- Integrate keywords naturally, never keyword-stuff

## PROCESS TO FOLLOW:

### Step 1: Analyze Job Description
- Extract required technical skills (languages, frameworks, tools)
- Extract integration areas (system, data, cloud, microservices, ERP, etc.)
- Extract security/compliance needs (GDPR, IAM, CyberArk, etc.)
- Extract behavioral traits (collaboration, testing, debugging, problem-solving)
- Identify ATS keywords from the posting

### Step 2: Map Resume to Job Description
- For each past role, rewrite duties to highlight relevant technologies
- Emphasize integration, automation, and monitoring
- Frame achievements in terms of outcomes (efficiency, compliance, performance)

### Step 3: Rewrite Resume
- Use strong action verbs and results-oriented language
- Ensure maximum alignment with job description terminology
- Keep bullet points concise and ATS-friendly

### Step 4: Skills Section
- Create Technical Skills using job description keywords
- Add Soft Skills (collaboration, problem-solving, communication)
- Ensure skills cover all critical technologies from posting

## USER DATA:

Personal Information:
${JSON.stringify(personalInfo, null, 2)}

Existing Job History:
${userJobData.length > 0 ? JSON.stringify(userJobData, null, 2) : 'No existing job data provided - create a new resume'}

ALL Education/Certificates (include every single one):
${userEducationData.length > 0 ? JSON.stringify(userEducationData, null, 2) : 'No existing education data provided'}

## OUTPUT FORMAT:
Return ONLY a valid JSON object in this exact format:
{
  "contact": {
    "name": "${personalInfo.name}",
    "address": "${personalInfo.address}",
    "email": "${personalInfo.email}",
    "phone": "${personalInfo.phone}"
  },
  "jobs": [
    {
      "title": "EXACT job title from user's history",
      "company": "EXACT company from user's history", 
      "location": "City, State",
      "startDate": "EXACT start date from user's history",
      "endDate": "EXACT end date from user's history",
      "duties": ["Optimized duty 1", "Optimized duty 2", "Optimized duty 3", "Optimized duty 4"]
    }
    // IMPORTANT: Include ALL jobs from user's history, not just a subset
    // IMPORTANT: Each job MUST have AT LEAST 4 bullet points (duties)
  ],
  "summary": "EXACTLY 3 sentences describing the candidate's experience and career progression, mentioning ALL job titles from their work history. It is very important that you include no more than 3 sentences max. ",
  "skills": {
    "Technical Skills": ["Skill 1", "Skill 2", "Skill 3"],
    "Soft Skills": ["Skill 1", "Skill 2", "Skill 3"]
  },
  "certificates": [
    {"name": "EXACT education/certification 1 from user's data"},
    {"name": "EXACT education/certification 2 from user's data"},
    {"name": "EXACT education/certification 3 from user's data"}
  ]
}

## VALIDATION CHECKLIST:
- All job titles, companies, and dates match the original resume exactly
- ALL education/certificates from user's data are included
- **VERIFIED: ALL jobs from user's history are included in the jobs array**
- **CRITICAL: Professional summary is EXACTLY 3 sentences long - no more, no less**
- **CRITICAL: Each job MUST have AT LEAST 4 bullet points (duties) - no exceptions**
- No false information was added
- Job duties rewritten to strongly align with target job description
- Skills list covers critical technologies from posting
- Resume is ATS-optimized and professional

**CRITICAL: Generate resume using ALL job experiences from the user's existing job data. Do not skip or omit any jobs. Include ALL education/certificates. Make the resume compelling and perfectly tailored to the job description.

**MANDATORY: The professional summary must be EXACTLY 3 sentences long. Count the sentences carefully. This is non-negotiable.**

IMPORTANT: Return ONLY valid JSON. Do not include any text, explanations, or formatting outside the JSON object. No emojis, no "System" messages, no additional text. Just the JSON object.`;

        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${AI_CONFIG.apiKey}`
          },
          body: JSON.stringify({
            model: AI_CONFIG.model,
            messages: [
              {
                role: 'system',
                content: enhancedSystemPrompt
              },
              {
                role: 'user',
                content: `Generate a professional resume based on this job description:\n\n${jobDescription}`
              }
            ],
            max_tokens: AI_CONFIG.maxTokens,
            temperature: AI_CONFIG.temperature
          })
        });

        if (!response.ok) {
          throw new Error(`OpenAI API error: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        const generatedContent = data.choices[0].message.content.trim();
        
        // Extract JSON from the response (in case there's extra text)
        const jsonMatch = generatedContent.match(/\{[\s\S]*\}/);
        if (!jsonMatch) {
          console.error('AI Response:', generatedContent);
          throw new Error('No valid JSON found in AI response');
        }
        
        let resumeJson;
        try {
          resumeJson = JSON.parse(jsonMatch[0]);
        } catch (parseError) {
          console.error('JSON Parse Error:', parseError);
          console.error('Raw JSON:', jsonMatch[0]);
          throw new Error('Failed to parse AI response as JSON');
        }
        
        // Ensure required fields exist with defaults
        if (!resumeJson.contact) {
          resumeJson.contact = {
            name: personalInfo.name,
            address: personalInfo.address,
            email: personalInfo.email,
            phone: personalInfo.phone
          };
        }
        
        if (!resumeJson.jobs) resumeJson.jobs = [];
        if (!resumeJson.skills) resumeJson.skills = {};
        if (!resumeJson.education) resumeJson.education = [];
        if (!resumeJson.certificates) resumeJson.certificates = [];
        if (!resumeJson.summary) resumeJson.summary = "Experienced professional with strong technical skills and proven track record of success.";
        
        return resumeJson;
      } catch (error) {
        console.error('AI generation error:', error);
        throw error;
      }
    }

    function showAIProgress() {
      aiProgress.style.display = 'block';
      generateResumeFromJob.disabled = true;
      generateResumeFromJob.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    }

    function hideAIProgress() {
      aiProgress.style.display = 'none';
      generateResumeFromJob.disabled = false;
      generateResumeFromJob.innerHTML = '<i class="fas fa-magic"></i> Generate Resume';
    }

    function updateAIProgress(percentage, text) {
      aiProgressFill.style.width = `${percentage}%`;
      aiProgressText.textContent = text;
    }

    // Job Description Modal Event Listeners
    generateResumeBtn.addEventListener('click', () => {
      jobDescriptionModal.classList.add('active');
      jobDescriptionInput.focus();
    });

    closeJobDescriptionModal.addEventListener('click', closeJobDescriptionModalFunc);
    cancelJobDescription.addEventListener('click', closeJobDescriptionModalFunc);

    jobDescriptionModal.addEventListener('click', (e) => {
      if (e.target === jobDescriptionModal) {
        closeJobDescriptionModalFunc();
      }
    });

    function closeJobDescriptionModalFunc() {
      jobDescriptionModal.classList.remove('active');
      jobDescriptionInput.value = '';
      hideAIProgress();
    }

    generateResumeFromJob.addEventListener('click', async () => {
      const jobDescription = jobDescriptionInput.value.trim();
      if (!jobDescription) {
        showPreviewError('Please enter a job description');
        return;
      }

      try {
        showAIProgress();
        updateAIProgress(20, 'Analyzing job description...');
        
        // Generate resume with AI using user's existing job data
        const generatedResume = await generateResumeWithAI(jobDescription, extractedJobData, extractedEducationData);
        
        updateAIProgress(60, 'Processing generated resume...');
        
        // Update resume data
        resumeData = generatedResume;
        
        // Update personal info form fields
        if (personalName) personalName.value = generatedResume.contact.name;
        if (personalAddress) personalAddress.value = generatedResume.contact.address;
        if (personalEmail) personalEmail.value = generatedResume.contact.email;
        if (personalPhone) personalPhone.value = generatedResume.contact.phone;
        
        updateAIProgress(80, 'Rendering resume preview...');
        
        // Render the resume
        renderResume(resumeData);
        updatePreviewStatus('loaded', 'AI-generated resume loaded successfully');
        downloadJsonBtn.disabled = false;
        downloadJsonBtn.style.display = 'block';
        gradeResumeBtn.disabled = false;
        gradeResumeBtn.style.display = 'block';
        
        updateAIProgress(100, 'Generating PDF...');
        generatePDFandStore();
        
        // Close modal after a brief delay
        setTimeout(() => {
          closeJobDescriptionModalFunc();
          updateAIProgress(0, '');
        }, 1000);
        
      } catch (error) {
        console.error('Resume generation failed:', error);
        hideAIProgress();
        showPreviewError(`Failed to generate resume: ${error.message}`);
      }
    });

    // Resume Grading Function
    async function gradeResume(jobDescription) {
      try {
        if (!AI_CONFIG || !AI_CONFIG.apiKey) {
          throw new Error('AI configuration not available. Please ensure the server is running.');
        }

        // Show loading state
        gradeResultsModal.classList.add('active');
        scoreNumber.textContent = '...';
        scoreDescription.textContent = 'Analyzing your resume...';
        gradeFeedback.innerHTML = '<div class="loading">Please wait while we analyze your resume...</div>';

        // Prepare resume data for analysis
        const resumeText = formatResumeForGrading(resumeData);
        
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${AI_CONFIG.apiKey}`
          },
          body: JSON.stringify({
            model: AI_CONFIG.model || 'gpt-4',
            messages: [
              {
                role: 'system',
                content: `You are an expert resume reviewer and career coach. Analyze the provided resume against the given job description and provide a comprehensive grade from 0-100.

GRADING CRITERIA (weighted):
- **Relevance & Match (30%)**: How well the resume matches the job requirements
- **Experience Quality (25%)**: Depth and relevance of work experience
- **Skills Alignment (20%)**: Technical and soft skills match
- **Education & Certifications (10%)**: Educational background relevance
- **Format & Presentation (10%)**: Professional formatting and structure
- **Keywords & ATS Optimization (5%)**: Use of relevant industry keywords

Provide your response in this EXACT JSON format:
{
  "score": 85,
  "description": "Strong match with room for improvement",
  "strengths": [
    "Excellent technical skills alignment",
    "Relevant work experience in similar role",
    "Strong educational background"
  ],
  "improvements": [
    "Add more quantifiable achievements",
    "Include specific project examples",
    "Optimize for ATS with more keywords"
  ],
  "detailed_feedback": "Your resume shows strong technical skills and relevant experience. The work history demonstrates progression and the skills section aligns well with the job requirements. However, adding more specific metrics and achievements would strengthen your candidacy. Consider including project examples that showcase your problem-solving abilities."
}`
              },
              {
                role: 'user',
                content: `JOB DESCRIPTION:\n\n${jobDescription}\n\n\nRESUME TO ANALYZE:\n\n${resumeText}`
              }
            ],
            max_tokens: 1500,
            temperature: 0.3
          })
        });

        if (!response.ok) {
          throw new Error(`OpenAI API error: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        const content = data.choices[0].message.content;
        
        console.log('Resume grading response:', content);
        
        // Parse the JSON response
        let gradeData;
        try {
          // Extract JSON from the response
          const jsonMatch = content.match(/\{[\s\S]*\}/);
          if (jsonMatch) {
            gradeData = JSON.parse(jsonMatch[0]);
          } else {
            throw new Error('No valid JSON found in response');
          }
        } catch (parseError) {
          console.error('JSON parsing error:', parseError);
          throw new Error('Failed to parse grading response');
        }

        // Display the results
        displayGradeResults(gradeData);

      } catch (error) {
        console.error('Resume grading error:', error);
        scoreNumber.textContent = 'Error';
        scoreDescription.textContent = 'Failed to grade resume';
        gradeFeedback.innerHTML = `<div class="error">Error: ${error.message}</div>`;
      }
    }

    function formatResumeForGrading(data) {
      let resumeText = '';
      
      // Contact Information
      if (data.contact) {
        resumeText += `CONTACT INFORMATION:\n`;
        resumeText += `Name: ${data.contact.name || 'Not provided'}\n`;
        resumeText += `Email: ${data.contact.email || 'Not provided'}\n`;
        resumeText += `Phone: ${data.contact.phone || 'Not provided'}\n`;
        resumeText += `Address: ${data.contact.address || 'Not provided'}\n\n`;
      }

      // Professional Summary
      if (data.summary && showSummaryCheckbox.checked) {
        resumeText += `PROFESSIONAL SUMMARY:\n${data.summary}\n\n`;
      }

      // Work Experience
      if (data.jobs && data.jobs.length > 0) {
        resumeText += `WORK EXPERIENCE:\n`;
        data.jobs.forEach((job, index) => {
          resumeText += `${index + 1}. ${job.title || 'Title not specified'}\n`;
          resumeText += `   Company: ${job.company || 'Company not specified'}\n`;
          resumeText += `   Location: ${job.location || 'Location not specified'}\n`;
          resumeText += `   Duration: ${job.startDate || 'Start date not specified'} - ${job.endDate || 'Present'}\n`;
          if (job.responsibilities && job.responsibilities.length > 0) {
            resumeText += `   Responsibilities:\n`;
            job.responsibilities.forEach(resp => {
              resumeText += `   - ${resp}\n`;
            });
          }
          resumeText += `\n`;
        });
      }

      // Skills
      if (data.skills) {
        resumeText += `SKILLS:\n`;
        Object.entries(data.skills).forEach(([category, skills]) => {
          resumeText += `${category}: ${skills.join(', ')}\n`;
        });
        resumeText += `\n`;
      }

      // Education & Certifications
      if (data.certificates && data.certificates.length > 0) {
        resumeText += `EDUCATION & CERTIFICATIONS:\n`;
        data.certificates.forEach(cert => {
          resumeText += `- ${typeof cert === 'string' ? cert : cert.name || cert}\n`;
        });
        resumeText += `\n`;
      }

      return resumeText;
    }

    function displayGradeResults(gradeData) {
      // Update score display
      scoreNumber.textContent = gradeData.score || 0;
      scoreDescription.textContent = gradeData.description || 'Analysis complete';

      // Update score circle color based on score
      const scoreCircle = document.querySelector('.score-circle');
      if (gradeData.score >= 80) {
        scoreCircle.style.background = 'linear-gradient(135deg, #10b981, #059669)'; // Green
      } else if (gradeData.score >= 60) {
        scoreCircle.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)'; // Orange
      } else {
        scoreCircle.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)'; // Red
      }

      // Create feedback HTML
      let feedbackHTML = '';
      
      if (gradeData.detailed_feedback) {
        feedbackHTML += `<h4>Overall Assessment</h4><p>${gradeData.detailed_feedback}</p>`;
      }

      if (gradeData.strengths && gradeData.strengths.length > 0) {
        feedbackHTML += `<h4 class="strengths">Strengths</h4><ul>`;
        gradeData.strengths.forEach(strength => {
          feedbackHTML += `<li>${strength}</li>`;
        });
        feedbackHTML += `</ul>`;
      }

      if (gradeData.improvements && gradeData.improvements.length > 0) {
        feedbackHTML += `<h4 class="improvements">Areas for Improvement</h4><ul>`;
        gradeData.improvements.forEach(improvement => {
          feedbackHTML += `<li>${improvement}</li>`;
        });
        feedbackHTML += `</ul>`;
      }

      gradeFeedback.innerHTML = feedbackHTML;
    }

    // Initialize authentication when page loads
    document.addEventListener('DOMContentLoaded', () => {
      // Wait for Firebase to be available
      const checkFirebase = () => {
        if (window.auth && window.onAuthStateChanged) {
          initializeAuth();
        } else {
          setTimeout(checkFirebase, 100);
        }
      };
      checkFirebase();
      
      // Initialize personal info listeners
      addPersonalInfoListeners();
      
      // Initialize job portfolio
      initializeJobPortfolio();
    });

    // Settings functionality
    function initializeSettings() {
      const settings = [
        { id: 'nameSize', cssVar: '--name-size', suffix: 'px' },
        { id: 'contactSize', cssVar: '--contact-size', suffix: 'px' },
        { id: 'nameTopPadding', cssVar: '--name-top-padding', suffix: 'px' },
        { id: 'jobTitleSize', cssVar: '--job-title-size', suffix: 'px' },
        { id: 'companySize', cssVar: '--company-size', suffix: 'px' },
        { id: 'companyDetailsSize', cssVar: '--company-details-size', suffix: 'px' },
        { id: 'bulletSize', cssVar: '--bullet-size', suffix: 'px' },
        { id: 'jobPaddingTop', cssVar: '--job-padding-top', suffix: 'px' },
        { id: 'jobPaddingBottom', cssVar: '--job-padding-bottom', suffix: 'px' }
      ];

      settings.forEach(setting => {
        const slider = document.getElementById(setting.id);
        const valueDisplay = document.getElementById(setting.id + 'Value');
        
        if (slider && valueDisplay) {
          // Update display value
          valueDisplay.textContent = slider.value + setting.suffix;
          
          // Handle slider change
          slider.addEventListener('input', function() {
            const value = this.value + setting.suffix;
            valueDisplay.textContent = value;
            document.documentElement.style.setProperty(setting.cssVar, value);
            
            // Re-render resume if data is loaded
            if (resumeData) {
              renderResume(resumeData);
              generatePDFandStore();
            }
          });
        }
      });
    }

    // Initialize settings when page loads
    document.addEventListener('DOMContentLoaded', () => {
      initializeSettings();
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && jsonModal.classList.contains('active')) {
        closeJsonModal();
      } else if (e.key === 'Escape' && gradeModal.classList.contains('active')) {
        closeGradeModalFunc();
      } else if (e.key === 'Escape' && gradeResultsModal.classList.contains('active')) {
        closeGradeResultsModalFunc();
      } else if (e.key === 'Escape' && jobEditModal.classList.contains('active')) {
        closeJobEditModalFunc();
      }
    });
  </script>
</body>
</html>
